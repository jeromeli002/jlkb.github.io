<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" sizes="310x310" href="./logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIAL工具</title>
    <style>
        /* Base Styles & Typography */
        body { 
            font-family: "Microsoft YaHei", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
            padding: 10px; /* Further reduced padding */
            background: #e0f7fa; /* Light cyan background for a soothing feel */
            color: #333; 
            line-height: 1.5; /* Slightly tighter line height */
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
            font-size: 14px; /* Default font size */
        }
        .main-wrapper {
            display: flex;
            gap: 15px; /* Reduced gap between columns */
            max-width: 1440px;
            width: 100%;
            margin-top: 10px; /* Reduced margin */
            margin-bottom: 10px; /* Reduced margin */
        }
        .left-column {
            flex: 2; /* Takes 2/3 of available space */
            background-color: #ffffff;
            padding: 20px; /* Reduced padding */
            border-radius: 10px; /* Slightly smaller border-radius */
            box-shadow: 0 6px 20px rgba(0, 188, 212, 0.1); /* Reduced shadow */
        }
        .right-column {
            flex: 1; /* Takes 1/3 of available space */
            background-color: #ffffff;
            padding: 20px; /* Reduced padding */
            border-radius: 10px; /* Slightly smaller border-radius */
            box-shadow: 0 6px 20px rgba(0, 188, 212, 0.1); /* Reduced shadow */
            position: sticky; 
            top: 10px; /* Reduced distance from the top */
            align-self: flex-start; 
            /* max-height: calc(100vh - 20px); */ /* Removed max-height constraint */
            /* overflow-y: auto; */ /* Removed overflow-y constraint */
        }
        h2 { 
            text-align: center; 
            color: #00bcd4; 
            margin-bottom: 20px; /* Reduced margin */
            font-size: 2.2em; /* Slightly smaller title */
            font-weight: 800; 
            letter-spacing: 0.5px; /* Reduced letter-spacing */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        .section { 
            margin-bottom: 18px; /* Reduced margin */
            padding: 15px; /* Reduced padding */
            background-color: #ffffff; 
            border-radius: 8px; /* Slightly smaller border-radius */
            border: 1px solid #b2ebf2; 
            box-shadow: inset 0 1px 4px rgba(0, 188, 212, 0.04); /* Reduced shadow */
        }
        label { 
            display: block; 
            margin-bottom: 8px; /* Reduced margin */
            font-weight: 600; 
            color: #00838f; 
            font-size: 1em; /* Adjusted font size */
        }

        /* Input Fields & Textareas */
        textarea, input[type="text"], input[type="number"], select { 
            width: calc(100% - 16px); /* Adjusted width for padding */
            font-family: 'Roboto Mono', monospace; 
            font-size: 13px; /* Slightly smaller font size */
            padding: 8px; /* Reduced padding */
            border: 1px solid #b2ebf2; 
            border-radius: 6px; /* Slightly smaller border-radius */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.02); /* Reduced shadow */
            transition: border-color 0.3s ease, box-shadow 0.3s ease; 
            resize: vertical; 
            line-height: 1.4; /* Tighter line height */
            box-sizing: border-box; 
            background-color: #fff;
        }
        textarea { 
            height: 150px; /* Reduced default height */
            min-height: 100px; /* Reduced min height */
        }
        input[type="number"]:focus, select:focus, textarea:focus, input[type="text"]:focus { 
            border-color: #4dd0e1; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(77, 208, 225, 0.2); /* Reduced glow */
        }
        textarea.error, input.error { 
            border-color: #ef9a9a; 
            box-shadow: 0 0 0 3px rgba(239, 154, 154, 0.3); 
            animation: pulseRed 0.6s 3 ease-in-out; 
        }
        @keyframes pulseRed { 
            0% { border-color: #ef9a9a; } 
            50% { border-color: #ffcccb; } 
            100% { border-color: #ef9a9a; } 
        }
        .error-message { 
            color: #d65a5a; 
            font-size: 0.85em; /* Slightly smaller error message */
            margin-top: 5px; 
            min-height: 1.1em; 
            font-weight: 500; 
        }

        /* Inline Input Groups */
        .inline-input-group { 
            display: flex; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; /* Reduced gap */
            margin-bottom: 12px; /* Reduced margin */
        }
        .inline-input-group label { 
            margin-bottom: 0; 
            flex-shrink: 0; 
            font-size: 0.95em; /* Adjusted font size */
            color: #555; 
        }
        .inline-input-group input, .inline-input-group select { 
            flex-grow: 1; 
            width: auto; 
            min-width: 70px; /* Slightly smaller min-width */
            margin-bottom: 0; 
            height: 36px; /* Reduced height */
            padding: 6px 8px; /* Reduced padding */
        }
        .inline-input-group input.short-input { min-width: 60px; max-width: 100px; flex-grow: 0.6; }
        .inline-input-group input.matrix-input { min-width: 40px; max-width: 60px; flex-grow: 0.4; }
        .inline-input-group select#lightingSelect { min-width: 90px; max-width: 140px; flex-grow: 0.8; } 

        /* Buttons */
        .button-group { 
            text-align: center; 
            margin-top: 20px; /* Reduced margin */
        }
        button { 
            padding: 10px 20px; /* Reduced padding */
            margin: 0 6px; /* Reduced margin */
            border: none; 
            border-radius: 6px; /* Slightly smaller border-radius */
            cursor: pointer; 
            font-size: 14px; /* Reduced font size */
            font-weight: 600; 
            transition: all 0.3s ease; 
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); /* Reduced shadow */
            color: #333; /* Default to dark text for all buttons */
        }
        button:hover { 
            transform: translateY(-1px); /* Smaller hover effect */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12); 
            opacity: 0.95;
        }
        /* Specific button colors */
        button#resetBtn { background-color: #4dd0e1; }
        button#resetBtn:hover { background-color: #00bcd4; }
        button#copyCodeBtn { background-color: #c8e6c9; }
        button#copyCodeBtn:hover { background-color: #a5d6a7; }
        button#downloadBtn { background-color: #ffe0b2; }
        button#downloadBtn:hover { background-color: #ffcc80; }
        
        /* Adjusted for centered +/- text */
        button.add-btn, button.remove-btn { 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; /* Remove padding for precise centering */
            box-shadow: none; /* Remove individual shadow if preferred */
        }
        button.add-btn { background-color: #80deea; }
        button.add-btn:hover { background-color: #4dd0e1; }
        button.remove-btn { background-color: #ffccbc; }
        button.remove-btn:hover { background-color: #ffab91; }

        /* Keyboard Visualization */
        #keyboard { 
            margin-top: 25px; /* Reduced margin */
            position: relative; 
            background: #ffffff; 
            border: 1px solid #b2ebf2; 
            border-radius: 8px; /* Slightly smaller border-radius */
            box-shadow: 0 5px 12px rgba(0, 188, 212, 0.07); 
            overflow: hidden; 
            padding: 8px; /* Reduced padding */
        }
        .key { 
            position: absolute; 
            background: #90a4ae; 
            color: #fff; 
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 12px; /* Smaller font size for keys */
            font-weight: 600; 
            border-radius: 4px; /* Smaller border-radius */
            user-select: none; 
            cursor: grab; 
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1); /* Reduced shadow */
        }
        .key:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); 
            background: #78909c; 
        }
        .key.dragging { 
            opacity: 0.7; 
            cursor: grabbing; 
            transform: scale(1.03); /* Smaller scale effect */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); 
        }
        .key.dragover { 
            box-shadow: 0 0 0 4px rgba(77, 208, 225, 0.5); /* Reduced glow */
            border: 1px dashed #00bcd4; /* Thinner border */
        }

        /* Result Textarea */
        textarea#rgbResult { 
            margin-top: 20px; /* Reduced margin */
            min-height: 200px; /* Reduced min-height */
            /*max-height: 400px; /* Reduced max-height */
            padding: 12px; /* Reduced padding */
            font-size: 13px; /* Consistent font size */
            background-color: #f0fbfc; 
            border: 1px solid #b2ebf2; 
            border-radius: 6px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);
            width: calc(100% - 24px); /* Adjusted width */
        }
        
        /* Custom Keycodes & Labels Sections */
        #customKeycodesSection, #labelsSection, .vial-config-option { margin-bottom: 18px; } /* Reduced margin */
        #customKeycodesContainer, #labelsContainer { 
            border: 1px solid #b2ebf2; 
            border-radius: 6px; 
            padding: 12px; /* Reduced padding */
            margin-bottom: 15px; /* Reduced margin */
            background-color: #f5fdff; 
        }
        .custom-keycode-group, .label-group { 
            display: flex; 
            align-items: center; 
            gap: 8px; /* Reduced gap */
            margin-bottom: 8px; /* Reduced margin */
            padding: 8px; /* Reduced padding */
            border-radius: 5px; /* Smaller border-radius */
            background-color: #ffffff; 
            border: 1px solid #e0f7fa; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.03); /* Reduced shadow */
        }
        .custom-keycode-group input, .label-group input { 
            flex-grow: 1; 
            height: 32px; /* Reduced height */
            padding: 6px; /* Reduced padding */
            font-size: 12px; /* Smaller font size */
            border: 1px solid #b2ebf2; 
            border-radius: 4px; /* Smaller border-radius */
        }
        .action-buttons, .label-action-buttons { 
            display: flex; 
            gap: 4px; /* Reduced gap */
        }
        .action-buttons button, .label-action-buttons button { 
            width: 28px; /* Reduced size */
            height: 28px; /* Reduced size */
            font-size: 16px; /* Reduced font size */
            border-radius: 5px; /* Smaller border-radius */
        }
        
        .config-toggle-label { /* Unified style for new and existing toggles */
            display: flex; 
            align-items: center; 
            font-weight: 600; 
            color: #00838f; 
            font-size: 1em; 
            margin-bottom: 12px; /* Reduced margin */
        }
        .config-toggle-label input[type="checkbox"] { 
            margin-right: 8px; /* Reduced margin */
            width: 16px; /* Reduced size */
            height: 16px; /* Reduced size */
        }
        .config-toggle-label select {
            margin-left: 8px; /* Space between label and select */
            width: auto; /* Allow select to size naturally */
            flex-grow: 0; /* Prevent select from taking all available space */
        }


        /* Labels Section Specific Styles */
        .label-group.array-type { flex-wrap: nowrap; align-items: flex-start; } 
        .array-type .main-label-input { flex-shrink: 0; width: auto; min-width: 80px; max-width: 120px; } /* Adjusted width */
        .sub-label-inputs { display: flex; flex-wrap: wrap; gap: 6px; flex-grow: 1; } /* Reduced gap */
        .sub-label-item { display: flex; align-items: center; gap: 3px; } /* Reduced gap */
        .sub-label-item input { max-width: 100px; } /* Reduced max-width */
        
        /* Adjusted for centered +/- text */
        .add-sub-label-btn { 
            font-size: 16px !important; 
            width: 26px !important; 
            height: 26px !important; 
            display: flex; /* Apply flex for centering */
            justify-content: center;
            align-items: center;
            padding: 0; /* Remove padding */
        } 
        /* Adjusted for centered +/- text */
        .remove-sub-label-btn { 
            font-size: 14px !important; 
            width: 24px !important; 
            height: 24px !important; 
            border-radius: 3px !important; 
            display: flex; /* Apply flex for centering */
            justify-content: center;
            align-items: center;
            padding: 0; /* Remove padding */
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 992px) { 
            .main-wrapper {
                flex-direction: column;
                gap: 0; 
            }
            .left-column, .right-column {
                flex: none; 
                width: 100%;
                margin-top: 0;
                margin-bottom: 15px; /* Reduced space between sections */
                position: static; 
                max-height: unset; 
                overflow-y: visible; 
                padding: 15px; /* Adjusted padding */
            }
        }
        @media (max-width: 768px) {
            body { padding: 8px; } /* Further reduced padding */
            h2 { font-size: 1.8em; margin-bottom: 18px; } /* Further reduced title size */
            button { padding: 8px 15px; font-size: 13px; } /* Further reduced button size */
            textarea, input { padding: 6px; font-size: 12px; } /* Further reduced input size */
            .inline-input-group { gap: 6px; } /* Further reduced gap */
            .inline-input-group input, .inline-input-group select { width: calc(100% - 16px); } /* Adjusted width */

            .custom-keycode-group input, .label-group input { width: calc(50% - 8px); } /* Adjusted width for smaller screens */
            .action-buttons, .label-action-buttons { justify-content: flex-start; } /* Align to start for better small screen flow */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

<div class="main-wrapper">
    <div class="left-column">
        <h2>VIAL工具</h2>

        <div class="section input-section">
            <label for="rawData">KLE原始数据（拖拽可视化按键或直接修改输入框都会实时更新下方输出）：</label>
            <textarea id="rawData" spellcheck="false">["0,8","1,8","0,9","1,9"],
["5,8","3,8","2,9",{h:2},"6,10"],
["3,9","4,9","5,9"],
["6,7","6,8","6,9",{h:2},"7,10"],
[{w:2},"7,8","7,9"]
</textarea>
            <div id="errorDisplay" class="error-message"></div>
        </div>

        <div class="section config-section">
            <label>键盘基本信息:</label>
            <div class="inline-input-group">
                <label for="keyboardNameInput">名称 (name):</label>
                <input type="text" id="keyboardNameInput" value="XMK" class="short-input">
                <label for="vendorIdInput">供应商ID (vendorId):</label>
                <input type="text" id="vendorIdInput" value="F001" maxlength="4" placeholder="4位十六进制(0-F)" class="short-input">
                <label for="productIdInput">产品ID (productId):</label>
                <input type="text" id="productIdInput" value="6001" maxlength="4" placeholder="4位十六进制(0-F)" class="short-input">
            </div>
            
            <div id="vialConfigSection" class="section">
                <div class="vial-config-option">
                    <label class="config-toggle-label">
                        <input type="checkbox" id="enableMidi">
                        启用 MIDI (vial.midi):
                        <select id="midiSelect" style="display:none;">
                            <option value="basic">basic</option>
                            <option value="advanced">advanced</option>
                        </select>
                    </label>
                </div>
                <div class="vial-config-option">
                    <label class="config-toggle-label">
                        <input type="checkbox" id="enableVibl">
                        启用 VIBL (vial.vibl):
                    </label>
                </div>
            </div>

            <div id="customKeycodesSection" class="section">
                <label class="config-toggle-label">
                    <input type="checkbox" id="enableCustomKeycodes">
                    启用自定义键码 (Custom Keycodes):
                </label>
                <div id="customKeycodesContainer">
                    </div>
            </div>

            <div id="labelsSection" class="section">
                <label class="config-toggle-label">
                    <input type="checkbox" id="enableLabels">
                    启用自定义标签 (Labels):
                </label>
                <div id="labelsContainer">
                    </div>
                <div class="button-group" style="text-align: right; margin-top: 8px; margin-bottom: 0;">
                    <button id="addLabelBtn" class="add-btn" style="background-color: #80deea; padding: 6px 12px; font-size: 13px;">+ 添加标签</button>
                </div>
            </div>
            
            <div class="inline-input-group">
                <label for="rowsInput">矩阵行列数 (Rows):</label>
                <input type="number" id="rowsInput" value="6" min="1" class="matrix-input">
                <label for="colsInput">(Cols):</label>
                <input type="number" id="colsInput" value="5" min="1" class="matrix-input">
                <label for="lightingSelect">灯光类型 (Lighting):</label>
                <select id="lightingSelect">
                    <option value="none">无</option>
                    <option value="vialrgb" selected>VIAL RGB</option>
                    <option value="qmk_backlight">QMK 背光</option>
                    <option value="qmk_backlight_rgblight">QMK 背光+RGB灯</option>
                    <option value="qmk_rgblight">QMK RGB灯</option>
                </select>
            </div>
        </div>

        <div id="keyboard" class="section"></div> 
    </div>

    <div class="right-column">
        <div class="button-group" style="margin-top: 0; margin-bottom: 15px;">
            <button id="resetBtn">重置</button>
            <button id="copyCodeBtn">复制</button>
            <button id="downloadBtn">下载</button>
        </div>
        <label for="rgbResult">生成的vial.json代码:</label>
        <textarea id="rgbResult" spellcheck="false" readonly></textarea>
    </div>
</div>

<script>
(() => {
    // Constants
    const UNIT = 40, GAP = 5;
    const DEFAULT_KEYBOARD_NAME = "XMK";
    const DEFAULT_VENDOR_ID = "F001";
    const DEFAULT_PRODUCT_ID = "6001";
    const DEFAULT_ROWS = "6";
    const DEFAULT_COLS = "5";
    const DEFAULT_LIGHTING = "vialrgb";
    const INITIAL_RAW_KLE_DATA = `["0,8","1,8","0,9","1,9"],
["5,8","3,8","2,9",{h:2},"6,10"],
["3,9","4,9","5,9"],
["6,7","6,8","6,9",{h:2},"7,10"],
[{w:2},"7,8","7,9"]
`;
    const INITIAL_CUSTOM_KEYCODES = [
        {"name": "下\\n一层", "title": "增加一层0→1", "shortName": "向下\\n一层"},
        {"name": "上\\n一层", "title": "减少一层1→0", "shortName": "向上\\n一层"},
        {"name": "一键购物", "title": "淘宝购物", "shortName": "一键\\n购物"},
        {"name": "按6\\n放7", "title": "按下6层抬起7层", "shortName": "按6\\n放7"}
    ];
    const INITIAL_LABELS = [
        ["左上旋钮"],
        ["右上旋钮"],
        ["旋钮选择", "无旋钮", "多旋钮"]
    ];

    // DOM Elements
    const elements = {
        keyboard: document.getElementById("keyboard"),
        rawDataInput: document.getElementById("rawData"),
        rgbResult: document.getElementById("rgbResult"),
        resetBtn: document.getElementById("resetBtn"),
        copyCodeBtn: document.getElementById("copyCodeBtn"),
        downloadBtn: document.getElementById("downloadBtn"),
        errorDisplay: document.getElementById("errorDisplay"),
        keyboardNameInput: document.getElementById("keyboardNameInput"),
        vendorIdInput: document.getElementById("vendorIdInput"),
        productIdInput: document.getElementById("productIdInput"),
        rowsInput: document.getElementById("rowsInput"),
        colsInput: document.getElementById("colsInput"),
        lightingSelect: document.getElementById("lightingSelect"),
        enableViblCheckbox: document.getElementById("enableVibl"), 
        enableMidiCheckbox: document.getElementById("enableMidi"), // New
        midiSelect: document.getElementById("midiSelect"), // New
        customKeycodesContainer: document.getElementById("customKeycodesContainer"),
        enableCustomKeycodesCheckbox: document.getElementById("enableCustomKeycodes"),
        labelsContainer: document.getElementById("labelsContainer"),
        enableLabelsCheckbox: document.getElementById("enableLabels"),
        addLabelBtn: document.getElementById("addLabelBtn")
    };

    let keysData = []; // Data for visual keys, includes kleRowIndex and kleItemIndex
    let currentParsedKLE = []; // The actual KLE data array

    // Deep copy initial data to ensure resets work correctly
    let customKeycodesData = JSON.parse(JSON.stringify(INITIAL_CUSTOM_KEYCODES));
    let labelsData = JSON.parse(JSON.stringify(INITIAL_LABELS));

    const copyButtonOriginalText = elements.copyCodeBtn.textContent;

    // Helper Functions
    const clearError = (element = elements.rawDataInput, errorDiv = elements.errorDisplay) => {
        element.classList.remove('error');
        errorDiv.textContent = '';
    };

    const showParsingError = (message, element = elements.rawDataInput, errorDiv = elements.errorDisplay) => {
        element.classList.add('error');
        errorDiv.textContent = '解析错误: ' + message;
        element.style.animation = 'none';
        void element.offsetHeight; // Trigger reflow
        element.style.animation = '';
    };

    // Parses KLE string input into a structured array
    const parseInput = (text) => {
        const trimmed = text.trim();
        try {
            if (trimmed.startsWith('[[') && trimmed.endsWith(']]')) {
                const parsed = JSON.parse(trimmed);
                // Basic validation for the parsed structure
                if (!Array.isArray(parsed) || parsed.some(row => !Array.isArray(row))) {
                    throw new Error("KLE数据格式不正确，应为二维数组。");
                }
                return parsed;
            }
            // Handle comma-separated lines for easier input
            const cleanedLines = trimmed.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            const joinedLines = cleanedLines.map((line, i, arr) =>
                (i < arr.length - 1 && !line.endsWith(',') && line !== '[') ? line + ',' : line
            ).join('\n');
            // Use Function constructor to safely evaluate the string as a JS array literal
            return Function(`"use strict";return (${'[' + joinedLines + ']'})`)();
        } catch (e) {
            console.error("Parse input error:", e);
            throw new Error("KLE数据格式不正确。请检查括号、逗号和引号。", { cause: e });
        }
    };

    // Computes key positions and sizes for visualization
    const computeKeysForVisualization = (data) => {
        const result = [];
        let currentY = 0, accumulatedYOffset = 0;

        data.forEach((row, rowIndex) => {
            let xPos = 0, nextW = 1, nextH = 1, nextXOffset = 0;
            let rowYOffset = 0;

            // Check for row-level y offset (from KLE)
            const hasYOffsetInRow = row.find(item => typeof item === "object" && "y" in item);
            if (hasYOffsetInRow) rowYOffset = hasYOffsetInRow.y;

            const rowY = currentY + accumulatedYOffset + rowYOffset;

            row.forEach((item, itemIndex) => {
                if (typeof item === "object") {
                    // Update key properties for the next key in the row
                    if ("w" in item) nextW = item.w;
                    if ("h" in item) nextH = item.h;
                    if ("x" in item) nextXOffset = item.x;
                    if ("y" in item) rowYOffset = item.y; // This y is for individual key offset, accumulated below
                    return; // Skip this object, it's a property descriptor
                }
                
                // For string items (key labels)
                const label = item; 

                const key = {
                    x: xPos + nextXOffset, 
                    y: rowY, 
                    w: nextW, 
                    h: nextH,
                    label: label,
                    kleRowIndex: rowIndex, // Store original row index
                    kleItemIndex: itemIndex // Store original item index within the row
                };
                result.push(key);

                // Update x position for the next key
                xPos = key.x + key.w;
                // Reset properties for the next key
                nextW = 1; 
                nextH = 1; 
                nextXOffset = 0;
            });
            accumulatedYOffset += rowYOffset; // Accumulate y offset for subsequent rows
            currentY += 1; // Move to the next "logical" row
        });
        return result;
    };

    // Renders visual keys on the keyboard display
    const renderKeys = (keys) => {
        elements.keyboard.innerHTML = "";
        keys.forEach((key, idx) => {
            const keyWidth = key.w * UNIT + (key.w - 1) * GAP;
            const keyHeight = key.h * UNIT + (key.h - 1) * GAP;
            const div = document.createElement("div");
            Object.assign(div.style, {
                left: `${key.x * (UNIT + GAP)}px`, 
                top: `${key.y * (UNIT + GAP)}px`,
                width: `${keyWidth}px`, 
                height: `${keyHeight}px`
            });
            div.className = "key";
            div.textContent = key.label;
            div.draggable = true;
            div.dataset.visualIndex = idx; // Used for drag-drop of visual keys

            div.addEventListener('dragstart', e => { 
                e.dataTransfer.setData("text/plain", idx); 
                div.classList.add("dragging"); 
            });
            div.addEventListener('dragend', () => div.classList.remove("dragging"));
            div.addEventListener('dragover', e => { 
                e.preventDefault(); 
                div.classList.add("dragover"); 
            });
            div.addEventListener('dragleave', () => div.classList.remove("dragover"));
            div.addEventListener('drop', e => {
                e.preventDefault();
                div.classList.remove("dragover");
                const fromVisualIdx = parseInt(e.dataTransfer.getData("text/plain"));
                const toVisualIdx = idx;

                if (fromVisualIdx !== toVisualIdx) {
                    const fromKey = keysData[fromVisualIdx];
                    const toKey = keysData[toVisualIdx];

                    // Safely swap the actual KLE data in currentParsedKLE
                    const tempKLEItem = JSON.parse(JSON.stringify(currentParsedKLE[fromKey.kleRowIndex][fromKey.kleItemIndex]));
                    currentParsedKLE[fromKey.kleRowIndex][fromKey.kleItemIndex] = JSON.parse(JSON.stringify(currentParsedKLE[toKey.kleRowIndex][toKey.kleItemIndex]));
                    currentParsedKLE[toKey.kleRowIndex][toKey.kleItemIndex] = tempKLEItem;

                    // Update raw KLE input field to reflect the swap
                    elements.rawDataInput.value = currentParsedKLE.map(row => JSON.stringify(row)).join(',\n');

                    // Re-render visual keys based on updated currentParsedKLE
                    keysData = computeKeysForVisualization(currentParsedKLE); 
                    renderKeys(keysData);
                    updateFormattedKLEOutput(); // Update JSON output
                }
            });
            elements.keyboard.appendChild(div);
        });
        const maxY = Math.max(...keys.map(k => k.y + (k.h || 1)), 0);
        elements.keyboard.style.height = `${(UNIT + GAP) * maxY + GAP}px`;
    };

    // Handles initial parsing of raw KLE data and updates visuals/output
    const processInput = () => {
        try {
            const parsed = parseInput(elements.rawDataInput.value);
            currentParsedKLE = JSON.parse(JSON.stringify(parsed)); // Deep copy to ensure independence
            keysData = computeKeysForVisualization(currentParsedKLE);
            renderKeys(keysData);
            updateFormattedKLEOutput(); // Ensure JSON output is updated immediately after raw data input
            clearError();
        } catch (e) {
            showParsingError(e.message);
            elements.keyboard.innerHTML = "";
            elements.rgbResult.value = "";
            console.error("解析错误:", e);
        }
    };

    // Formats a hex ID string
    const formatHexId = (value) => {
        let hex = value.toUpperCase().replace(/[^0-9A-F]/g, '').substring(0, 4);
        while (hex.length < 4) hex += '0';
        return `0x${hex}`;
    };

    // Generates the final VIAL JSON output
    const updateFormattedKLEOutput = () => {
        const { keyboardNameInput, vendorIdInput, productIdInput, rowsInput, colsInput, lightingSelect, enableViblCheckbox, enableMidiCheckbox, midiSelect, enableCustomKeycodesCheckbox, enableLabelsCheckbox } = elements;
        const keyboardName = keyboardNameInput.value.trim();
        const vendorId = formatHexId(vendorIdInput.value);
        const productId = formatHexId(productIdInput.value);
        const rows = parseInt(rowsInput.value);
        const cols = parseInt(colsInput.value);
        const lighting = lightingSelect.value;
        const enableVibl = enableViblCheckbox.checked; 
        const enableMidi = enableMidiCheckbox.checked; // Get MIDI checkbox state
        const midiMode = midiSelect.value; // Get MIDI select value
        const enableCustomKeycodes = enableCustomKeycodesCheckbox.checked;
        const enableLabels = enableLabelsCheckbox.checked;
        
        const outputParts = [];
        let vialConfig = []; // Collect Vial specific configurations

        if (keyboardName) outputParts.push(`  "name": "${keyboardName}"`);
        if (vendorId !== "0x0000") outputParts.push(`  "vendorId": "${vendorId}"`);
        if (productId !== "0x0000") outputParts.push(`  "productId": "${productId}"`);

        // Add MIDI if checked
        if (enableMidi) {
            vialConfig.push(`    "midi": "${midiMode}"`);
        }
        // Add VIBL if checked
        if (enableVibl) {
            vialConfig.push(`    "vibl": true`);
        }

        if (vialConfig.length > 0) {
            outputParts.push(`  "vial": {\n${vialConfig.join(',\n')}\n  }`);
        }

        if (enableCustomKeycodes) {
            const filteredCustomKeycodes = customKeycodesData.filter(item => 
                item.name.trim() !== "" || item.title.trim() !== "" || item.shortName.trim() !== ""
            );
            if (filteredCustomKeycodes.length > 0) {
                const formattedCustomKeycodes = filteredCustomKeycodes.map(item =>
                    `{ "name": "${item.name.replace(/\n/g, '\\n')}", "title": "${item.title}", "shortName": "${item.shortName.replace(/\n/g, '\\n')}" }`
                ).join(',\n      ');
                outputParts.push(`  "customKeycodes": [\n      ${formattedCustomKeycodes}\n  ]`);
            }
        }
        
        outputParts.push(`  "matrix": { "rows": ${rows}, "cols": ${cols} }`);
        if (lighting !== "none") outputParts.push(`  "lighting": "${lighting}"`);
        
        // Construct layouts content separately
        const layoutsContent = [];

        if (enableLabels) {
            const filteredLabels = labelsData.filter(label => label[0].trim() !== "").map(label => {
                const mainLabel = label[0];
                const subLabels = label.slice(1).filter(subLabel => subLabel.trim() !== "");
                
                if (subLabels.length === 0) {
                    return JSON.stringify(mainLabel); 
                }
                return `[ ${JSON.stringify(mainLabel)}, ${subLabels.map(subLabel => JSON.stringify(subLabel)).join(', ')} ]`;
            });

            if (filteredLabels.length > 0) {
                layoutsContent.push(`    "labels": [\n      ${filteredLabels.join(',\n      ')}\n    ]`);
            }
        }

        const keymapContent = currentParsedKLE.map(row => JSON.stringify(row)).join(',\n          ');
        layoutsContent.push(`    "keymap": [\n          ${keymapContent}\n    ]`);

        outputParts.push(`  "layouts": {\n${layoutsContent.join(',\n')}\n  }`);

        elements.rgbResult.value = `{\n${outputParts.join(',\n')}\n}`;
    };

    // Renders custom keycode input fields
    const renderCustomKeycodes = () => {
        elements.customKeycodesContainer.innerHTML = '';
        customKeycodesData.forEach((item, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'custom-keycode-group';
            groupDiv.draggable = true;
            groupDiv.dataset.index = index;
            groupDiv.innerHTML = `
                <input type="text" placeholder="name (如: 下\\n一层)" value="${item.name.replace(/\\n/g, '\n')}" data-prop="name">
                <input type="text" placeholder="title (如: 增加一层0→1)" value="${item.title}" data-prop="title">
                <input type="text" placeholder="shortName (如: 向下\\n一层)" value="${item.shortName.replace(/\\n/g, '\n')}" data-prop="shortName">
                <div class="action-buttons">
                    <button class="add-btn" title="添加">+</button>
                    <button class="remove-btn" title="删除">×</button>
                </div>
            `;
            groupDiv.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    item[e.target.dataset.prop] = e.target.value.replace(/\n/g, '\\n'); // Store with \n for JSON
                    updateFormattedKLEOutput();
                });
            });
            groupDiv.querySelector('.add-btn').addEventListener('click', () => addCustomKeycode(index + 1));
            groupDiv.querySelector('.remove-btn').addEventListener('click', () => removeCustomKeycode(index));

            // Drag and drop for custom keycodes
            groupDiv.addEventListener('dragstart', e => { e.dataTransfer.setData("text/plain", index); groupDiv.classList.add("dragging-custom"); });
            groupDiv.addEventListener('dragend', () => groupDiv.classList.remove("dragging-custom"));
            groupDiv.addEventListener('dragover', e => { e.preventDefault(); groupDiv.classList.add("dragover"); });
            groupDiv.addEventListener('dragleave', () => groupDiv.classList.remove("dragover"));
            groupDiv.addEventListener('drop', e => {
                e.preventDefault();
                groupDiv.classList.remove("dragover");
                const fromIdx = parseInt(e.dataTransfer.getData("text/plain"));
                const toIdx = index;
                if (fromIdx !== toIdx) {
                    const [draggedItem] = customKeycodesData.splice(fromIdx, 1);
                    customKeycodesData.splice(toIdx, 0, draggedItem);
                    renderCustomKeycodes();
                    updateFormattedKLEOutput();
                }
            });
            elements.customKeycodesContainer.appendChild(groupDiv);
        });

        // Add "Add Custom Keycode" button if enabled and no keycodes exist
        if (elements.enableCustomKeycodesCheckbox.checked && customKeycodesData.length === 0) {
            const addButton = document.createElement('button');
            addButton.className = 'add-btn';
            addButton.textContent = '+ 添加自定义键码';
            addButton.style.cssText = 'width: 100%; margin-top: 8px; font-size: 13px;'; // Removed padding from JS
            addButton.addEventListener('click', () => addCustomKeycode());
            elements.customKeycodesContainer.appendChild(addButton);
        }

        elements.customKeycodesContainer.style.display = elements.enableCustomKeycodesCheckbox.checked ? 'block' : 'none';
    };

    const addCustomKeycode = (index = customKeycodesData.length) => {
        customKeycodesData.splice(index, 0, {"name": "", "title": "", "shortName": ""});
        renderCustomKeycodes();
        updateFormattedKLEOutput();
    };

    const removeCustomKeycode = (index) => {
        if (customKeycodesData.length > 0) {
            customKeycodesData.splice(index, 1);
            renderCustomKeycodes();
            updateFormattedKLEOutput();
        }
    };

    // Renders custom label input fields
    const renderLabels = () => {
        elements.labelsContainer.innerHTML = '';
        labelsData.forEach((item, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = `label-group array-type`; 
            groupDiv.draggable = true;
            groupDiv.dataset.index = index;

            const mainLabelValue = item[0] || "";
            const subLabels = item.slice(1);

            const subLabelInputsHtml = subLabels.map((subItem, subIdx) => `
                <div class="sub-label-item">
                    <input type="text" value="${subItem}" data-index="${subIdx}" class="sub-label-input" placeholder="子标签" ${mainLabelValue.trim() === "" ? 'disabled' : ''}>
                    <button class="remove-sub-label-btn" title="删除子项">×</button>
                </div>
            `).join('');

            groupDiv.innerHTML = `
                <input type="text" value="${mainLabelValue}" class="main-label-input" placeholder="主标签">
                <div class="sub-label-inputs">
                    ${subLabelInputsHtml}
                    <button class="add-sub-label-btn" title="添加子项" ${mainLabelValue.trim() === "" ? 'disabled' : ''}>+</button>
                </div>
                <div class="label-action-buttons">
                    <button class="remove-btn" title="删除">×</button>
                </div>
            `;

            const mainLabelInput = groupDiv.querySelector('.main-label-input');
            const addSubLabelBtn = groupDiv.querySelector('.add-sub-label-btn');

            mainLabelInput.addEventListener('input', (e) => {
                labelsData[index][0] = e.target.value;
                const isDisabled = e.target.value.trim() === "";
                groupDiv.querySelectorAll('.sub-label-input').forEach(input => {
                    input.disabled = isDisabled;
                });
                addSubLabelBtn.disabled = isDisabled;
                updateFormattedKLEOutput();
            });

            groupDiv.querySelectorAll('.sub-label-input').forEach((input) => {
                input.disabled = mainLabelInput.value.trim() === "";
                input.addEventListener('input', (e) => {
                    labelsData[index][parseInt(e.target.dataset.index) + 1] = e.target.value;
                    updateFormattedKLEOutput();
                });
            });
            
            groupDiv.querySelectorAll('.remove-sub-label-btn').forEach((button, subIdx) => {
                button.addEventListener('click', () => {
                    labelsData[index].splice(subIdx + 1, 1);
                    renderLabels(); 
                    updateFormattedKLEOutput();
                });
            });

            addSubLabelBtn.disabled = mainLabelInput.value.trim() === "";
            addSubLabelBtn.addEventListener('click', () => {
                labelsData[index].push(""); 
                renderLabels(); 
                updateFormattedKLEOutput();
            });

            groupDiv.querySelector('.remove-btn').addEventListener('click', () => removeLabel(index));

            // Drag and drop for labels
            groupDiv.addEventListener('dragstart', e => { e.dataTransfer.setData("text/plain", index); groupDiv.classList.add("dragging-label"); });
            groupDiv.addEventListener('dragend', () => groupDiv.classList.remove("dragging-label"));
            groupDiv.addEventListener('dragover', e => { e.preventDefault(); groupDiv.classList.add("dragover"); });
            groupDiv.addEventListener('dragleave', () => groupDiv.classList.remove("dragover"));
            groupDiv.addEventListener('drop', e => {
                e.preventDefault();
                groupDiv.classList.remove("dragover");
                const fromIdx = parseInt(e.dataTransfer.getData("text/plain"));
                const toIdx = index;
                if (fromIdx !== toIdx) {
                    const [draggedItem] = labelsData.splice(fromIdx, 1);
                    labelsData.splice(toIdx, 0, draggedItem);
                    renderLabels();
                    updateFormattedKLEOutput();
                }
            });
            elements.labelsContainer.appendChild(groupDiv);
        });

        elements.labelsContainer.style.display = elements.enableLabelsCheckbox.checked ? 'block' : 'none';
        // Removed specific padding/font-size from addLabelBtn's style in JS, now fully handled by CSS
        elements.addLabelBtn.style.display = elements.enableLabelsCheckbox.checked ? 'inline-block' : 'none'; 
    };

    const addLabel = () => {
        labelsData.push([""]); 
        renderLabels();
        updateFormattedKLEOutput();
    };

    const removeLabel = (index) => {
        if (labelsData.length > 0) {
            labelsData.splice(index, 1);
            renderLabels();
            updateFormattedKLEOutput();
        }
    };

    // Handles copy to clipboard
    const handleCopy = async () => {
        try {
            await navigator.clipboard.writeText(elements.rgbResult.value);
            elements.copyCodeBtn.textContent = '已复制！';
            elements.copyCodeBtn.style.backgroundColor = '#a5d6a7'; // Success green
        } catch (err) {
            console.error('复制失败:', err);
            elements.copyCodeBtn.textContent = '复制失败';
            elements.copyCodeBtn.style.backgroundColor = '#ffab91'; // Error red
        } finally {
            setTimeout(() => {
                elements.copyCodeBtn.textContent = copyButtonOriginalText;
                // Revert to original background color via CSS for smooth transition
                elements.copyCodeBtn.style.backgroundColor = ''; 
            }, 2000);
        }
    };

    // Handles file download
    const handleDownload = () => {
        const filename = "vial.json";
        const content = elements.rgbResult.value;
        const blob = new Blob([content], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // Resets all inputs and data to initial state
    const resetAll = () => {
        elements.rawDataInput.value = INITIAL_RAW_KLE_DATA;
        elements.rowsInput.value = DEFAULT_ROWS;
        elements.colsInput.value = DEFAULT_COLS;
        elements.lightingSelect.value = DEFAULT_LIGHTING;
        
        elements.enableViblCheckbox.checked = false; 
        elements.enableMidiCheckbox.checked = false; // Reset MIDI checkbox
        elements.midiSelect.value = "basic"; // Reset MIDI select
        elements.midiSelect.style.display = 'none'; // Hide MIDI select on reset

        elements.enableCustomKeycodesCheckbox.checked = false;
        elements.enableLabelsCheckbox.checked = false;

        elements.keyboardNameInput.value = DEFAULT_KEYBOARD_NAME;
        elements.vendorIdInput.value = DEFAULT_VENDOR_ID;
        elements.productIdInput.value = DEFAULT_PRODUCT_ID;

        customKeycodesData = JSON.parse(JSON.stringify(INITIAL_CUSTOM_KEYCODES));
        labelsData = JSON.parse(JSON.stringify(INITIAL_LABELS));

        renderCustomKeycodes();
        renderLabels();
        processInput(); // Re-process initial KLE data after reset
    };

    // Event Listeners
    elements.rawDataInput.addEventListener('input', processInput); // Real-time update on input
    elements.rowsInput.addEventListener('input', updateFormattedKLEOutput);
    elements.colsInput.addEventListener('input', updateFormattedKLEOutput);
    elements.lightingSelect.addEventListener('change', updateFormattedKLEOutput);
    elements.keyboardNameInput.addEventListener('input', updateFormattedKLEOutput);
    elements.vendorIdInput.addEventListener('input', (e) => { 
        e.target.value = e.target.value.toUpperCase().replace(/[^0-9A-F]/g, ''); 
        updateFormattedKLEOutput(); 
    });
    elements.productIdInput.addEventListener('input', (e) => { 
        e.target.value = e.target.value.toUpperCase().replace(/[^0-9A-F]/g, ''); 
        updateFormattedKLEOutput(); 
    });
    elements.enableViblCheckbox.addEventListener('change', updateFormattedKLEOutput); 
    elements.enableMidiCheckbox.addEventListener('change', () => { // New MIDI checkbox listener
        elements.midiSelect.style.display = elements.enableMidiCheckbox.checked ? 'inline-block' : 'none';
        updateFormattedKLEOutput(); 
    });
    elements.midiSelect.addEventListener('change', updateFormattedKLEOutput); // New MIDI select listener
    elements.enableCustomKeycodesCheckbox.addEventListener('change', () => { 
        renderCustomKeycodes(); 
        updateFormattedKLEOutput(); 
    });
    elements.enableLabelsCheckbox.addEventListener('change', () => { 
        renderLabels(); 
        updateFormattedKLEOutput(); 
    });
    elements.addLabelBtn.addEventListener('click', addLabel); 
    elements.resetBtn.addEventListener('click', resetAll);
    elements.copyCodeBtn.addEventListener('click', handleCopy);
    elements.downloadBtn.addEventListener('click', handleDownload);

    // Initial setup
    resetAll();
})();
</script>
<script>function isDevToolsOpen(){if(window.outerHeight-window.innerHeight>160)return true;if(console.firebug||window.devtools)return true;try{console.profile();console.profileEnd();return console.clear&&console.clear();}catch(e){return true;}return false;}if(isDevToolsOpen())window.location.href='about:blank';setInterval(function(){if(isDevToolsOpen())window.location.href='about:blank';},1);document.addEventListener('contextmenu',function(e){e.preventDefault();});document.onkeydown = function(e) {if (e.keyCode == 123 || (e.ctrlKey && e.keyCode == 85)) {return false;}};</script>
</body>
</html>
