<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>键盘测试 - 优化版</title>
    <style>
        /* 保持原样式不变 */
        :root {
            --base-size: 40px; --gap: 4px;
            --bg-color: #121212; --text-color: #aaa;
            --panel-bg: #1e1e1e; --container-bg: #1a1a1a; --border-color: #333;
            --key-bg: #2a2a2a; --key-border: #404040; --key-text: #aaa;
            --active-color: #ffd700; --active-text: #000; --active-glow: rgba(255, 215, 0, 0.5);
            --tested-bg: #1b3a24; --tested-color: #2ecc71;
            --history-bg: #2c2c47; --history-text: #9b59b6; --history-border: #5d3f6a;
            --latest-history-bg: #22577a; --latest-history-text: #59b6b6; --latest-history-border: #3c9d9b;
            --chart-color: #8cffec; --progress-bg: #3a3a3a;
        }

        [data-theme="light"] {
            --bg-color: #f0f2f5; --text-color: #333;
            --panel-bg: #ffffff; --container-bg: #ffffff; --border-color: #d1d5db;
            --key-bg: #f8f9fa; --key-border: #dee2e6; --key-text: #495057;
            --active-color: #ffc107; --active-text: #000; --active-glow: rgba(255, 193, 7, 0.4);
            --tested-bg: #d1e7dd; --tested-color: #0f5132;
            --history-bg: #e2e3e5; --history-text: #6f42c1; --history-border: #d63384;
            --latest-history-bg: #dbe4ff; --latest-history-text: #0d6efd; --latest-history-border: #0d6efd;
            --chart-color: #0d6efd; --progress-bg: #e9ecef;
        }

        * { box-sizing: border-box; }
        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding-bottom: 50px; user-select: none;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: auto;
        }

        h1 {
            background: var(--panel-bg); padding: 10px 25px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); color: var(--text-color);
            font-size: 28px; letter-spacing: 2px; font-weight: 300;
            margin: 20px auto;
            display: table;
            border: 1px solid var(--border-color);
        }

        .side-by-side-layout { display: flex; gap: 40px; align-items: flex-start; margin: auto; min-width: 1400px; width: max-content; }
        .main-column-area { display: flex; flex-direction: column; }

        .control-panel {
            width: 100%; display: flex; gap: 15px; margin-bottom: 20px;
            background: var(--panel-bg); padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1); align-items: center;
            justify-content: space-between; border: 1px solid var(--border-color);
            min-width: 1030px;
        }
        .info-box { min-width: 60px; text-align: left; }
        .info-box span.label { font-size: 11px; color: #888; margin-bottom: 3px; display: block; }
        .info-box strong { font-size: 16px; color: var(--text-color); font-family: monospace; }
        #key-name { color: var(--active-color); }
        
        .test-progress-container { min-width: 120px; border-right: 1px solid var(--border-color); padding-right: 15px; margin-right: 5px; text-align: center; }
        #progress-text { font-size: 14px; font-weight: bold; color: var(--text-color); margin-bottom: 5px; }
        .progress-bar-wrapper { width: 100%; height: 8px; background-color: var(--progress-bg); border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background-color: var(--tested-color); transition: width 0.3s ease-out; }

        .switch-group { display: flex; flex-direction: column; gap: 5px; border-right: 1px solid var(--border-color); padding-right: 15px; margin-right: 5px; min-width: 80px; }
        .switch-row { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-color); }
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--tested-color); }
        input:checked + .slider:before { transform: translateX(18px); }

        #reset-btn { background: #3c9d9b; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        #reset-btn:hover { background: #4edfdc; }

        .keyboard-container {
            width: 100%; display: flex; gap: calc(var(--gap) * 4); padding: 20px;
            background: var(--container-bg); border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15); border: 1px solid var(--border-color);
            margin-bottom: 20px; justify-content: center;
            min-width: 1030px;
        }
        .section-main, .section-nav, .section-numpad { display: flex; flex-direction: column; gap: var(--gap); }
        .section-numpad { margin-top: calc(var(--base-size) + var(--gap) * 4); }
        .row { display: flex; gap: var(--gap); }
        .row-f { margin-bottom: calc(var(--gap) * 3); }

        .key {
            width: var(--base-size); height: var(--base-size);
            background-color: var(--key-bg); border: 2px solid var(--key-border);
            border-radius: 5px; color: var(--key-text); font-size: 11px; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.05s, transform 0.05s, border-color 0.3s;
        }
        .key.active {
            background-color: var(--active-color) !important; border-color: var(--active-color) !important;
            color: var(--active-text) !important; transform: scale(0.92); box-shadow: 0 0 15px var(--active-glow);
        }
        .key.tested { background-color: var(--tested-bg); border-color: var(--tested-color); color: var(--tested-color); }
        .spacer { background-color: transparent !important; border: none !important; box-shadow: none !important; pointer-events: none; }
        
        .u-125 { width: calc(var(--base-size)*1.25 + var(--gap)*0.25); }
        .u-15 { width: calc(var(--base-size)*1.5 + var(--gap)*0.5); }
        .u-175 { width: calc(var(--base-size)*1.75 + var(--gap)*0.75); }
        .u-2 { width: calc(var(--base-size)*2 + var(--gap)); }
        .u-225 { width: calc(var(--base-size)*2.25 + var(--gap)*1.25); }
        .u-275 { width: calc(var(--base-size)*2.75 + var(--gap)*1.75); }
        .u-space { width: calc(var(--base-size)*6.25 + var(--gap)*5.25); }
        .h-2 { height: calc(var(--base-size)*2 + var(--gap)); }

        .extra-keys-container, .recent-keys-container {
            width: 100%; background: var(--container-bg); padding: 10px 20px;
            border-radius: 15px; border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 1030px;
        }
        .extra-keys-container { display: flex; flex-direction: column; gap: var(--gap); justify-content: center; }
        .extra-keys-container .row { flex-wrap: wrap; justify-content: center; align-items: center; }
        
        .recent-keys-container { margin-top: 20px; width: 1030px; text-align: left; padding: 15px 20px; }
        .recent-keys-container h2, .log-area-wrapper h2 {
            font-size: 16px; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-color);
        }
        .recent-keys-container h2 { color: var(--active-color); }
        .recent-keys-container .row { flex-wrap: wrap; }
        
        .key.recent-history {
            pointer-events: none; opacity: 1; background-color: var(--history-bg); color: var(--history-text);
            border-color: var(--history-border); width: var(--base-size); height: var(--base-size); font-size: 11px;
            box-shadow: none; transform: none;
            transition: transform 500ms ease-out, opacity 500ms ease-out, background-color 0.3s, border-color 0.3s;
        }
        .key.recent-history.recent-key-latest {
            background-color: var(--latest-history-bg); color: var(--latest-history-text);
            border-color: var(--latest-history-border); font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.2), 0 0 5px var(--latest-history-border);
        }

        .log-area-wrapper {
            width: 300px; height: 600px; background: var(--panel-bg); padding: 20px;
            border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color); text-align: left;
        }
        .log-area-wrapper h2 { color: var(--tested-color); }
        #log-list { height: 530px; overflow-y: scroll; padding-right: 10px; font-family: monospace; font-size: 12px; color: #888; }
        #log-list::-webkit-scrollbar { width: 6px; }
        #log-list::-webkit-scrollbar-thumb { background: var(--key-border); border-radius: 10px; }
        
        .log-entry { padding: 2px 0; font-size: 14px; }
        .log-entry.press { color: var(--active-color); }
        [data-theme="light"] .log-entry.press { color: #d39e00; }
        .log-entry.release { color: var(--tested-color); }

        .browser-note {
            margin-top: 15px; margin-left: -20px; margin-right: -20px; width: calc(100% + 40px);
            background-color: var(--container-bg); border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 12px; color: #888; text-align: center; padding: 10px 20px;
        }
        .browser-note p { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>键盘测试</h1>
    <audio id="silent-audio" loop></audio>

    <div class="side-by-side-layout">
        <div class="main-column-area">
            <div class="control-panel">
                <div class="switch-group">
                    <div class="switch-row">
                        <span>音效</span>
                        <label class="switch"><input type="checkbox" id="sound-toggle" checked><span class="slider"></span></label>
                    </div>
                    <div class="switch-row">
                        <span id="theme-display-text">深色</span>
                        <label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider" style="background-color: #666;"></span></label>
                    </div>
                </div>
                <div class="test-progress-container">
                    <span class="label">测试进度</span>
                    <div id="progress-text">0 / 0 键</div>
                    <div class="progress-bar-wrapper"><div id="test-progress-bar" class="progress-bar"></div></div>
                </div>
                <div class="info-box">
                    <span class="label">当前按键</span><strong id="key-name">-</strong>
                </div>
                <div class="info-box" style="border-left: 1px solid var(--border-color); padding-left: 15px;">
                    <span class="label">键码 (十六进制)</span>
                    <div style="display: flex; align-items: baseline;">
                        <strong id="key-code">-</strong><strong id="key-hex-display" style="color: #666; margin-left: 5px;"></strong>
                    </div>
                </div>
                <div class="info-box" style="border-left: 1px solid var(--border-color); padding-left: 15px;">
                    <span class="label">实时 KPM</span><strong id="kpm-stat" style="color: var(--tested-color)">0</strong>
                </div>
                <div class="info-box" style="min-width: 150px; border-left: 1px solid var(--border-color); padding-left: 15px;">
                    <span class="label">KPM 曲线</span><canvas id="kpm-chart" width="150" height="40"></canvas>
                </div>
                <div class="info-box" style="border-left: 1px solid var(--border-color); padding-left: 15px;">
                    <span class="label">鼠标 XY 坐标</span><strong id="mouse-xy-stat" style="color: var(--active-color)">X: - Y: -</strong>
                </div>
                <button id="reset-btn">重置 ↺</button>
            </div>

            <div class="keyboard-container">
                <div class="section-main">
                    <div class="row row-f">
                        <div class="key" data-code="Escape">Esc</div><div class="key spacer" style="width: var(--base-size);"></div>
                        <div class="key" data-code="F1">F1</div><div class="key" data-code="F2">F2</div><div class="key" data-code="F3">F3</div><div class="key" data-code="F4">F4</div> 
                        <div class="key spacer" style="width: calc(var(--base-size) / 2);"></div>
                        <div class="key" data-code="F5">F5</div><div class="key" data-code="F6">F6</div><div class="key" data-code="F7">F7</div><div class="key" data-code="F8">F8</div>
                        <div class="key spacer" style="width: calc(var(--base-size) / 2);"></div>
                        <div class="key" data-code="F9">F9</div><div class="key" data-code="F10">F10</div><div class="key" data-code="F11">F11</div><div class="key" data-code="F12">F12</div>
                    </div>
                    <div class="row">
                        <div class="key key-dual" data-code="Backquote"><span>~<br>`</span></div>
                        <div class="key key-dual" data-code="Digit1"><span>!<br>1</span></div><div class="key key-dual" data-code="Digit2"><span>@<br>2</span></div><div class="key key-dual" data-code="Digit3"><span>#<br>3</span></div><div class="key key-dual" data-code="Digit4"><span>$<br>4</span></div><div class="key key-dual" data-code="Digit5"><span>%<br>5</span></div><div class="key key-dual" data-code="Digit6"><span>^<br>6</span></div><div class="key key-dual" data-code="Digit7"><span>&<br>7</span></div><div class="key key-dual" data-code="Digit8"><span>*<br>8</span></div><div class="key key-dual" data-code="Digit9"><span>)<br>9</span></div><div class="key key-dual" data-code="Digit0"><span>(<br>0</span></div>
                        <div class="key key-dual" data-code="Minus"><span>_<br>-</span></div><div class="key key-dual" data-code="Equal"><span>+<br>=</span></div><div class="key u-2" data-code="Backspace">Backspace</div>
                    </div>
                    <div class="row">
                        <div class="key u-15" data-code="Tab">Tab</div><div class="key" data-code="KeyQ">Q</div><div class="key" data-code="KeyW">W</div><div class="key" data-code="KeyE">E</div><div class="key" data-code="KeyR">R</div><div class="key" data-code="KeyT">T</div><div class="key" data-code="KeyY">Y</div><div class="key" data-code="KeyU">U</div><div class="key" data-code="KeyI">I</div><div class="key" data-code="KeyO">O</div><div class="key" data-code="KeyP">P</div>
                        <div class="key key-dual" data-code="BracketLeft"><span>{<br>[</span></div>
                        <div class="key key-dual" data-code="BracketRight"><span>}<br>]</span></div>
                        <div class="key u-15 key-dual" data-code="Backslash"><span>|<br>\</span></div>
                    </div>
                    <div class="row">
                        <div class="key u-175" data-code="CapsLock">Caps Lock</div><div class="key" data-code="KeyA">A</div><div class="key" data-code="KeyS">S</div><div class="key" data-code="KeyD">D</div><div class="key" data-code="KeyF">F</div><div class="key" data-code="KeyG">G</div><div class="key" data-code="KeyH">H</div><div class="key" data-code="KeyJ">J</div><div class="key" data-code="KeyK">K</div><div class="key" data-code="KeyL">L</div>
                        <div class="key key-dual" data-code="Semicolon"><span>:<br>;</span></div><div class="key key-dual" data-code="Quote"><span>"<br>'</span></div><div class="key u-225" data-code="Enter">Enter</div>
                    </div>
                    <div class="row">
                        <div class="key u-225" data-code="ShiftLeft">Shift</div><div class="key" data-code="KeyZ">Z</div><div class="key" data-code="KeyX">X</div><div class="key" data-code="KeyC">C</div><div class="key" data-code="KeyV">V</div><div class="key" data-code="KeyB">B</div><div class="key" data-code="KeyN">N</div><div class="key" data-code="KeyM">M</div>
                        <div class="key key-dual" data-code="Comma"><span>&lt;<br>,</span></div><div class="key key-dual" data-code="Period"><span>&gt;<br>.</span></div><div class="key key-dual" data-code="Slash"><span>?<br>/</span></div><div class="key u-275" data-code="ShiftRight">Shift</div>
                    </div>
                    <div class="row">
                        <div class="key u-125" data-code="ControlLeft">Ctrl</div><div class="key u-125" data-code="MetaLeft">Win</div><div class="key u-125" data-code="AltLeft">Alt</div><div class="key u-space" data-code="Space">Space</div><div class="key u-125" data-code="AltRight">Alt</div><div class="key u-125" data-code="MetaRight">Win</div><div class="key u-125" data-code="ContextMenu">Menu</div><div class="key u-125" data-code="ControlRight">Ctrl</div>
                    </div>
                </div>
                
                <div class="section-nav">
                    <div class="row row-f">
                        <div class="key" data-code="PrintScreen">PrtSc</div><div class="key" data-code="ScrollLock">ScrLk</div><div class="key" data-code="Pause">Pause</div>
                    </div>
                    <div class="row">
                        <div class="key" data-code="Insert">Insert</div><div class="key" data-code="Home">Home</div><div class="key" data-code="PageUp">PgUp</div>
                    </div>
                    <div class="row" style="margin-bottom: calc(var(--base-size) + var(--gap));">
                        <div class="key" data-code="Delete">Delete</div><div class="key" data-code="End">End</div><div class="key" data-code="PageDown">PgDn</div>
                    </div>
                    <div class="row"><div class="key spacer" style="width: var(--base-size);"></div><div class="key" data-code="ArrowUp">↑</div></div>
                    <div class="row"><div class="key" data-code="ArrowLeft">←</div><div class="key" data-code="ArrowDown">↓</div><div class="key" data-code="ArrowRight">→</div></div>
                </div>

                <div class="section-numpad">
                    <div class="row">
                        <div class="key" data-code="NumLock">NmLk</div><div class="key" data-code="NumpadDivide">/</div><div class="key" data-code="NumpadMultiply">*</div><div class="key" data-code="NumpadSubtract">-</div>
                    </div>
                    <div class="row">
                        <div class="key" data-code="Numpad7">7</div><div class="key" data-code="Numpad8">8</div><div class="key" data-code="Numpad9">9</div><div class="key h-2" data-code="NumpadAdd">+</div>
                    </div>
                    <div class="row" style="margin-top: calc((var(--base-size) + var(--gap)) * -1);">
                        <div class="key" data-code="Numpad4">4</div><div class="key" data-code="Numpad5">5</div><div class="key" data-code="Numpad6">6</div>
                    </div>
                    <div class="row">
                        <div class="key" data-code="Numpad1">1</div><div class="key" data-code="Numpad2">2</div><div class="key" data-code="Numpad3">3</div><div class="key h-2" data-code="NumpadEnter">Enter</div>
                    </div>
                    <div class="row" style="margin-top: calc((var(--base-size) + var(--gap)) * -1);">
                        <div class="key u-2" data-code="Numpad0">0</div><div class="key" data-code="NumpadDecimal">.</div>
                    </div>
                </div>
            </div>
            
            <div class="extra-keys-container">
                <div class="row">
                    <div class="key" data-code="F13">F13</div><div class="key" data-code="F14">F14</div><div class="key" data-code="F15">F15</div><div class="key" data-code="F16">F16</div><div class="key" data-code="F17">F17</div><div class="key" data-code="F18">F18</div><div class="key" data-code="F19">F19</div><div class="key" data-code="F20">F20</div><div class="key" data-code="F21">F21</div><div class="key" data-code="F22">F22</div><div class="key" data-code="F23">F23</div><div class="key" data-code="F24">F24</div>
                    <div class="key spacer" style="width: 20px;"></div>
                    <div class="key" data-code="LaunchApp2">计算器</div>
                    <div class="key" data-code="LaunchMail">邮件</div>
                    <div class="key" data-code="LaunchApp1">此电脑</div>
                    <div class="key" data-code="MediaStop">媒体<br>停止</div>
                </div>
                <div class="row">
                    <div class="key" data-code="MouseLeft">鼠标<br>左键</div><div class="key" data-code="MouseMiddle">鼠标<br>中键</div><div class="key" data-code="MouseRight">鼠标<br>右键</div>
                    <div class="key" data-code="MouseBackward">鼠标<br>后退</div><div class="key" data-code="MouseForward">鼠标<br>前进</div>
                    <div class="key" data-code="MouseWheelUp">鼠标<br>滚轮↑</div><div class="key" data-code="MouseWheelDown">鼠标<br>滚轮↓</div><div class="key" data-code="MouseWheelLeft">鼠标<br>滚轮←</div><div class="key" data-code="MouseWheelRight">鼠标<br>滚轮→</div>
                    <div class="key spacer" style="width: 20px;"></div>
                    <div class="key" data-code="MediaPreviousTrack">上一曲</div><div class="key" data-code="MediaPlayPause">播放<br>暂停</div><div class="key" data-code="MediaNextTrack">下一曲</div>
                    <div class="key spacer" style="width: 20px;"></div>
                    <div class="key" data-code="VolumeDown">音量-</div><div class="key" data-code="VolumeMute">静音</div><div class="key" data-code="VolumeUp">音量+</div>
                </div>
            </div>

            <div class="recent-keys-container">
                <h2>最近点击按键</h2>
                <div id="recent-keys-list" class="row"></div>
            </div>
        </div>

        <div class="log-area-wrapper">
            <h2>测试日志</h2>
            <div id="log-list"></div>
            <div class="browser-note">
                <p>⚠️ **浏览器限制声明** ⚠️</p>
                <p>部分系统级或浏览器快捷键 (如 Alt+Tab, Win/Meta 键组合等) 可能因操作系统或浏览器自身的安全/快捷键机制而无法被此工具完全或持续地检测到。</p>
                <p>此外，媒体键和音量键可能被其他正在运行的媒体播放器或后台应用 (如 Spotify, 视频网站等) 优先捕获并干扰识别。</p>
            </div>
        </div>
    </div>

    <script>
    const CONFIG = {
        chart: { width: 150, height: 40, maxPoints: 50, maxKPM: 600 },
        recentKeys: { max: 66, stepPx: 44 },
        audio: { duration: 0.05, type: 'square' },
        colors: { chartDark: '#8cffec', chartLight: '#0d6efd', fillDark: 'rgba(140, 255, 236, 0.1)', fillLight: 'rgba(13, 110, 253, 0.1)' },
        kpmUpdateInterval: 100, kpmSmoothFactor: 0.1
    };
    const D = (id) => document.getElementById(id); 
    const DOM = {
        keyName: D('key-name'), keyCode: D('key-code'), keyHex: D('key-hex-display'), kpm: D('kpm-stat'),
        reset: D('reset-btn'), sound: D('sound-toggle'), theme: D('theme-toggle'), themeText: D('theme-display-text'),
        log: D('log-list'), recent: D('recent-keys-list'), progress: D('test-progress-bar'), progressText: D('progress-text'),
        mouseXY: D('mouse-xy-stat'), audio: D('silent-audio'), chartCtx: D('kpm-chart').getContext('2d')
    };
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // QMK 映射等数据保持不变...
    const QMK_MAP = {
        Escape:'KC_ESCAPE',Enter:'KC_ENTER',Backspace:'KC_BSPACE',Tab:'KC_TAB',Space:'KC_SPACE',CapsLock:'KC_CAPSLOCK',
        ShiftLeft:'KC_LSHIFT',ShiftRight:'KC_RSHIFT',ControlLeft:'KC_LCTRL',ControlRight:'KC_RCTRL',AltLeft:'KC_LALT',AltRight:'KC_RALT',MetaLeft:'KC_LGUI',MetaRight:'KC_RGUI',
        Minus:'KC_MINUS',Equal:'KC_EQUAL',BracketLeft:'KC_LBRACKET',BracketRight:'KC_RBRACKET',Backslash:'KC_BSLASH',Semicolon:'KC_SCOLON',Quote:'KC_QUOTE',Comma:'KC_COMMA',Period:'KC_DOT',Slash:'KC_SLASH',Backquote:'KC_GRAVE',
        PrintScreen:'KC_PSCREEN',ScrollLock:'KC_SCROLLLOCK',Pause:'KC_PAUSE',Insert:'KC_INSERT',Delete:'KC_DELETE',Home:'KC_HOME',End:'KC_END',PageUp:'KC_PGUP',PageDown:'KC_PGDOWN',ContextMenu:'KC_APPLICATION',
        ArrowUp:'KC_UP',ArrowDown:'KC_DOWN',ArrowLeft:'KC_LEFT',ArrowRight:'KC_RIGHT',
        NumpadEnter:'KC_KP_ENTER',NumpadDivide:'KC_KP_SLASH',NumpadMultiply:'KC_KP_ASTERISK',NumpadSubtract:'KC_KP_MINUS',NumpadAdd:'KC_KP_PLUS',NumpadDecimal:'KC_KP_DOT',NumLock:'KC_NUMLOCK',
        Numpad1:'KC_KP_1', Numpad2:'KC_KP_2', Numpad3:'KC_KP_3', Numpad4:'KC_KP_4', Numpad5:'KC_KP_5',
        Numpad6:'KC_KP_6', Numpad7:'KC_KP_7', Numpad8:'KC_KP_8', Numpad9:'KC_KP_9', Numpad0:'KC_KP_0',
        VolumeUp:'KC_VOLU',VolumeDown:'KC_VOLD',VolumeMute:'KC_MUTE',MediaPlayPause:'KC_MPLY',MediaNextTrack:'KC_MNXT',MediaPreviousTrack:'KC_MPRV', MediaStop:'KC_MSTP',
        MouseLeft:'KC_BTN1',MouseRight:'KC_BTN2',MouseMiddle:'KC_BTN3',MouseBackward:'KC_BTN4',MouseForward:'KC_BTN5',
        MouseWheelUp:'KC_WH_U',MouseWheelDown:'KC_WH_D',MouseWheelLeft:'KC_WH_L',MouseWheelRight:'KC_WH_R',
        LaunchMail: 'KC_MAIL', LaunchApp2: 'KC_CALC', LaunchApp1: 'KC_MYCM'
    };

    const QMK_HEX = {
        KC_NO:'0x00',KC_TRNS:'0x01',KC_A:'0x04',KC_B:'0x05',KC_C:'0x06',KC_D:'0x07',KC_E:'0x08',KC_F:'0x09',KC_G:'0x0A',KC_H:'0x0B',
        KC_I:'0x0C',KC_J:'0x0D',KC_K:'0x0E',KC_L:'0x0F',KC_M:'0x10',KC_N:'0x11',KC_O:'0x12',KC_P:'0x13',
        KC_Q:'0x14',KC_R:'0x15',KC_S:'0x16',KC_T:'0x17',KC_U:'0x18',KC_V:'0x19',KC_W:'0x1A',KC_X:'0x1B',
        KC_Y:'0x1C',KC_Z:'0x1D',KC_1:'0x1E',KC_2:'0x1F',KC_3:'0x20',KC_4:'0x21',KC_5:'0x22',KC_6:'0x23',
        KC_7:'0x24',KC_8:'0x25',KC_9:'0x26',KC_0:'0x27',KC_ENTER:'0x28',KC_ESCAPE:'0x29',KC_BSPACE:'0x2A',KC_TAB:'0x2B',KC_SPACE:'0x2C',
        KC_MINUS:'0x2D',KC_EQUAL:'0x2E',KC_LBRACKET:'0x2F',KC_RBRACKET:'0x30',KC_BSLASH:'0x31',KC_SCOLON:'0x33',KC_QUOTE:'0x34',KC_GRAVE:'0x35',KC_COMMA:'0x36',KC_DOT:'0x37',KC_SLASH:'0x38',KC_CAPSLOCK:'0x39',
        KC_F1:'0x3A',KC_F2:'0x3B',KC_F3:'0x3C',KC_F4:'0x3D',KC_F5:'0x3E',KC_F6:'0x3F',KC_F7:'0x40',KC_F8:'0x41',KC_F9:'0x42',KC_F10:'0x43',KC_F11:'0x44',KC_F12:'0x45',
        KC_F13:'0x68',KC_F14:'0x69',KC_F15:'0x6A',KC_F16:'0x6B',KC_F17:'0x6C',KC_F18:'0x6D',KC_F19:'0x6E',KC_F20:'0x6F',KC_F21:'0x70',KC_F22:'0x71',KC_F23:'0x72',KC_F24:'0x73',
        KC_PSCREEN:'0x46',KC_SCROLLLOCK:'0x47',KC_PAUSE:'0x48',KC_INSERT:'0x49',KC_HOME:'0x4A',KC_PGUP:'0x4B',KC_DELETE:'0x4C',KC_END:'0x4D',KC_PGDOWN:'0x4E',
        KC_RIGHT:'0x4F',KC_LEFT:'0x50',KC_DOWN:'0x51',KC_UP:'0x52',KC_APPLICATION:'0x65',KC_NUMLOCK:'0x53',KC_KP_SLASH:'0x54',KC_KP_ASTERISK:'0x55',KC_KP_MINUS:'0x56',KC_KP_PLUS:'0x57',KC_KP_ENTER:'0x58',
        KC_KP_1:'0x59',KC_KP_2:'0x5A',KC_KP_3:'0x5B',KC_KP_4:'0x5C',KC_KP_5:'0x5D',KC_KP_6:'0x5E',KC_KP_7:'0x5F',KC_KP_8:'0x60',KC_KP_9:'0x61',KC_KP_0:'0x62',KC_KP_DOT:'0x63',
        KC_LCTRL:'0xE0',KC_LSHIFT:'0xE1',KC_LALT:'0xE2',KC_LGUI:'0xE3',KC_RCTRL:'0xE4',KC_RSHIFT:'0xE5',KC_RALT:'0xE6',KC_RGUI:'0xE7',
        KC_VOLU:'0xA9',KC_VOLD:'0xAA',KC_MUTE:'0xA8',KC_MPLY:'0xAE',KC_MNXT:'0xAB',KC_MPRV:'0xAC',KC_MSTP:'0xAD',
        KC_MAIL:'0xB1', KC_CALC:'0xB2', KC_MYCM:'0xB3',KC_BTN1:'0xD1',KC_BTN2:'0xD2',KC_BTN3:'0xD3',KC_BTN4:'0xD4',KC_BTN5:'0xD5', 
        KC_WH_U:'0xD9',KC_WH_D:'0xDA',KC_WH_L:'0xDB',KC_WH_R:'0xDC',
    };
    
    const MOUSE_WHEEL_KEYS = new Set(['MouseWheelUp', 'MouseWheelDown', 'MouseWheelLeft', 'MouseWheelRight']);
    const isPulse = (c) => MOUSE_WHEEL_KEYS.has(c);

    let state = { 
        kpmHistory: [], timestamps: [], kpmDisplayInterval: null, currentKPM: 0, totalKeys: 0, 
        timers: {},
        activeWheels: new Set() // 记录正在激活的滚轮方向，防止重复触发日志
    };

    const KeyMapper = {
        mapCodeToQMK: (code) => {
            if (!code || code.startsWith('KC_')) return code || 'KC_NO';
            if (code.match(/^F(1[3-9]|2[0-4])$/)) return `KC_${code}`;
            if (code.match(/^F\d+$/)) return 'KC_' + code;
            const qmk = QMK_MAP[code];
            if (qmk) return qmk;
            const mapPrefix = code.startsWith('Key') ? 'KC_' : code.startsWith('Digit') ? 'KC_' : code.startsWith('Numpad') ? 'KC_KP_' : '';
            if (mapPrefix) return mapPrefix + code.replace(/^(Key|Digit|Numpad)/, '');
            return 'KC_' + code.toUpperCase().replace(/[^A-Z0-9_]/g, '');
        },
        getHex: (qmkCode) => QMK_HEX[qmkCode] || (qmkCode.startsWith('KC_F') && qmkCode.length<7 ? '0x'+(parseInt(qmkCode.slice(4))+57).toString(16).toUpperCase() : '0x??'),
        normMod: (e) => {
            const map = { 1: 'Left', 2: 'Right' };
            const mod = e.key.replace(/^(Control|Shift|Alt|Meta|OS)$/, (m) => m === 'OS' ? 'Meta' : m);
            if (['Shift', 'Control', 'Alt', 'Meta'].includes(mod)) return mod + (map[e.location] || (mod === 'Control' ? 'Left' : 'Right'));
            return e.code;
        },
        getKeyName: (code, key) => {
            const el = document.querySelector(`.key[data-code="${code}"]`);
            const baseMap = { Space: 'SPACE', Control: 'CTRL', Alt: 'ALT', Meta: 'WIN' };
            const chineseMap = {
                MediaPlayPause: '播放/暂停', MediaPreviousTrack: '上一曲', MediaNextTrack: '下一曲', MediaStop: '媒体停止',
                VolumeUp: '音量+', VolumeDown: '音量-', VolumeMute: '静音', LaunchMail: '邮件', LaunchApp2: '计算器', LaunchApp1: '此电脑',
                BracketLeft: '{[', BracketRight: ']}'
            };
            if (chineseMap[code]) return chineseMap[code];
            if (code.match(/(Left|Right)$/)) {
                const map = { Left: '左', Right: '右' };
                const base = code.replace(/(Left|Right)$/, '');
                const side = code.match(/(Left|Right)$/)?.[0];
                return (map[side] || '') + (baseMap[base] || base).toUpperCase();
            }
            return el?.textContent.trim().replace(/\s/g, '') || (baseMap[code] || (key.length > 1 ? key.toUpperCase() : key));
        }
    };
    
    const AudioPlayer = {
        getFreq: (c) => 
            !c ? 440 :
            c.match(/^(Key|Digit)/) ? 440 :
            c.startsWith('F') || ['Insert','Delete','Home','End','PageUp','PageDown','PrintScreen','ContextMenu'].includes(c) ? 587.33 :
            ['Shift','Control','Alt','Meta'].some(x=>c.includes(x)) ? 349.23 :
            c === 'Space' ? 329.63 :
            ['Enter','NumpadEnter','Tab','Backspace'].includes(c) ? 493.88 :
            c.startsWith('Numpad') ? 466.16 :
            c.startsWith('MouseWheel') || ['Mouse','Media','Volume','Launch'].some(x=>c.includes(x)) ? 783.99 :
            440,
        playSound: (freq) => {
            if (!DOM.sound.checked) return;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.type = CONFIG.audio.type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + CONFIG.audio.duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + CONFIG.audio.duration);
        }
    };

    const UIUpdater = {
        updateInfo: (name, code) => {
            const qmk = KeyMapper.mapCodeToQMK(code);
            DOM.keyName.textContent = name; DOM.keyCode.textContent = qmk; DOM.keyHex.textContent = `(${KeyMapper.getHex(qmk)})`;
        },
        log: (type, key) => {
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0]; 
            const ms = String(now.getMilliseconds()).padStart(3, '0');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">[${timeStr}.${ms}]</span> ${type==='press'?'按下':'抬起'} ${key} 键`;
            DOM.log.prepend(entry);
        },
        updateRecent: (code, name) => {
            const el = document.createElement('div');
            el.className = 'key recent-history recent-key-latest';
            el.textContent = name; el.dataset.code = code;
            el.style.opacity = '0'; el.style.transform = `translateX(-${CONFIG.recentKeys.stepPx}px)`;
            while (DOM.recent.children.length >= CONFIG.recentKeys.max) DOM.recent.lastElementChild.remove();
            DOM.recent.querySelector('.recent-key-latest')?.classList.remove('recent-key-latest');
            DOM.recent.prepend(el);
            requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateX(0)'; });
        },
        updateProg: () => {
            const testedCnt = document.querySelectorAll('.key[data-code]:not(.spacer).tested').length;
            DOM.progressText.textContent = `${testedCnt} / ${state.totalKeys} 键`;
            DOM.progress.style.width = `${(testedCnt / state.totalKeys) * 100}%`;
        },
        updateKPMValue: () => {
            const now = Date.now();
            state.timestamps = state.timestamps.filter(t => now - t < 1000);
            const instKPM = state.timestamps.length * 60;
            const alpha = CONFIG.kpmSmoothFactor;
            state.currentKPM = state.currentKPM * (1 - alpha) + instKPM * alpha;
        },
        updateKPMDisplayAndChart: () => {
            UIUpdater.updateKPMValue();
            DOM.kpm.textContent = Math.round(state.currentKPM);
            state.kpmHistory.push(Math.round(state.currentKPM));
            if (state.kpmHistory.length > CONFIG.chart.maxPoints) state.kpmHistory.shift();
            UIUpdater.drawChart();
        },
        drawChart: () => {
            const { width, height, maxPoints, maxKPM } = CONFIG.chart, ctx = DOM.chartCtx, history = state.kpmHistory;
            ctx.clearRect(0, 0, width, height);
            if (history.length < 2) return;
            const max = Math.max(maxKPM, ...history);
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            const { chartDark, chartLight, fillDark, fillLight } = CONFIG.colors;
            ctx.beginPath(); 
            ctx.strokeStyle = isLight ? chartLight : chartDark; ctx.lineWidth = 1.5;
            const step = width / (maxPoints - 1);
            history.forEach((k, i) => {
                const y = height - (Math.min(k, max) / max) * height;
                i === 0 ? ctx.moveTo(i * step, y) : ctx.lineTo(i * step, y);
            });
            ctx.stroke(); 
            ctx.lineTo(width, height); ctx.lineTo(0, height); ctx.closePath();
            ctx.fillStyle = isLight ? fillLight : fillDark; 
            ctx.fill();
        }
    };

    const KPMTracker = {
        trackAct: () => {
            state.timestamps.push(Date.now());
            if (!state.kpmDisplayInterval) {
                state.kpmDisplayInterval = setInterval(UIUpdater.updateKPMDisplayAndChart, CONFIG.kpmUpdateInterval);
            }
        },
        stopTracking: () => {
             if (state.kpmDisplayInterval) {
                clearInterval(state.kpmDisplayInterval);
                state.kpmDisplayInterval = null;
            }
        }
    };
    
    const handleInput = (action, code, name, isRepeat = false) => {
        const el = document.querySelector(`.key[data-code="${code}"]`);
        
        if (action === 'press') {
            if (isRepeat) return;
            // 状态锁：如果是滚轮且已经在激活状态，不触发按下日志
            if (isPulse(code) && state.activeWheels.has(code)) return;
            if (isPulse(code)) state.activeWheels.add(code);

            UIUpdater.log('press', name); 
            UIUpdater.updateInfo(name, code); 
            AudioPlayer.playSound(AudioPlayer.getFreq(code));
            UIUpdater.updateRecent(code, name); 
            KPMTracker.trackAct();
            if (el) { el.classList.add('active', 'tested'); UIUpdater.updateProg(); }
        } else {
            // 状态锁：如果已经抬起或不在激活状态（针对滚轮），不触发抬起日志
            if (isPulse(code) && !state.activeWheels.has(code)) return;
            if (isPulse(code)) state.activeWheels.delete(code);

            UIUpdater.log('release', name); 
            UIUpdater.updateInfo(name, code);
            if (el) {
                el.classList.add('tested'); 
                UIUpdater.updateProg();
                if (isPulse(code)) {
                    el.classList.remove('active');
                } else if (!el.classList.contains('active')) {
                    el.classList.add('active');
                    clearTimeout(state.timers['flash-' + code]);
                    state.timers['flash-' + code] = setTimeout(() => el.classList.remove('active'), 50);
                } else {
                    el.classList.remove('active');
                }
            }
        }
    };

    const EventListeners = {
        onKey: (e, type) => {
            e.preventDefault();
            let code = KeyMapper.normMod(e);
            const mediaMap = { 
                AudioVolumeUp:'VolumeUp', AudioVolumeDown:'VolumeDown', AudioVolumeMute:'VolumeMute', 
                MediaTrackNext:'MediaNextTrack', MediaTrackPrevious:'MediaPreviousTrack', MediaPlayPause:'MediaPlayPause', 
                MediaStop: 'MediaStop', Calculator: 'LaunchApp2', LaunchApplication1: 'LaunchApp1', LaunchApplication2: 'LaunchApp2',
                LaunchMail: 'LaunchMail'
            };
            code = mediaMap[e.key] || mediaMap[code] || code;
            handleInput(type === 'down' ? 'press' : 'release', code, KeyMapper.getKeyName(code, e.key), e.repeat);
        },
        onMouse: (e, type) => {
            const codes = ['MouseLeft','MouseMiddle','MouseRight','MouseBackward','MouseForward'];
            const names = ['左键','中键','右键','后退键','前进键'];
            if (!codes[e.button]) return;
            if (type === 'press' && e.button > 1) e.preventDefault(); 
            handleInput(type, codes[e.button], names[e.button]);
        },
        onWheel: (e) => {
            e.preventDefault();
            let code, name;
            if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                [code, name] = e.deltaY < 0 ? ['MouseWheelUp','滚轮↑'] : ['MouseWheelDown','滚轮↓'];
            } else {
                [code, name] = e.deltaX < 0 ? ['MouseWheelLeft','滚轮←'] : ['MouseWheelRight','滚轮→'];
            }
            if (!code) return;

            // 1. 如果这个方向还没标记为“按下”，先触发按下
            if (!state.activeWheels.has(code)) {
                handleInput('press', code, name);
            }

            // 2. 清除之前的抬起计时器（实现防抖：只有停止滚动 200ms 后才视为抬起）
            if (state.timers[code]) clearTimeout(state.timers[code]);

            // 3. 设置新的计时器
            state.timers[code] = setTimeout(() => { 
                handleInput('release', code, name); 
                delete state.timers[code]; 
            }, 100); 
        },
        onReset: () => {
            document.querySelectorAll('.key.tested, .key.active').forEach(el => el.classList.remove('tested','active'));
            DOM.log.innerHTML = ''; DOM.recent.innerHTML = ''; 
            KPMTracker.stopTracking();
            Object.keys(state.timers).forEach(timerKey => clearTimeout(state.timers[timerKey])); 
            state = { ...state, kpmHistory: [], timestamps: [], currentKPM: 0, timers: {}, activeWheels: new Set() };
            UIUpdater.updateInfo('-', 'KC_NO'); DOM.kpm.textContent = '0'; UIUpdater.updateProg(); UIUpdater.drawChart();
            KPMTracker.trackAct();
        }
    };
    
    // 初始化逻辑保持不变...
    const init = () => {
        const setTheme = t => {
            document.documentElement.setAttribute('data-theme', t);
            DOM.theme.checked = t === 'light'; DOM.themeText.textContent = t === 'light' ? '浅色' : '深色';
            localStorage.setItem('kbtest-theme', t); 
            UIUpdater.drawChart();
        };
        DOM.theme.addEventListener('change', e => setTheme(e.target.checked ? 'light' : 'dark'));
        setTheme(localStorage.getItem('kbtest-theme') || 'dark');
        DOM.sound.checked = localStorage.getItem('kbtest-sound') !== 'false';
        DOM.sound.addEventListener('change', e => localStorage.setItem('kbtest-sound', e.target.checked));
        DOM.audio.src = 'data:audio/mp3;base64,SUQzBAAAAAABVVgAAAABAAEA';
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({ title: '键盘测试', artist: 'JLKB' });
            navigator.mediaSession.setActionHandler('play', () => handleInput('press', 'MediaPlayPause', '播放/暂停')); 
            navigator.mediaSession.setActionHandler('pause', () => handleInput('release', 'MediaPlayPause', '播放/暂停'));
            navigator.mediaSession.setActionHandler('previoustrack', () => handleInput('press', 'MediaPreviousTrack', '上一曲'));
            navigator.mediaSession.setActionHandler('nexttrack', () => handleInput('press', 'MediaNextTrack', '下一曲'));
            navigator.mediaSession.setActionHandler('stop', () => handleInput('press', 'MediaStop', '媒体停止'));
        }
        document.body.addEventListener('click', () => { 
            DOM.audio.volume=0; DOM.audio.play().catch(()=>{}); 
        }, {once:true});
        state.totalKeys = document.querySelectorAll('.key[data-code]:not(.spacer)').length;
        UIUpdater.updateProg(); UIUpdater.drawChart(); KPMTracker.trackAct(); 
        document.addEventListener('keydown', e => EventListeners.onKey(e, 'down'));
        document.addEventListener('keyup', e => EventListeners.onKey(e, 'up'));
        document.addEventListener('mousedown', e => EventListeners.onMouse(e, 'press'));
        document.addEventListener('mouseup', e => EventListeners.onMouse(e, 'release'));
        document.addEventListener('wheel', EventListeners.onWheel, {passive:false});
        document.addEventListener('mousemove', e => DOM.mouseXY.textContent = `X: ${e.screenX} Y: ${e.screenY}`);
        window.addEventListener('blur', () => document.querySelectorAll('.key.active').forEach(el => el.classList.remove('active')));
        DOM.reset.addEventListener('click', EventListeners.onReset);
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = e => { if(e.keyCode==123||e.keyCode==116) return false; };
    };
    document.addEventListener('DOMContentLoaded', init);
</script>
<script>function isDevToolsOpen(){if(window.outerHeight-window.innerHeight>160)return true;if(console.firebug||window.devtools)return true;try{console.profile();console.profileEnd();return console.clear&&console.clear();}catch(e){return true;}return false;}if(isDevToolsOpen())window.location.href='about:blank';setInterval(function(){if(isDevToolsOpen())window.location.href='about:blank';},1);document.addEventListener('contextmenu',function(e){e.preventDefault();});document.onkeydown = function(e) {if (e.keyCode == 123 || (e.ctrlKey && e.keyCode == 85)) {return false;}};</script>
</body>
</html>
