<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<link rel="icon" type="image/png" sizes="310x310" href="./logo.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RGB工具</title>
<style>
  /* 基础浅色模式样式 */
  body {
    font-family: "Segoe UI", "Helvetica Neue", sans-serif;
    background-color: #eef2f7; /* 浅色背景 */
    color: #333; /* 浅色文字 */
    line-height: 1.5;
    margin: 0;
    padding: 1.5rem; /* 对应整体宽度计算中的 3rem 边距 */
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    box-sizing: border-box;
  }

  .main-wrapper {
    display: flex;
    /* max-width: 1400px; /* 已取消最大宽度限制 */
    width: calc(100% - 3rem); /* 整体宽度 */
    gap: 20px;
  }

  .left-panel, .right-panel {
    background-color: #fff; /* 浅色卡片背景 */
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    padding: 25px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }

  .left-panel {
    flex: 2; /* 左列宽度比例为 2 */
    max-width: unset; /* 取消最大宽度限制 */
    width: 100%;
    position: relative;
    /* 移除 min-height/height，让它根据内容自动决定高度 */
  }

  /* --- 右侧面板修改开始 --- */
  .right-panel {
    flex: 1; /* 右列宽度比例为 1 */
    max-width: unset; /* 取消最大宽度限制 */
    width: 100%;
    position: sticky;
    top: 1.5rem; /* 保持与 body padding 一致 */
    /* 修改高度和溢出属性，使其适应左侧高度，并让文本框占满剩余空间 */
    height: calc(100vh - 3rem); /* 右侧面板高度等于视口高度减去上下边距 */
    min-width: 350px;
    overflow-y: auto;
  }
  
  textarea#rgbResult {
    flex-grow: 1; /* **关键修改点：让文本框占据右侧面板内的所有剩余空间** */
    margin-top: 15px;
    min-height: 200px; /* 保持最小高度，以防内容过少时撑不起 */
    max-height: unset;
    color: #212529; /* 浅色结果文本颜色 */
    background: #f8faff; /* 浅色结果文本背景 */
    border: 1px solid #dbe2ed; /* 浅色结果文本边框 */
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.04);
  }
  /* --- 右侧面板修改结束 --- */

  h2 {
    text-align: center;
    color: #2c3e50; /* 浅色标题颜色 */
    margin-bottom: 30px;
    font-size: 2.5em;
    font-weight: 700;
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e0e0e0; /* 浅色分割线 */
  }

  .result-header .section-title {
    font-size: 1.2em;
    font-weight: 600;
    color: #444; /* 浅色标题颜色 */
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .result-header .action-buttons button {
    padding: 8px 14px;
    font-size: 13px;
    margin-left: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .section-title {
    font-size: 1.2em;
    font-weight: 600;
    color: #444; /* 浅色标题颜色 */
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e0e0e0;
  }

  .input-section, .controls-section {
    margin-bottom: 20px;
    padding: 20px;
    background-color: #fdfdfd; /* 浅色内部模块背景 */
    border-radius: 8px;
    border: 1px solid #e9ecef; /* 浅色柔和边框 */
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.04);
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #444; /* 浅色标签颜色 */
    font-size: 0.95em;
  }

  textarea {
    width: calc(100% - 18px);
    height: 100px;
    font-family: 'Roboto Mono', monospace;
    font-size: 14px;
    padding: 9px;
    border: 1px solid #ccc; /* 浅色边框 */
    border-radius: 6px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    resize: vertical;
    background-color: #fff; /* 浅色文本域背景 */
    color: #333; /* 浅色文本域文字颜色 */
  }

  textarea:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
  }

  #errorDisplay, #centerPointError, #animationsError {
    color: #e74c3c; /* 错误信息颜色 */
    font-size: 0.9em;
    margin-top: 8px;
    min-height: 1.5em;
    font-weight: 600;
  }

  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input[type="number"] {
    padding: 8px 12px;
    border: 1px solid #ccc; /* 浅色边框 */
    border-radius: 6px;
    font-size: 14px;
    margin-right: 10px;
    width: 65px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background-color: #fff; /* 浅色数字输入框背景 */
    color: #333; /* 浅色数字输入框文字颜色 */
  }

  input[type="number"]:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
  }

  button {
    padding: 10px 18px;
    margin-right: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    outline: none;
  }

  button:active {
    transform: translateY(1px);
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.15);
  }

  button#renderBtn, button#convertRGB {
    background-color: #007bff;
    color: #fff;
  }

  button#renderBtn:hover, button#convertRGB:hover {
    background-color: #0069d9;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  button#reverseBtn {
    background-color: #6c757d;
    color: #fff;
  }

  button#reverseBtn.active {
    background-color: #28a745;
  }

  button#reverseBtn:hover {
    background-color: #5a6268;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  button#copyCodeBtn {
    background-color: #17a2b8;
    color: #fff;
  }

  button#copyCodeBtn:hover {
    background-color: #138496;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  button#resetBtn {
      background-color: #dc3545;
      color: #fff;
  }
  button#resetBtn:hover {
      background-color: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .color-label {
    display: inline-block;
    width: 18px;
    height: 18px;
    margin-left: 12px;
    border-radius: 5px;
    vertical-align: middle;
    border: 1px solid #ccc; /* 浅色边框 */
  }

  .color-label + span {
    vertical-align: middle;
    margin-left: 8px;
    font-size: 0.95em;
    color: #777; /* 浅色说明文字 */
    font-weight: 400;
  }

  .option-group {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 15px;
    margin-bottom: 15px;
    align-items: center;
  }

  .option-group div {
    display: flex;
    align-items: center;
    font-size: 0.92em;
    color: #555; /* 浅色选项文字 */
  }

  .option-group input[type="checkbox"] {
    margin-right: 8px;
    transform: scale(1.2);
  }

  .option-group select {
    padding: 7px 10px;
    border: 1px solid #ccc; /* 浅色边框 */
    border-radius: 6px;
    font-size: 14px;
    margin-left: 6px;
    background-color: #fff; /* 浅色下拉菜单背景 */
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease;
    color: #333; /* 浅色下拉菜单文字颜色 */
  }

  .option-group select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
  }

  #animationsOptions {
    margin-top: 15px;
    margin-bottom: 20px;
    background-color: #fbfbfb; /* 浅色动画选项背景 */
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
  }
  #animationsOptions .animations-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }
  #animationsOptions .animations-row div {
    display: flex;
    align-items: center;
    width: calc((100% - 7 * 10px) / 8);
    box-sizing: border-box;
    min-width: 100px;
  }

  #animationsOptions .animations-row div label {
    display: inline-block;
    margin-bottom: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1;
    cursor: pointer;
    font-size: 0.9em;
    color: #555; /* 浅色动画标签文字 */
  }

  .animation-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
    align-items: center;
  }
  .animation-controls button {
    padding: 8px 14px;
    font-size: 0.85em;
    margin-right: 0;
  }
  .animation-controls input[type="number"] {
    width: 50px;
    margin-right: 0;
  }
  .animation-controls label {
    margin-bottom: 0;
    margin-left: 6px;
    font-size: 0.9em;
    color: #555; /* 浅色动画控制标签文字 */
  }


  #keyboard {
    margin-top: 25px;
    position: relative;
    background: #fcfcfc; /* 浅色键盘背景 */
    border: 1px solid #e0e0e0; /* 浅色键盘边框 */
    border-radius: 8px;
    box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.06);
    min-height: 100px;
    transition: height 0.3s ease;
    overflow-x: auto;
    max-width: 800px;
    padding-bottom: 10px;
  }

  .key {
    position: absolute;
    background: #007bff; /* 浅色按键背景 */
    color: #fff; /* 浅色按键文字 */
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    font-weight: 500;
    border-radius: 4px;
    user-select: none;
    cursor: grab;
    transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
  }

  .key:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  }

  .key.dragging {
    opacity: 0.7;
    cursor: grabbing;
    transform: scale(1.08);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.35);
    z-index: 100;
  }

  .key.dragover {
    box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.7);
    border: 2px dashed #ffc107;
  }

  .key.reversed {
    background: #28a745 !important;
  }

  #currentDisplay {
    margin-top: 15px;
    background: #e9ecef; /* 浅色显示区背景 */
    padding: 10px;
    border: 1px solid #dee2e6; /* 浅色显示区边框 */
    border-radius: 8px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    color: #495057; /* 浅色显示区文字 */
    font-size: 0.9em;
    display: flex;
    flex-wrap: wrap;
    gap: 8px 15px;
    align-items: center;
    line-height: 1.2;
  }

  #currentDisplay span {
    white-space: nowrap;
  }
  #currentDisplay span strong {
      color: #343a40; /* 浅色加粗文字颜色 */
  }

  input.error-input {
    border-color: #e74c3c !important;
    box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.3) !important;
  }

  /* --- 黑暗模式样式 --- */
  @media (prefers-color-scheme: dark) {
    body {
      background-color: #2c2c2c; /* 深色背景 */
      color: #e0e0e0; /* 浅色文字 */
    }

    .left-panel, .right-panel {
      background-color: #3a3a3a; /* 深色卡片背景 */
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); /* 更深的阴影 */
    }

    h2 {
      color: #f0f0f0; /* 深色模式标题颜色 */
    }

    .result-header {
      border-bottom: 1px solid #555; /* 深色分割线 */
    }

    .result-header .section-title,
    .section-title {
      color: #c0c0c0; /* 深色模式标题颜色 */
    }

    .input-section, .controls-section {
      background-color: #444444; /* 深色内部模块背景 */
      border: 1px solid #555555; /* 深色柔和边框 */
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    label {
      color: #c0c0c0; /* 深色标签颜色 */
    }

    textarea,
    input[type="number"],
    .option-group select {
      background-color: #555555; /* 深色输入框/下拉菜单背景 */
      border: 1px solid #666; /* 深色边框 */
      color: #e0e0e0; /* 深色输入框/下拉菜单文字颜色 */
    }

    textarea:focus,
    input[type="number"]:focus,
    .option-group select:focus {
      border-color: #0099ff; /* 深色模式焦点颜色 */
      box-shadow: 0 0 0 4px rgba(0, 153, 255, 0.4);
    }

    #errorDisplay, #centerPointError, #animationsError {
      color: #ff7f7f; /* 调整错误信息颜色 */
    }

    button {
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
    }
    button:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }

    button#renderBtn, button#convertRGB {
      background-color: #007bff; /* 保持蓝色，或调整为更深的蓝色 */
    }

    button#renderBtn:hover, button#convertRGB:hover {
      background-color: #0069d9;
    }

    button#reverseBtn {
      background-color: #5a6268;
    }

    button#reverseBtn.active {
      background-color: #218838; /* 深色模式下的绿色 */
    }

    button#reverseBtn:hover {
      background-color: #4e555b;
    }

    button#copyCodeBtn {
      background-color: #138496;
    }

    button#copyCodeBtn:hover {
      background-color: #0f6c7c;
    }

    button#resetBtn {
        background-color: #c82333;
    }
    button#resetBtn:hover {
        background-color: #bb2d3b;
    }

    .color-label {
      border: 1px solid #666; /* 深色边框 */
    }

    .color-label + span {
      color: #a0a0a0; /* 深色说明文字 */
    }

    .option-group div {
      color: #c0c0c0; /* 深色选项文字 */
    }

    #animationsOptions {
      background-color: #4a4a4a; /* 深色动画选项背景 */
      border: 1px solid #5c5c5c;
    }
    #animationsOptions .animations-row div label {
      color: #c0c0c0; /* 深色动画标签文字 */
    }
    .animation-controls label {
      color: #c0c0c0; /* 深色动画控制标签文字 */
    }

    #keyboard {
      background: #444444; /* 深色键盘背景 */
      border: 1px solid #555555; /* 深色键盘边框 */
      box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.2);
    }

    .key {
      background: #007bff; /* 保持按键蓝色 */
      color: #fff; /* 保持按键文字白色 */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .key:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
    }

    .key.dragging {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.45);
    }

    #currentDisplay {
      background: #4a4a4a; /* 深色显示区背景 */
      border: 1px solid #5c5c5c; /* 深色显示区边框 */
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
      color: #c0c0c0; /* 深色显示区文字 */
    }
    #currentDisplay span strong {
        color: #d0d0d0; /* 深色加粗文字颜色 */
    }

    textarea#rgbResult {
      color: #e0e0e0; /* 深色结果文本颜色 */
      background: #4a4a4a; /* 深色结果文本背景 */
      border: 1px solid #5c5c5c; /* 深色结果文本边框 */
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.15);
    }

    input.error-input {
      border-color: #ff7f7f !important;
      box-shadow: 0 0 0 4px rgba(255, 127, 127, 0.4) !important;
    }
  }

  /* 媒体查询 - 992px 以下变为单列 */
  @media (max-width: 992px) {
    .main-wrapper {
      flex-direction: column;
      gap: 15px;
    }
    body {
      padding: 15px;
    }
    .left-panel, .right-panel {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      border-radius: 10px;
      padding: 20px;
      min-width: unset;
      max-width: unset;
      width: 100%;
    }
    /* 992px 以下改为单列，右侧面板不再需要吸顶和固定高度 */
    .right-panel {
      position: static;
      top: auto;
      height: auto;
      max-height: unset;
      overflow-y: visible;
      margin-top: 0;
    }
    textarea#rgbResult {
        /* 在单列模式下，让文本框恢复为自适应高度，并移除 flex-grow */
        flex-grow: unset;
        min-height: 180px;
        margin-top: 15px;
    }
    h2 {
      font-size: 2em;
      margin-bottom: 25px;
    }
    .section-title {
      font-size: 1.1em;
      margin-bottom: 12px;
    }
    .input-section, .controls-section {
      padding: 15px;
      margin-bottom: 15px;
    }
    #animationsOptions .animations-row div {
      width: calc((100% - 5 * 10px) / 6);
    }
    #currentDisplay {
        font-size: 0.85em;
        gap: 5px 10px;
    }
    .result-header .action-buttons button {
        padding: 6px 10px;
        font-size: 12px;
        margin-left: 8px;
    }
    #keyboard {
        max-width: 100%;
    }
  }

  /* 媒体查询 - 768px 以下进一步调整 */
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    .main-wrapper {
      gap: 10px;
    }
    .left-panel, .right-panel {
      padding: 15px;
      border-radius: 8px;
    }
    h2 {
      font-size: 1.8em;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 1em;
      margin-bottom: 10px;
    }
    .input-section, .controls-section {
      padding: 12px;
      margin-bottom: 12px;
    }
    label {
      font-size: 0.9em;
      margin-bottom: 6px;
    }
    textarea {
      height: 80px;
      font-size: 13px;
      padding: 7px;
    }
    input[type="number"] {
      padding: 6px 10px;
      width: 55px;
      font-size: 13px;
    }
    button {
      padding: 8px 14px;
      font-size: 13px;
      margin-right: 8px;
    }
    .color-label {
      width: 16px;
      height: 16px;
      margin-left: 8px;
    }
    .color-label + span {
      font-size: 0.85em;
      margin-left: 5px;
    }
    .option-group {
      gap: 15px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .option-group div {
      font-size: 0.88em;
    }
    #animationsOptions .animations-row div {
      width: 100%;
    }
    .animation-controls {
      gap: 8px;
      margin-top: 10px;
    }
    .animation-controls button {
      padding: 6px 10px;
      font-size: 0.75em;
    }
    .animation-controls input[type="number"] {
      width: 40px;
      font-size: 12px;
    }
    #currentDisplay {
      margin-top: 15px;
      padding: 10px;
      font-size: 0.8em;
      gap: 5px 8px;
    }
    textarea#rgbResult {
      min-height: 150px;
      margin-top: 12px;
    }
    .result-header .action-buttons button {
        padding: 5px 8px;
        font-size: 11px;
        margin-left: 6px;
    }
  }
</style>
</head>
<body>
<div class="main-wrapper">
  <div class="left-panel">
    <h2>RGB工具</h2>

    <div class="input-section">
      <div class="section-title">KLE数据输入</div>
      <label for="rawData">KLE数据：</label>
      <textarea id="rawData" spellcheck="false">["0,8","1,8","0,9","1,9"],
["5,8","3,8","2,9",{h:2},"6,10"],
["3,9","4,9","5,9"],
["6,7","6,8","6,9",{h:2},"7,10"],
[{w:2},"7,8","7,9"]
</textarea>
      <div id="errorDisplay"></div>
    </div>

    <div class="controls-section">
      <div class="section-title">参数配置</div>
      <label for="ledCurrent">Z字形左上角为第一颗，可拖拽调整顺序。单灯电流 (mA)：
      <input type="number" id="ledCurrent" min="1" max="60" value="36" /></label>

      <div id="animationsOptions">
          <div class="section-title">动画选项 (至少选一)</div>
          <div id="animationsCheckboxes" class="animations-row">
              </div>
          <div class="animation-controls">
            <button id="selectAllAnimationsBtn">全选</button>
            <button id="invertSelectionAnimationsBtn">反选</button>
            <button id="randomSelectAnimationsBtn">随机选择</button>
            <input type="number" id="randomAnimationCount" value="1" min="1">
            <label for="randomAnimationCount">个</label>
          </div>
          <div id="animationsError"></div>
      </div>

      <div class="option-group">
        <div>
          <label for="driverSelect">驱动:</label>
          <select id="driverSelect">
            </select>
        </div>
        <div>
          <label for="flagsSelect">Flags:</label>
          <select id="flagsSelect">
            </select>
        </div>
        <div>
          <label>中心点 (X, Y):</label>
          <input type="number" id="centerX" value="112" min="0" max="224" />
          <input type="number" id="centerY" value="32" min="0" max="64" />
        </div>
        <div id="centerPointError"></div>
        <div>
          <input type="checkbox" id="reactOnKeyupCheckbox" checked>
          <label for="reactOnKeyupCheckbox">按键抬起</label>
        </div>
        <div>
          <label for="satStepsInput">Sat步数:</label>
          <input type="number" id="satStepsInput" value="8" min="1" max="255">
        </div>
        <div>
          <label for="valStepsInput">Val步数:</label>
          <input type="number" id="valStepsInput" value="8" min="1" max="255">
        </div>
        <div>
          <label for="speedStepsInput">速度步数:</label>
          <input type="number" id="speedStepsInput" value="10" min="1" max="255">
        </div>
        <div>
          <label for="maxBrightnessInput">最大亮度:</label>
          <input type="number" id="maxBrightnessInput" value="120" min="0" max="255">
        </div>
        <div>
          <input type="checkbox" id="sleepCheckbox">
          <label for="sleepCheckbox">休眠</label>
        </div>
      </div>

      <div class="controls-buttons">
        <button id="renderBtn">解析</button>
        <button id="convertRGB">转换</button>
        <button id="reverseBtn">顺序</button>
        <span class="color-label" style="background:#007bff;"></span><span>正序</span>
        <span class="color-label" style="background:#28a745;"></span><span>反序</span>
      </div>
    </div>

    <div id="keyboard"></div>
    </div>

  <div class="right-panel">
    <div class="result-header">
        <div class="section-title">结果展示</div>
        <div class="action-buttons">
            <button id="resetBtn">重置</button>
            <button id="copyCodeBtn">复制</button>
        </div>
    </div>
    <div id="currentDisplay"></div> <textarea id="rgbResult" spellcheck="false"></textarea>
  </div>
</div>

<script>
(() => {
  const UNIT = 40, GAP = 5;
  const RGB_MAX_X = 224, RGB_MAX_Y = 64;
  const keyboard = document.getElementById("keyboard");
  const rawDataInput = document.getElementById("rawData");
  const renderBtn = document.getElementById("renderBtn");
  const convertRGBBtn = document.getElementById("convertRGB");
  const ledCurrentInput = document.getElementById("ledCurrent");
  const currentDisplay = document.getElementById("currentDisplay");
  const rgbResult = document.getElementById("rgbResult");
  const resetBtn = document.getElementById("resetBtn");
  const reverseBtn = document.getElementById("reverseBtn");
  const copyCodeBtn = document.getElementById("copyCodeBtn");
  const errorDisplay = document.getElementById("errorDisplay");
  const centerPointError = document.getElementById("centerPointError");
  const animationsError = document.getElementById("animationsError");

  const animationsCheckboxesContainer = document.getElementById("animationsCheckboxes");
  const driverSelect = document.getElementById("driverSelect");
  const flagsSelect = document.getElementById("flagsSelect");
  const centerXInput = document.getElementById("centerX");
  const centerYInput = document.getElementById("centerY");
  const reactOnKeyupCheckbox = document.getElementById("reactOnKeyupCheckbox");

  const selectAllAnimationsBtn = document.getElementById("selectAllAnimationsBtn");
  const invertSelectionAnimationsBtn = document.getElementById("invertSelectionAnimationsBtn");
  const randomSelectAnimationsBtn = document.getElementById("randomSelectAnimationsBtn");
  const randomAnimationCountInput = document.getElementById("randomAnimationCount");

  const satStepsInput = document.getElementById("satStepsInput");
  const valStepsInput = document.getElementById("valStepsInput");
  const speedStepsInput = document.getElementById("speedStepsInput");
  const maxBrightnessInput = document.getElementById("maxBrightnessInput");
  const sleepCheckbox = document.getElementById("sleepCheckbox");


  let keysData = [];
  let originalKeys = [];
  let reversed = false;
  let copyButtonOriginalText = copyCodeBtn.textContent;
  let copyButtonOriginalBg = getComputedStyle(copyCodeBtn).backgroundColor;

  const allAnimations = [
    "alphas_mods", "breathing", "band_sat", "band_val", "band_pinwheel_sat",
    "band_pinwheel_val", "band_spiral_sat", "band_spiral_val", "colorband_pinwheel_sat",
    "colorband_pinwheel_val", "colorband_sat", "colorband_spiral_sat", "colorband_spiral_val",
    "colorband_val", "cycle_all", "cycle_left_right", "cycle_up_down", "cycle_out_in_dual",
    "cycle_pinwheel", "cycle_spiral", "digital_rain", "dual_beacon", "flower_blooming",
    "gradient_up_down", "gradient_left_right", "hue_breathing", "hue_pendulum", "hue_wave",
    "jellybean_raindrops", "multi_splash", "openrgb_direct", "pixel_rain", "pixel_flow",
    "pixel_fractal", "rainbow_beacon", "rainbow_pinwheels", "raindrops", "rainbow_moving_chevron",
    "river_flow", "solid_reactive_simple", "solid_reactive_wide", "solid_reactive_multiwide",
    "solid_reactive_cross", "solid_reactive_multicross", "solid_reactive_nexus",
    "solid_reactive_multinexus", "solid_splash", "solid_multi_splash", "splash", "starlight",
    "starlight_dual_hue", "starlight_dual_sat", "signal_rgb_anim", "typing_heatmap", "vial_rgb"
  ];

  const allDrivers = [
    "APA102", "AW20216S", "IS31FL3218", "IS31FL3236", "IS31FL3729", "IS31FL3731",
    "IS31FL3733", "IS31FL3736", "IS31FL3737", "IS31FL3741", "IS31FL3742A",
    "IS31FL3743A", "IS31FL3745", "IS31FL3746A", "SNLED27351", "WS2812"
  ];

  const allFlags = ["0", "1", "2", "4", "8", "FF"];

  function clearError() {
    rawDataInput.classList.remove('error');
    errorDisplay.textContent = '';
  }

  function showParsingError(message) {
    rawDataInput.classList.add('error');
    errorDisplay.textContent = '解析错误: ' + message;
    rawDataInput.style.animation = 'none';
    rawDataInput.offsetHeight;
    rawDataInput.style.animation = '';
  }

  function clearCenterPointError() {
    centerPointError.textContent = '';
    centerXInput.classList.remove('error-input');
    centerYInput.classList.remove('error-input');
  }

  function showCenterPointError(message) {
    centerPointError.textContent = '中心点错误: ' + message;
    centerXInput.classList.add('error-input');
    centerYInput.classList.add('error-input');
  }

  function clearAnimationsError() {
    animationsError.textContent = '';
  }

  function showAnimationsError(message) {
    animationsError.textContent = message;
  }

  function generateAnimationsCheckboxes() {
    animationsCheckboxesContainer.innerHTML = '';
    allAnimations.forEach(anim => {
      const div = document.createElement('div');
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = `anim_${anim}`;
      input.name = 'animation';
      input.value = anim;
      input.addEventListener('change', convertToRGBPositions);

      const label = document.createElement('label');
      label.htmlFor = `anim_${anim}`;
      label.textContent = anim;

      div.appendChild(input);
      div.appendChild(label);
      animationsCheckboxesContainer.appendChild(div);
    });
    randomAnimationCountInput.max = allAnimations.length;
  }

  function generateDriversOptions() {
    driverSelect.innerHTML = '';
    allDrivers.forEach(driver => {
      const option = document.createElement('option');
      option.value = driver.toLowerCase();
      option.textContent = driver;
      driverSelect.appendChild(option);
    });
    driverSelect.value = "ws2812";
  }

  function generateFlagsOptions() {
    flagsSelect.innerHTML = '';
    allFlags.forEach(flag => {
      const option = document.createElement('option');
      option.value = flag;
      option.textContent = flag;
      flagsSelect.appendChild(option);
    });
    flagsSelect.value = "4";
  }

  function parseInput(text) {
    const trimmed = text.trim();
    if (trimmed.startsWith('[[') && trimmed.endsWith(']')) {
      return Function('"use strict";return (' + trimmed + ')')();
    } else {
      const lines = trimmed.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      for (let i = 0; i < lines.length - 1; i++) {
        if (!lines[i].endsWith(',')) lines[i] += ',';
      }
      const wrapped = '[' + lines.join('\n') + ']';
      return Function('"use strict";return (' + wrapped + ')')();
    }
  }

  function computeKeys(data) {
    const result = [];
    let currentY = 0, accumulatedYOffset = 0;

    for (let rowIndex = 0; rowIndex < data.length; rowIndex++) {
      const row = data[rowIndex];
      let xPos = 0;
      let nextW = 1, nextH = 1, nextXOffset = 0;
      let rowYOffset = 0;

      for (let item of row) {
        if (typeof item === "object" && "y" in item) {
          rowYOffset = item.y;
          break;
        }
      }

      const rowY = currentY + accumulatedYOffset + rowYOffset;

      for (let i = 0; i < row.length; i++) {
        const item = row[i];

        if (typeof item === "object") {
          const allowed = ["w", "h", "x", "y"];
          const filtered = Object.fromEntries(
            Object.entries(item).filter(([k]) => allowed.includes(k))
          );
          if (Object.keys(filtered).length === 0) continue;
          if ("w" in filtered) nextW = filtered.w;
          if ("h" in filtered) nextH = filtered.h;
          if ("x" in filtered) nextXOffset = filtered.x;
          if ("y" in filtered) rowYOffset = filtered.y;
          continue;
        }

        const key = {
          x: xPos + nextXOffset,
          y: rowY,
          w: nextW,
          h: nextH,
          label: typeof item === "string" ? item : "",
          rowIndex,
          keyIndex: i
        };

        if (!key.label) key.label = `${key.x},${key.y}`;

        result.push(key);
        xPos = key.x + key.w;
        nextW = 1; nextH = 1; nextXOffset = 0;
      }

      accumulatedYOffset += rowYOffset;
      currentY += 1;
    }
    return result;
  }

  function renderKeys(keys) {
    keyboard.innerHTML = "";

    let maxKeyX = 0;
    if (keys.length > 0) {
      maxKeyX = Math.max(...keys.map(k => k.x + k.w));
    }
    const contentWidth = maxKeyX * (UNIT + GAP);
    keyboard.style.width = `${contentWidth}px`;
    keyboard.style.minWidth = '100%';


    keys.forEach((key, idx) => {
      const keyWidth = key.w * UNIT + (key.w - 1) * GAP;
      const keyHeight = key.h * UNIT + (key.h - 1) * GAP;

      const div = document.createElement("div");
      div.className = "key";
      div.textContent = key.label;
      div.style.left = (key.x * (UNIT + GAP)) + "px";
      div.style.top = (key.y * (UNIT + GAP)) + "px";
      div.style.width = keyWidth + "px";
      div.style.height = keyHeight + "px";

      div.draggable = true;
      div.dataset.index = idx;

      if (reversed) {
        div.classList.add("reversed");
      } else {
        div.classList.remove("reversed");
      }

      div.ondragstart = e => {
        e.dataTransfer.setData("text/plain", idx);
        div.classList.add("dragging");
      };
      div.ondragend = () => div.classList.remove("dragging");
      div.ondragover = e => { e.preventDefault(); div.classList.add("dragover"); };
      div.ondragleave = () => div.classList.remove("dragover");
      div.ondrop = e => {
        e.preventDefault();
        div.classList.remove("dragover");
        const fromIdx = parseInt(e.dataTransfer.getData("text/plain"));
        const toIdx = idx;
        if (fromIdx !== toIdx) {
          [keysData[fromIdx].label, keysData[toIdx].label] = [keysData[toIdx].label, keysData[fromIdx].label];
          renderKeys(keysData);
          updateCurrentDisplay();
          convertToRGBPositions();
        }
      };

      keyboard.appendChild(div);
    });

    const maxY = Math.max(...keys.map(k => k.y + (k.h || 1)));
    const totalHeight = (UNIT + GAP) * maxY;
    keyboard.style.height = totalHeight + "px";
  }

  function updateCurrentDisplay() {
    const totalLeds = keysData.length;
    let currentPerLed = parseFloat(ledCurrentInput.value);
    if (isNaN(currentPerLed) || currentPerLed < 1) currentPerLed = 36;
    if (currentPerLed > 60) currentPerLed = 60;
    ledCurrentInput.value = currentPerLed;

    const totalCurrent_mA = totalLeds * currentPerLed;
    currentDisplay.innerHTML = `
      <span><strong>灯珠数:</strong> ${totalLeds}</span>
      <span><strong>单灯电流:</strong> ${currentPerLed} mA</span>
      <span><strong>总电流约:</strong> ${totalCurrent_mA} mA (${(totalCurrent_mA / 1000).toFixed(2)} A)</span>
    `;
  }

  function convertToRGBPositions() {
    if (!keysData.length) {
      rgbResult.value = "";
      return;
    }

    const maxX = Math.max(...keysData.map(k => k.x + ((k.w || 1) / 2 - 0.5)));
    const maxY = Math.max(...keysData.map(k => k.y + ((k.h || 1) / 2 - 0.5)));

    const selectedFlags = flagsSelect.value;

    let layoutArray = keysData.map(k => {
      const adjX = k.x + ((k.w || 1) / 2 - 0.5);
      const adjY = k.y + ((k.h || 1) / 2 - 0.5);

      const rgbX = maxX > 0 ? Math.round((adjX / maxX) * RGB_MAX_X) : 0;
      const rgbY = maxY > 0 ? Math.round((adjY / maxY) * RGB_MAX_Y) : 0;

      const [mx, my] = k.label.split(',').map(Number);
      return {
        matrix: [mx, my],
        x: rgbX,
        y: rgbY,
        flags: selectedFlags === "FF" ? "0xFF" : parseInt(selectedFlags)
      };
    });

    if (reversed) {
      layoutArray.reverse();
    }

    const animations = {};
    let anyAnimationSelected = false;
    document.querySelectorAll('#animationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      if (checkbox.checked) {
        animations[checkbox.value] = true;
        anyAnimationSelected = true;
      }
    });

    if (!anyAnimationSelected) {
      showAnimationsError("至少选一个动画。");
      rgbResult.value = "// 请选择至少一个动画选项。";
      return;
    } else {
      clearAnimationsError();
    }
    
    const centerX = parseInt(centerXInput.value);
    const centerY = parseInt(centerYInput.value);
    
    if (isNaN(centerX) || isNaN(centerY)) {
        showCenterPointError("中心点X和Y必须是有效数字。");
        rgbResult.value = "// 中心点X和Y必须是有效数字。";
        return;
    } else if (centerX < 0 || centerX > RGB_MAX_X || centerY < 0 || centerY > RGB_MAX_Y) {
        showCenterPointError(`中心点X (0-${RGB_MAX_X}) 和 Y (0-${RGB_MAX_Y}) 必须在指定范围。`);
        rgbResult.value = `// 中心点X (${centerX}) 或 Y (${centerY}) 超出允许范围。\n// X范围: 0-${RGB_MAX_X}, Y范围: 0-${RGB_MAX_Y}`;
        return;
    }
    else {
        clearCenterPointError();
    }

    const layoutString = layoutArray.map(item => {
        if (item.flags === "0xFF") {
            const tempItem = {...item};
            tempItem.flags = "0xFF";
            return JSON.stringify(tempItem).replace(/"0xFF"/, '0xFF');
        }
        return JSON.stringify(item);
    }).join(',\n    ');

    let finalOutput = '';

    finalOutput += `  "animations": {\n`;
    const animationEntries = Object.entries(animations).map(([key, value]) => `    "${key}": ${value}`).join(',\n');
    finalOutput += animationEntries;
    finalOutput += `\n  },\n`;

    finalOutput += `  "layout": [\n    ${layoutString}\n  ],\n`;

    finalOutput += `  "led_count": ${keysData.length},\n`;
    finalOutput += `  "driver": "${driverSelect.value}",\n`;
    finalOutput += `  "center_point": [ ${centerX}, ${centerY} ],\n`;
    finalOutput += `  "react_on_keyup": ${reactOnKeyupCheckbox.checked},\n`;

    finalOutput += `  "sat_steps": ${parseInt(satStepsInput.value) || 8},\n`;
    finalOutput += `  "val_steps": ${parseInt(valStepsInput.value) || 8},\n`;
    finalOutput += `  "speed_steps": ${parseInt(speedStepsInput.value) || 10},\n`;
    finalOutput += `  "max_brightness": ${parseInt(maxBrightnessInput.value) || 120},\n`;
    finalOutput += `  "sleep": ${sleepCheckbox.checked}`;

    const commentLine = "// 请在features内加上\"rgb_matrix\": true或rules.mk加上RGB_MATRIX_ENABLE = yes开启rgb矩阵灯效\n";
    rgbResult.value = `${commentLine}rgb_matrix: {\n${finalOutput}\n}`;
  }

  renderBtn.onclick = () => {
    const raw = rawDataInput.value;
    try {
      const data = parseInput(raw);
      keysData = computeKeys(data);
      originalKeys = JSON.parse(JSON.stringify(keysData));
      reversed = false;
      renderKeys(keysData);
      updateCurrentDisplay();
      convertToRGBPositions();
      reverseBtn.classList.remove('active');
      clearError();
    } catch (e) {
      showParsingError(e.message);
      console.error("解析错误:", e);
    }
  };

  convertRGBBtn.onclick = convertToRGBPositions;

  resetBtn.onclick = () => {
    keysData = JSON.parse(JSON.stringify(originalKeys));
    reversed = false;
    renderKeys(keysData);
    updateCurrentDisplay();
    document.querySelectorAll('#animationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    if (allAnimations.length > 0) {
      document.getElementById(`anim_${allAnimations[0]}`).checked = true;
    }
    clearAnimationsError();

    driverSelect.value = "ws2812";
    flagsSelect.value = "4";
    centerXInput.value = "112";
    centerYInput.value = "32";
    reactOnKeyupCheckbox.checked = true;
    randomAnimationCountInput.value = "1";

    satStepsInput.value = "8";
    valStepsInput.value = "8";
    speedStepsInput.value = "10";
    maxBrightnessInput.value = "120";
    sleepCheckbox.checked = false;

    convertToRGBPositions();
  };

  reverseBtn.onclick = () => {
    reversed = !reversed;
    renderKeys(keysData);
    convertToRGBPositions();
    reverseBtn.classList.toggle('active', reversed);
  };

  copyCodeBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(rgbResult.value);
      copyCodeBtn.textContent = '已复制！';
      copyCodeBtn.style.backgroundColor = '#28a745';
      setTimeout(() => {
        copyCodeBtn.textContent = copyButtonOriginalText;
        copyCodeBtn.style.backgroundColor = copyButtonOriginalBg;
      }, 2000);
    } catch (err) {
      console.error('复制失败:', err);
      copyCodeBtn.textContent = '复制失败';
      copyCodeBtn.style.backgroundColor = '#dc3545';
      setTimeout(() => {
        copyCodeBtn.textContent = copyButtonOriginalText;
        copyCodeBtn.style.backgroundColor = copyButtonOriginalBg;
      }, 2000);
    }
  };

  rawDataInput.addEventListener('input', () => {
    try {
        parseInput(rawDataInput.value);
        renderBtn.click();
        clearError();
    } catch (e) {
        showParsingError(e.message);
    }
  });

  ledCurrentInput.addEventListener('input', () => {
    updateCurrentDisplay();
  });

  maxBrightnessInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 0) {
      this.value = 0;
    } else if (value > 255) {
      this.value = 255;
    }
    convertToRGBPositions();
  });

  driverSelect.addEventListener('change', convertToRGBPositions);
  flagsSelect.addEventListener('change', convertToRGBPositions);
  centerXInput.addEventListener('input', convertToRGBPositions);
  centerYInput.addEventListener('input', convertToRGBPositions);
  reactOnKeyupCheckbox.addEventListener('change', convertToRGBPositions);

  satStepsInput.addEventListener('input', convertToRGBPositions);
  valStepsInput.addEventListener('input', convertToRGBPositions);
  speedStepsInput.addEventListener('input', convertToRGBPositions);
  sleepCheckbox.addEventListener('change', convertToRGBPositions);


  selectAllAnimationsBtn.onclick = () => {
    document.querySelectorAll('#animationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = true;
    });
    convertToRGBPositions();
  };

  invertSelectionAnimationsBtn.onclick = () => {
    document.querySelectorAll('#animationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = !checkbox.checked;
    });
    convertToRGBPositions();
  };

  randomSelectAnimationsBtn.onclick = () => {
    const count = parseInt(randomAnimationCountInput.value);
    if (isNaN(count) || count < 1) {
        showAnimationsError("随机选择数量必须是有效数字且至少为1。");
        return;
    }
    if (count > allAnimations.length) {
        showAnimationsError(`随机选择数量不能超过动画总数 (${allAnimations.length})。`);
        return;
    }

    document.querySelectorAll('#animationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });

    const shuffledAnimations = [...allAnimations].sort(() => 0.5 - Math.random());
    for (let i = 0; i < count; i++) {
        const animName = shuffledAnimations[i];
        const checkbox = document.getElementById(`anim_${animName}`);
        if (checkbox) {
            checkbox.checked = true;
        }
    }
    convertToRGBPositions();
  };

  generateAnimationsCheckboxes();
  generateDriversOptions();
  generateFlagsOptions();

  if (allAnimations.length > 0) {
    document.getElementById(`anim_${allAnimations[0]}`).checked = true;
  }
  renderBtn.click();
})();
</script>
<script>
        // Disable right-click menu and F12/Ctrl+Shift+I/Ctrl+U
        document.addEventListener('contextmenu',function(e){e.preventDefault();});
        document.onkeydown = function(e) {
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73) || (e.ctrlKey && e.keyCode == 85)) {
                return false;
            }
            if (e.keyCode == 116) { // Disable F5 (refresh)
                e.preventDefault();
            }
        };
    </script>
</body>
</html>