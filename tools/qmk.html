<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<link rel="icon" type="image/png" sizes="310x310" href="./logo.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QMK Config 生成器</title>
<style>
  body {
    font-family: "Segoe UI", "Helvetica Neue", sans-serif;
    background-color: #eef2f7;
    color: #333;
    line-height: 1.5;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    box-sizing: border-box;
  }

  .main-wrapper {
    display: flex;
    max-width: 1400px;
    width: 100%;
    gap: 20px;
  }

  .left-panel, .right-panel {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    padding: 25px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }

  .left-panel {
    flex: 1;
    max-width: 900px;
    width: 100%;
    position: relative;
  }

  .right-panel {
    flex: 0 0 auto;
    max-width: 500px;
    width: 100%;
    position: sticky;
    top: 20px;
    height: fit-content;
    min-width: 350px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
  }

  h2 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 30px;
    font-size: 2.5em;
    font-weight: 700;
  }

  .section-title {
    font-size: 1.2em;
    font-weight: 600;
    color: #444;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e0e0e0;
  }

  .input-section, .qmk-option-group-wrapper, .encoder-section, .rgblight-section, .ws2812-pin-section, .indicators-section, .bootmagic-section {
    margin-bottom: 20px;
    padding: 20px;
    background-color: #fdfdfd;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.04);
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #444;
    font-size: 0.95em;
  }
  .input-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
  }
  .input-group label {
      margin-bottom: 0;
      margin-right: 10px;
      white-space: nowrap;
      flex-shrink: 0;
  }
  .input-group input[type="text"],
  .input-group input[type="number"] {
      flex-grow: 1;
      max-width: unset;
      min-width: 80px;
  }

  textarea {
    width: calc(100% - 18px);
    height: 100px;
    font-family: 'Roboto Mono', monospace;
    font-size: 14px;
    padding: 9px;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    resize: vertical;
    background-color: #fff;
    color: #333;
  }

  textarea:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
  }

  #errorDisplay, #centerPointError, #rgbMatrixAnimationsError, #pinError, #matrixPinError, #usbError, #qmkError, #encoderError, #rgblightAnimationsError, #rgblightError, #indicatorError, #bootmagicError {
    color: #e74c3c;
    font-size: 0.9em;
    margin-top: 8px;
    min-height: 1.5em;
    font-weight: 600;
  }

  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input[type="number"] {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    margin-right: 10px;
    width: 65px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background-color: #fff;
    color: #333;
  }
  
  input[type="number"].narrow-input {
    width: 50px;
    padding: 8px 8px;
  }

  input[type="text"],
  input[type="text"].pin-input,
  input[type="text"].matrix-pin-input {
      padding: 8px 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      margin-left: 6px;
      width: 100px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background-color: #fff;
      color: #333;
  }
  input[type="text"].small-input {
      width: 70px;
      flex-grow: 0;
  }


  input[type="number"]:focus,
  input[type="text"]:focus,
  input[type="text"].pin-input:focus,
  input[type="text"].matrix-pin-input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
  }

  button {
    padding: 10px 18px;
    margin-right: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    outline: none;
  }

  button:active {
    transform: translateY(1px);
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.15);
  }

  button#convertRGB {
    background-color: #007bff;
    color: #fff;
  }

  button#convertRGB:hover {
    background-color: #0069d9;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  button#reverseBtn {
    background-color: #6c757d;
    color: #fff;
  }

  button#reverseBtn.active {
    background-color: #28a745;
  }

  button#reverseBtn:hover {
    background-color: #5a6268;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  button#copyCodeBtn {
    background-color: #17a2b8;
    color: #fff;
  }

  button#copyCodeBtn:hover {
    background-color: #138496;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  button#downloadCodeBtn {
      background-color: #28a745;
      color: #fff;
      margin-right: 0;
  }

  button#downloadCodeBtn:hover {
      background-color: #218838;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }


  button#resetBtn {
      background-color: #dc3545;
      color: #fff;
  }
  button#resetBtn:hover {
      background-color: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .option-group {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 15px;
    margin-bottom: 15px;
    align-items: center;
  }

  .option-group div {
    display: flex;
    align-items: center;
    font-size: 0.92em;
    color: #555;
  }
  
  .driver-option-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .matrix-pin-option-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 10px;
      margin-bottom: 10px;
  }
  .matrix-pin-option-row label {
      margin-bottom: 0;
      margin-right: 5px;
  }
  .matrix-pin-option-row select {
      margin-left: 0;
  }


  .pin-input-row {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    margin-top: 5px;
  }

  .pin-input-group {
    display: flex;
    align-items: center;
    gap: 0;
    margin-bottom: 0;
  }
  .pin-input-group label {
      margin-bottom: 0;
      flex-shrink: 0;
  }
  .pin-input-group input {
      flex-grow: 0;
      max-width: 50px;
  }
  .pin-input-group button {
      padding: 5px 8px;
      font-size: 1em;
      margin-right: 0;
      box-shadow: none;
      background-color: #007bff;
      color: #fff;
  }
  .pin-input-group button:hover {
      background-color: #0069d9;
      transform: none;
      box-shadow: none;
  }
  .pin-input-group button.remove-btn {
      background-color: #dc3545;
  }
  .pin-input-group button.remove-btn:hover {
      background-color: #c82333;
  }


  .option-group input[type="checkbox"] {
    margin-right: 8px;
    transform: scale(1.2);
  }

  .option-group select,
  .qmk-option-group select {
    padding: 7px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    margin-left: 6px;
    background-color: #fff;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease;
    color: #333;
  }

  .option-group select:focus,
  .qmk-option-group select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
  }

  #rgbMatrixAnimationsOptions, #rgblightAnimationsOptions {
    margin-top: 15px;
    margin-bottom: 20px;
    background-color: #fbfbfb;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
  }
  #rgbMatrixAnimationsOptions .animations-row, #rgblightAnimationsOptions .animations-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }
  #rgbMatrixAnimationsOptions .animations-row div, #rgblightAnimationsOptions .animations-row div {
    display: flex;
    align-items: center;
    width: calc((100% - 7 * 10px) / 8);
    box-sizing: border-box;
    min-width: 100px;
  }

  #rgbMatrixAnimationsOptions .animations-row div label, #rgblightAnimationsOptions .animations-row div label {
    display: inline-block;
    margin-bottom: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1;
    cursor: pointer;
    font-size: 0.9em;
    color: #555;
  }

  .animation-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
    align-items: center;
  }
  .animation-controls button {
    padding: 8px 14px;
    font-size: 0.85em;
    margin-right: 0;
  }
  .animation-controls input[type="number"] {
    width: 50px;
    margin-right: 0;
  }
  .animation-controls label {
    margin-bottom: 0;
    margin-left: 6px;
    font-size: 0.9em;
    color: #555;
  }

  .feature-option-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
  }
  .feature-option {
      display: flex;
      align-items: center;
      gap: 5px;
  }
  .feature-option input[type="checkbox"] {
      margin-right: 0;
  }
  .feature-option label {
      margin-bottom: 0;
      white-space: nowrap;
  }
  .feature-option select {
      width: 80px;
      margin-left: 0;
  }

  .qmk-option-group-wrapper {
      margin-top: 20px;
      margin-bottom: 20px;
      padding: 20px;
      background-color: #fdfdfd;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.04);
  }
  .qmk-option-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
  }
  .qmk-option-group > div {
      display: flex;
      align-items: center;
      white-space: nowrap;
  }
  .qmk-option-group label {
      margin-bottom: 0;
      margin-right: 5px;
      font-size: 0.95em;
  }
  .qmk-option-group input[type="checkbox"] {
      margin-right: 5px;
      transform: scale(1.1);
  }
  .qmk-locking-options {
      display: flex;
      align-items: center;
      gap: 10px;
  }
  .bootmagic-matrix-input {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
      margin-bottom: 10px;
  }
  .bootmagic-matrix-input label {
      margin-bottom: 0;
      white-space: nowrap;
      margin-right: 5px;
  }
  .bootmagic-matrix-input input {
      width: 40px;
      margin-right: 5px;
  }


  .encoder-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      padding-bottom: 5px;
      border-bottom: 1px dashed #eee;
  }
  .encoder-group:last-of-type {
      border-bottom: none;
  }
  .encoder-group label {
      margin-bottom: 0;
      margin-right: 5px;
      font-size: 0.92em;
      flex-shrink: 0;
  }
  .encoder-group input[type="text"],
  .encoder-group input[type="number"] {
      flex-grow: 0;
      width: 60px;
      min-width: 50px;
      margin-right: 0;
  }
  .encoder-group input[type="number"] {
      width: 45px;
  }
  .encoder-group .add-remove-buttons {
      display: flex;
      gap: 5px;
      margin-left: 10px;
  }
  .encoder-group .add-remove-buttons button {
      padding: 5px 8px;
      font-size: 1em;
      margin-right: 0;
      box-shadow: none;
  }
  .encoder-group .add-remove-buttons .add-btn {
      background-color: #007bff;
      color: #fff;
  }
  .encoder-group .add-remove-buttons .add-btn:hover {
      background-color: #0069d9;
  }
  .encoder-group .add-remove-buttons .remove-btn {
      background-color: #dc3545;
      color: #fff;
  }
  .encoder-group .add-remove-buttons .remove-btn:hover {
      background-color: #c82333;
  }

  .rgblight-config-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 15px;
      margin-bottom: 15px;
      align-items: center;
  }
  .rgblight-config-row label {
      margin-bottom: 0;
      margin-right: 5px;
  }
  .inline-input-group {
      display: flex;
      align-items: center;
      gap: 5px;
  }
  .inline-input-group label {
      margin-bottom: 0;
      white-space: nowrap;
      font-size: 0.95em;
  }
  .inline-input-group input[type="number"] {
      margin-right: 0;
      width: 60px;
  }

  .ws2812-pin-section {
      display: flex;
      align-items: center;
      gap: 10px;
  }
  .ws2812-pin-section label {
      margin-bottom: 0;
      white-space: nowrap;
  }
  .ws2812-pin-section input {
      flex-grow: 0;
      width: 70px;
  }

  .indicators-section .input-group {
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
  }

  .indicators-section .input-group label {
      margin-bottom: 0;
      flex-shrink: 0;
  }
  .indicators-section .input-group input[type="text"] {
      width: 60px;
      margin-left: 0;
      margin-right: 5px;
  }
  .indicators-section .input-group #onStateButton {
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      color: white;
      text-align: center;
      min-width: 60px;
      margin-right: 5px;
      transition: background-color 0.3s ease;
  }
  .indicators-section .input-group #onStateButton.high {
      background-color: #007bff; /* Blue */
  }
  .indicators-section .input-group #onStateButton.low {
      background-color: #6c757d; /* Gray */
  }
  .indicators-section .input-group #onStateLabel {
      font-weight: 500;
      margin-left: -5px;
      font-size: 0.95em;
      color: #555;
  }


  #keyboard {
    margin-top: 25px;
    position: relative;
    background: #fcfcfc;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.06);
    min-height: 100px;
    transition: height 0.3s ease;
    overflow-x: auto;
    max-width: 800px;
    padding-bottom: 10px;
  }

  .key {
    position: absolute;
    background: #007bff;
    color: #fff;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    font-weight: 500;
    border-radius: 4px;
    user-select: none;
    cursor: grab;
    transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
  }

  .key:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  }

  .key.dragging {
    opacity: 0.7;
    cursor: grabbing;
    transform: scale(1.08);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.35);
    z-index: 100;
  }

  .key.dragover {
    box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.7);
    border: 2px dashed #ffc107;
  }

  .key.reversed {
    background: #28a745 !important;
  }

  textarea#rgbResult {
    flex-grow: 1;
    margin-top: 15px;
    min-height: 200px;
    max-height: unset;
    color: #212529;
    background: #f8faff;
    border: 1px solid #dbe2ed;
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.04);
  }

  input.error-input {
    border-color: #e74c3c !important;
    box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.3) !important;
  }

  @media (prefers-color-scheme: dark) {
    body {
      background-color: #2c2c2c;
      color: #e0e0e0;
    }

    .left-panel, .right-panel {
      background-color: #3a3a3a;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    h2 {
      color: #f0f0f0;
    }

    .result-header {
      border-bottom: 1px solid #555;
    }

    .result-header .section-title,
    .section-title {
      color: #c0c0c0;
    }

    .input-section, .qmk-option-group-wrapper, .encoder-section, .rgblight-section, .ws2812-pin-section, .indicators-section, .bootmagic-section {
      background-color: #444444;
      border: 1px solid #555555;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    label {
      color: #c0c0c0;
    }

    textarea,
    input[type="number"],
    input[type="text"],
    input[type="text"].pin-input,
    input[type="text"].matrix-pin-input,
    .option-group select,
    .qmk-option-group select {
      background-color: #555555;
      border: 1px solid #666;
      color: #e0e0e0;
    }

    textarea:focus,
    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="text"].pin-input:focus,
    input[type="text"].matrix-pin-input:focus,
    .option-group select:focus,
    .qmk-option-group select:focus {
      border-color: #0099ff;
      box-shadow: 0 0 0 4px rgba(0, 153, 255, 0.4);
    }

    #errorDisplay, #centerPointError, #rgbMatrixAnimationsError, #pinError, #matrixPinError, #usbError, #qmkError, #encoderError, #rgblightAnimationsError, #rgblightError, #indicatorError, #bootmagicError {
      color: #ff7f7f;
    }

    button {
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
    }
    button:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }

    button#convertRGB {
      background-color: #007bff;
    }

    button#convertRGB:hover {
      background-color: #0069d9;
    }

    button#reverseBtn {
      background-color: #5a6268;
    }

    button#reverseBtn.active {
      background-color: #218838;
    }

    button#reverseBtn:hover {
      background-color: #4e555b;
    }

    button#copyCodeBtn {
      background-color: #138496;
    }

    button#copyCodeBtn:hover {
      background-color: #107281;
    }

    button#downloadCodeBtn {
        background-color: #218838;
    }
    button#downloadCodeBtn:hover {
        background-color: #1c7430;
    }

    button#resetBtn {
        background-color: #c82333;
    }
    button#resetBtn:hover {
        background-color: #bb2d3b;
    }

    .option-group div {
      color: #c0c0c0;
    }
    .pin-input-group button {
        background-color: #007bff;
        color: #fff;
    }
    .pin-input-group button:hover {
        background-color: #0069d9;
    }
    .pin-input-group button.remove-btn {
        background-color: #bb2d3b;
    }
    .pin-input-group button.remove-btn:hover {
        background-color: #c82333;
    }
    .feature-option label {
        color: #c0c0c0;
    }
    .qmk-option-group label {
        color: #c0c0c0;
    }


    #rgbMatrixAnimationsOptions, #rgblightAnimationsOptions {
      background-color: #4a4a4a;
      border: 1px solid #5c5c5c;
    }
    #rgbMatrixAnimationsOptions .animations-row div label, #rgblightAnimationsOptions .animations-row div label {
      color: #c0c0c0;
    }
    .animation-controls label {
      color: #c0c0c0;
    }

    .encoder-group {
        border-bottom: 1px dashed #666;
    }
    .encoder-group label {
        color: #c0c0c0;
    }
    .encoder-group .add-remove-buttons .add-btn {
        background-color: #007bff;
        color: #fff;
    }
    .encoder-group .add-remove-buttons .add-btn:hover {
        background-color: #0069d9;
    }
    .encoder-group .add-remove-buttons .remove-btn {
        background-color: #bb2d3b;
        color: #fff;
    }
    .encoder-group .add-remove-buttons .remove-btn:hover {
        background-color: #c82333;
    }
    .rgblight-config-row label {
        color: #c0c0c0;
    }
    .inline-input-group label {
        color: #c0c0c0;
    }
    .ws2812-pin-section label {
        color: #c0c0c0;
    }
    .indicators-section label {
        color: #c0c0c0;
    }
    .indicators-section .input-group #onStateButton.high {
        background-color: #007bff; /* Blue */
    }
    .indicators-section .input-group #onStateButton.low {
        background-color: #6c757d; /* Gray */
    }
    .bootmagic-matrix-input label, .bootmagic-section label {
        color: #c0c0c0;
    }

    #keyboard {
      background: #444444;
      border: 1px solid #555555;
      box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.2);
    }

    .key {
      background: #007bff;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .key:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
    }

    .key.dragging {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.45);
    }

    textarea#rgbResult {
      color: #e0e0e0;
      background: #4a4a4a;
      border: 1px solid #5c5c5c;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.15);
    }

    input.error-input {
      border-color: #ff7f7f !important;
      box-shadow: 0 0 0 4px rgba(255, 127, 127, 0.4) !important;
    }
  }

  @media (max-width: 992px) {
    .main-wrapper {
      flex-direction: column;
      gap: 15px;
    }
    body {
      padding: 15px;
    }
    .left-panel, .right-panel {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      border-radius: 10px;
      padding: 20px;
      min-width: unset;
      max-width: unset;
      width: 100%;
    }
    .right-panel {
      position: static;
      top: auto;
      height: auto;
      max-height: unset;
      overflow-y: visible;
      margin-top: 0;
    }
    h2 {
      font-size: 2em;
      margin-bottom: 25px;
    }
    .section-title {
      font-size: 1.1em;
      margin-bottom: 12px;
    }
    .input-section, .qmk-option-group-wrapper, .encoder-section, .rgblight-section, .ws2812-pin-section, .indicators-section, .bootmagic-section {
      padding: 15px;
      margin-bottom: 15px;
    }
    textarea#rgbResult {
      min-height: 180px;
      margin-top: 15px;
    }
    #rgbMatrixAnimationsOptions .animations-row div, #rgblightAnimationsOptions .animations-row div {
      width: calc((100% - 5 * 10px) / 6);
    }
    .result-header .action-buttons button {
        padding: 6px 10px;
        font-size: 12px;
        margin-left: 8px;
    }
    #keyboard {
        max-width: 100%;
    }
    .qmk-option-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    .qmk-option-group > div {
        flex-wrap: wrap;
    }
  }

  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    .main-wrapper {
      gap: 10px;
    }
    .left-panel, .right-panel {
      padding: 15px;
      border-radius: 8px;
    }
    h2 {
      font-size: 1.8em;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 1em;
      margin-bottom: 10px;
    }
    .input-section, .qmk-option-group-wrapper, .encoder-section, .rgblight-section, .ws2812-pin-section, .indicators-section, .bootmagic-section {
      padding: 12px;
      margin-bottom: 12px;
    }
    label {
      font-size: 0.9em;
      margin-bottom: 6px;
    }
    textarea {
      height: 80px;
      font-size: 13px;
      padding: 7px;
    }
    input[type="number"], input[type="text"].pin-input, input[type="text"].matrix-pin-input {
      padding: 6px 10px;
      width: 45px;
      font-size: 13px;
    }
    button {
      padding: 8px 14px;
      font-size: 13px;
      margin-right: 8px;
    }
    .option-group {
      gap: 15px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .option-group div {
      font-size: 0.88em;
    }
    #rgbMatrixAnimationsOptions .animations-row div, #rgblightAnimationsOptions .animations-row div {
      width: 100%;
    }
    .animation-controls {
      gap: 8px;
      margin-top: 10px;
    }
    .animation-controls button {
      padding: 6px 10px;
      font-size: 0.75em;
    }
    .animation-controls input[type="number"] {
      width: 40px;
      font-size: 12px;
    }
    textarea#rgbResult {
      min-height: 150px;
      margin-top: 12px;
    }
    .result-header .action-buttons button {
        padding: 5px 8px;
        font-size: 11px;
        margin-left: 6px;
    }
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
<div class="main-wrapper">
  <div class="left-panel">
    <h2>QMK Config 生成器</h2>

    <div class="input-section">
      <div class="section-title">键盘信息和USB信息</div>
      <div class="input-group">
        <label for="keyboardName">键盘名:</label>
        <input type="text" id="keyboardName" class="small-input" value="QMK" />
        <label for="manufacturer">制造商:</label>
        <input type="text" id="manufacturer" class="small-input" value="Keyboard" />
      </div>
      <div class="input-group">
        <label for="url">网址:</label>
        <input type="text" id="url" value="https://www.google.com/ncr" />
        <label for="maintainer">维护者:</label>
        <input type="text" id="maintainer" class="small-input" value="qmk" />
      </div>
      <div class="input-group" style="margin-top:20px;">
        <label for="vid">VID (十六进制):</label>
        <input type="text" id="vid" class="small-input" maxlength="4" value="F001" />
        <label for="pid">PID (十六进制):</label>
        <input type="text" id="pid" class="small-input" maxlength="4" value="6001" />
        <label for="deviceVersion">设备版本:</label>
        <input type="text" id="deviceVersion" class="small-input" value="0.0.1" />
      </div>
      <div id="usbError"></div>

      <div class="section-title" style="margin-top:20px;">构建选项</div>
      <div class="input-group">
        <input type="checkbox" id="enableLTO" checked>
        <label for="enableLTO">LTO</label>
      </div>

      <div class="section-title" style="margin-top:20px;">特性</div>
      <div id="featuresOptions" class="feature-option-row">
      </div>
    </div>

    <div class="qmk-option-group-wrapper">
        <div class="section-title">QMK 设置</div>
        <div class="qmk-option-group">
            <div>
                <label for="processorSelect">处理器:</label>
                <select id="processorSelect"></select>
            </div>
            <div>
                <label for="boardSelect">板卡:</label>
                <select id="boardSelect"></select>
            </div>
            <div>
                <label for="bootloaderSelect">启动器:</label>
                <select id="bootloaderSelect"></select>
            </div>
        </div>
        <div class="qmk-option-group" style="margin-top: 15px;">
            <div class="qmk-locking-options">
                <input type="checkbox" id="enableLockingCheckbox">
                <label for="enableLockingCheckbox">启用锁定</label>
                <select id="lockingEnabledSelect" style="display: none;">
                    <option value="true">true</option>
                    <option value="false">false</option>
                </select>
            </div>
            <div class="qmk-locking-options">
                <input type="checkbox" id="enableResyncCheckbox">
                <label for="enableResyncCheckbox">启用重同步</label>
                <select id="resyncEnabledSelect" style="display: none;">
                    <option value="true">true</option>
                    <option value="false">false</option>
                </select>
            </div>
        </div>
        <div class="bootmagic-section">
            <div class="section-title">Bootmagic Matrix (仅当特性中启用Bootmagic时显示)</div>
            <div class="bootmagic-matrix-input">
                <label for="bootmagicRow">Row:</label>
                <input type="number" id="bootmagicRow" value="0" min="0" class="narrow-input" />
                <label for="bootmagicCol">Col:</label>
                <input type="number" id="bootmagicCol" value="0" min="0" class="narrow-input" />
            </div>
            <div id="bootmagicError"></div>
        </div>
        <div id="qmkError"></div>
    </div>

    <div id="rgbMatrixSections" style="display: none;">
        <div class="input-section">
            <div class="section-title">KLE数据输入</div>
            <label for="rawData">KLE数据：</label>
            <textarea id="rawData" spellcheck="false">["0,8","1,8","0,9","1,9"],
["5,8","3,8","2,9",{h:2},"6,10"],
["3,9","4,9","5,9"],
["6,7","6,8","6,9",{h:2},"7,10"],
[{w:2},"7,8","7,9"]
</textarea>
            <div id="errorDisplay"></div>
        </div>

        <div class="input-section">
            <div class="section-title">RGB Matrix 参数配置</div>
            <label for="ledCurrent">单灯电流 (mA)：
            <input type="number" id="ledCurrent" min="1" max="60" value="36" /></label>

            <div id="rgbMatrixAnimationsOptions">
                <div class="section-title">动画 (至少选一)</div>
                <div id="rgbMatrixAnimationsCheckboxes" class="animations-row">
                </div>
                <div class="animation-controls">
                    <button id="rgbMatrixSelectAllAnimationsBtn">全选</button>
                    <button id="rgbMatrixInvertSelectionAnimationsBtn">反选</button>
                    <button id="rgbMatrixRandomSelectAnimationsBtn">随机选择</button>
                    <input type="number" id="rgbMatrixRandomAnimationCount" value="1" min="1">
                    <label for="rgbMatrixRandomAnimationCount">个</label>
                </div>
                <div id="rgbMatrixAnimationsError"></div>
            </div>

            <div class="option-group">
                <div class="driver-option-row">
                    <label for="driverSelect">驱动:</label>
                    <select id="driverSelect">
                    </select>
                </div>
                <div>
                    <label for="flagsSelect">Flags:</label>
                    <select id="flagsSelect">
                    </select>
                </div>
                <div>
                    <label>中心点 (X, Y):</label>
                    <input type="number" id="centerX" value="112" min="0" max="224" />
                    <input type="number" id="centerY" value="32" min="0" max="64" />
                </div>
                <div id="centerPointError"></div>
                <div>
                    <input type="checkbox" id="reactOnKeyupCheckbox" checked>
                    <label for="reactOnKeyupCheckbox">按键抬起</label>
                </div>
                <div class="rgb-option-item">
                    <input type="checkbox" id="enableSatSteps">
                    <label for="enableSatSteps">饱和步数:</label>
                    <input type="number" id="satStepsInput" value="8" min="1" max="255" class="narrow-input" style="display:none;">
                </div>
                <div class="rgb-option-item">
                    <input type="checkbox" id="enableValSteps">
                    <label for="enableValSteps">值步数:</label>
                    <input type="number" id="valStepsInput" value="8" min="1" max="255" class="narrow-input" style="display:none;">
                </div>
                <div class="rgb-option-item">
                    <input type="checkbox" id="enableSpeedSteps">
                    <label for="enableSpeedSteps">速度步数:</label>
                    <input type="number" id="speedStepsInput" value="10" min="1" max="255" class="narrow-input" style="display:none;">
                </div>
                <div class="rgb-option-item">
                    <input type="checkbox" id="enableMaxBrightness">
                    <label for="enableMaxBrightness">最大亮度:</label>
                    <input type="number" id="maxBrightnessInput" value="120" min="0" max="255" class="narrow-input" style="display:none;">
                </div>
                <div>
                    <input type="checkbox" id="sleepCheckbox">
                    <label for="sleepCheckbox">休眠</label>
                </div>
            </div>

            <div class="controls-buttons">
                <button id="convertRGB">生成配置</button>
                <button id="reverseBtn">反转键位顺序</button>
            </div>
        </div>

        <div id="keyboard"></div>
    </div>

    <div id="ws2812PinContainer" class="ws2812-pin-section" style="display:none;">
        <label for="ws2812PinInput">WS2812 引脚:</label>
        <input type="text" id="ws2812PinInput" class="pin-input" value="C0"/>
        <div id="pinError"></div>
    </div>

    <div id="encoderSections" class="encoder-section" style="display: none;">
        <div class="section-title">编码器配置</div>
        <div id="encoderRotaryContainer">
        </div>
        <div id="encoderError"></div>
    </div>

    <div id="rgblightSections" class="rgblight-section" style="display: none;">
        <div class="section-title">RGBLight 配置</div>
        <div class="rgblight-config-row">
            <div class="inline-input-group">
                <label for="rgblightSatSteps">饱和步数:</label>
                <input type="number" id="rgblightSatSteps" value="8" min="1" max="255" />
            </div>
            <div class="inline-input-group">
                <label for="rgblightBrightnessSteps">亮度步数:</label>
                <input type="number" id="rgblightBrightnessSteps" value="8" min="1" max="255" />
            </div>
            <div class="inline-input-group">
                <label for="rgblightLedCount">LED 数量:</label>
                <input type="number" id="rgblightLedCount" value="13" min="1" max="999" />
            </div>
        </div>
        <div id="rgblightAnimationsOptions">
            <div class="section-title">动画 (至少选一)</div>
            <div id="rgblightAnimationsCheckboxes" class="animations-row">
            </div>
            <div class="animation-controls">
                <button id="rgblightSelectAllAnimationsBtn">全选</button>
                <button id="rgblightInvertSelectionAnimationsBtn">反选</button>
                <button id="rgblightRandomSelectAnimationsBtn">反选</button>
                <input type="number" id="rgblightRandomAnimationCount" value="1" min="1">
                <label for="rgblightRandomAnimationCount">个</label>
            </div>
            <div id="rgblightAnimationsError"></div>
        </div>
        <div id="rgblightError"></div>
    </div>

    <div class="input-section">
        <div class="section-title">矩阵引脚配置</div>
        <div>
            <label>列引脚:</label>
            <div id="colsPinsContainer" class="pin-input-row">
            </div>
        </div>
        <div>
            <label>行引脚:</label>
            <div id="rowsPinsContainer" class="pin-input-row">
            </div>
        </div>
        <div class="matrix-pin-option-row">
            <label for="ioDelayInput">IO 延迟 (ms):</label>
            <input type="number" id="ioDelayInput" value="5" min="0" />
            <label for="diodeDirectionSelect">二极管方向:</label>
            <select id="diodeDirectionSelect">
                <option value="COL2ROW">COL2ROW</option>
                <option value="ROW2COL">ROW2COL</option>
            </select>
        </div>
        <div id="matrixPinError"></div>
    </div>

    <div class="indicators-section">
        <div class="section-title">指示灯配置</div>
        <div class="input-group">
            <label for="capsLockPin">Caps Lock 引脚:</label>
            <input type="text" id="capsLockPin" class="small-input" value="A7" />
            <label for="numLockPin">Num Lock 引脚:</label>
            <input type="text" id="numLockPin" class="small-input" value="A3" />
            <label for="scrollLockPin">Scroll Lock 引脚:</label>
            <input type="text" id="scrollLockPin" class="small-input" value="C3" />
            <label>ON 状态:</label>
            <button type="button" id="onStateButton" class="high">高</button>
            <span id="onStateLabel" style="font-size:0.9em;">(当前: 1)</span>
        </div>
        <div id="indicatorError"></div>
    </div>

  </div>

  <div class="right-panel">
    <div class="result-header">
        <div class="section-title">结果展示</div>
        <div class="action-buttons">
            <button id="resetBtn">重置</button>
            <button id="copyCodeBtn">复制</button>
            <button id="downloadCodeBtn">下载</button>
        </div>
    </div>
    <textarea id="rgbResult" spellcheck="false"></textarea>
  </div>
</div>

<script>
(() => {
  const UNIT = 40, GAP = 5;
  const RGB_MAX_X = 224, RGB_MAX_Y = 64;
  const keyboard = document.getElementById("keyboard");
  const rawDataInput = document.getElementById("rawData");
  const convertRGBBtn = document.getElementById("convertRGB");
  const ledCurrentInput = document.getElementById("ledCurrent");
  const rgbResult = document.getElementById("rgbResult");
  const resetBtn = document.getElementById("resetBtn");
  const reverseBtn = document.getElementById("reverseBtn");
  const copyCodeBtn = document.getElementById("copyCodeBtn");
  const downloadCodeBtn = document.getElementById("downloadCodeBtn");

  const rgbMatrixSections = document.getElementById("rgbMatrixSections");
  const encoderSections = document.getElementById("encoderSections");
  const rgblightSections = document.getElementById("rgblightSections");

  const rgbMatrixAnimationsCheckboxesContainer = document.getElementById("rgbMatrixAnimationsCheckboxes");
  const driverSelect = document.getElementById("driverSelect");
  const flagsSelect = document.getElementById("flagsSelect");
  const centerXInput = document.getElementById("centerX");
  const centerYInput = document.getElementById("centerY");
  const reactOnKeyupCheckbox = document.getElementById("reactOnKeyupCheckbox");
  const ws2812PinContainer = document.getElementById("ws2812PinContainer");
  const ws2812PinInput = document.getElementById("ws2812PinInput");

  const colsPinsContainer = document.getElementById("colsPinsContainer");
  const rowsPinsContainer = document.getElementById("rowsPinsContainer");
  const ioDelayInput = document.getElementById("ioDelayInput");
  const diodeDirectionSelect = document.getElementById("diodeDirectionSelect");

  const encoderRotaryContainer = document.getElementById("encoderRotaryContainer");


  const rgbMatrixSelectAllAnimationsBtn = document.getElementById("rgbMatrixSelectAllAnimationsBtn");
  const rgbMatrixInvertSelectionAnimationsBtn = document.getElementById("rgbMatrixInvertSelectionAnimationsBtn");
  const rgbMatrixRandomSelectAnimationsBtn = document.getElementById("rgbMatrixRandomSelectAnimationsBtn");
  const rgbMatrixRandomAnimationCountInput = document.getElementById("rgbMatrixRandomAnimationCount");

  const enableSatStepsCheckbox = document.getElementById("enableSatSteps");
  const satStepsInput = document.getElementById("satStepsInput");
  const enableValStepsCheckbox = document.getElementById("enableValSteps");
  const valStepsInput = document.getElementById("valStepsInput");
  const enableSpeedStepsCheckbox = document.getElementById("enableSpeedSteps");
  const speedStepsInput = document.getElementById("speedStepsInput");
  const enableMaxBrightnessCheckbox = document.getElementById("enableMaxBrightness");
  const maxBrightnessInput = document.getElementById("maxBrightnessInput");
  const sleepCheckbox = document.getElementById("sleepCheckbox");

  const keyboardNameInput = document.getElementById("keyboardName");
  const manufacturerInput = document.getElementById("manufacturer");
  const urlInput = document.getElementById("url");
  const maintainerInput = document.getElementById("maintainer");
  const vidInput = document.getElementById("vid");
  const pidInput = document.getElementById("pid");
  const deviceVersionInput = document.getElementById("deviceVersion");
  const enableLTOCheckbox = document.getElementById("enableLTO");
  const featuresOptionsContainer = document.getElementById("featuresOptions");

  const processorSelect = document.getElementById("processorSelect");
  const boardSelect = document.getElementById("boardSelect");
  const bootloaderSelect = document.getElementById("bootloaderSelect");
  const enableLockingCheckbox = document.getElementById("enableLockingCheckbox");
  const lockingEnabledSelect = document.getElementById("lockingEnabledSelect");
  const enableResyncCheckbox = document.getElementById("enableResyncCheckbox");
  const resyncEnabledSelect = document.getElementById("resyncEnabledSelect");
  const bootmagicRowInput = document.getElementById("bootmagicRow");
  const bootmagicColInput = document.getElementById("bootmagicCol");
  const bootmagicSection = document.querySelector(".bootmagic-section");


  const errorDisplay = document.getElementById("errorDisplay");
  const centerPointError = document.getElementById("centerPointError");
  const rgbMatrixAnimationsError = document.getElementById("rgbMatrixAnimationsError");
  const pinError = document.getElementById("pinError");
  const matrixPinError = document.getElementById("matrixPinError");
  const usbError = document.getElementById("usbError");
  const qmkError = document.getElementById("qmkError");
  const encoderError = document.getElementById("encoderError");
  const rgblightAnimationsError = document.getElementById("rgblightAnimationsError");
  const rgblightError = document.getElementById("rgblightError");
  const indicatorError = document.getElementById("indicatorError");
  const bootmagicError = document.getElementById("bootmagicError");


  const rgblightSatStepsInput = document.getElementById("rgblightSatSteps");
  const rgblightBrightnessStepsInput = document.getElementById("rgblightBrightnessSteps");
  const rgblightLedCountInput = document.getElementById("rgblightLedCount");
  const rgblightAnimationsCheckboxesContainer = document.getElementById("rgblightAnimationsCheckboxes");
  const rgblightSelectAllAnimationsBtn = document.getElementById("rgblightSelectAllAnimationsBtn");
  const rgblightInvertSelectionAnimationsBtn = document.getElementById("rgblightInvertSelectionAnimationsBtn");
  const rgblightRandomSelectAnimationsBtn = document.getElementById("rgblightRandomSelectAnimationsBtn");
  const rgblightRandomAnimationCountInput = document.getElementById("rgblightRandomAnimationCount");

  const capsLockPinInput = document.getElementById("capsLockPin");
  const numLockPinInput = document.getElementById("numLockPin");
  const scrollLockPinInput = document.getElementById("scrollLockPin");
  const onStateButton = document.getElementById("onStateButton");
  const onStateLabel = document.getElementById("onStateLabel");
  let onStateValue = 1; // 1 for HIGH, 0 for LOW


  let keysData = [];
  let reversed = false;
  let copyButtonOriginalText = copyCodeBtn.textContent;
  let copyButtonOriginalBg = getComputedStyle(copyCodeBtn).backgroundColor;
  let downloadButtonOriginalText = downloadCodeBtn.textContent;
  let downloadButtonOriginalBg = getComputedStyle(downloadCodeBtn).backgroundColor;


  const allRgbMatrixAnimations = [
    "alphas_mods", "breathing", "band_sat", "band_val", "band_pinwheel_sat",
    "band_pinwheel_val", "band_spiral_sat", "band_spiral_val", "colorband_pinwheel_sat",
    "colorband_pinwheel_val", "colorband_sat", "colorband_spiral_sat", "colorband_spiral_val",
    "colorband_val", "cycle_all", "cycle_left_right", "cycle_up_down", "cycle_out_in_dual",
    "cycle_pinwheel", "cycle_spiral", "digital_rain", "dual_beacon", "flower_blooming",
    "gradient_up_down", "gradient_left_right", "hue_breathing", "hue_pendulum", "hue_wave",
    "jellybean_raindrops", "multi_splash", "openrgb_direct", "pixel_rain", "pixel_flow",
    "pixel_fractal", "rainbow_beacon", "rainbow_pinwheels", "raindrops", "rainbow_moving_chevron",
    "river_flow", "solid_reactive_simple", "solid_reactive_wide", "solid_reactive_multiwide",
    "solid_reactive_cross", "solid_reactive_multicross", "solid_reactive_nexus",
    "solid_reactive_multinexus", "solid_splash", "solid_multi_splash", "splash", "starlight",
    "starlight_dual_hue", "starlight_dual_sat", "signal_rgb_anim", "typing_heatmap", "vial_rgb"
  ];

  const allRgblightAnimations = [
    "breathing", "rainbow_mood", "rainbow_swirl", "snake", "knight", "christmas",
    "static_gradient", "rgb_test", "alternating", "twinkle"
  ];

  const allDrivers = [
    "APA102", "AW20216S", "IS31FL3218", "IS31FL3236", "IS31FL3729", "IS31FL3731",
    "IS31FL3733", "IS31FL3736", "IS31FL3737", "IS31FL3741", "IS31FL3742A",
    "IS31FL3743A", "IS31FL3745", "IS31FL3746A", "SNLED27351", "WS2812"
  ];

  const allFlags = ["0", "1", "2", "4", "8", "FF"];

  const allFeatures = [
      "bootmagic", "command", "console", "extrakey", "mousekey", "nkro",
      "rgb_matrix", "rgblight", "encoder", "midi"
  ];

  const processors = ["STM32F103", "STM32F401", "STM32F411"];
  const boards = ["STM32_F103_STM32DUINO", "BLACKPILL_STM32_F401", "BLACKPILL_STM32_F411"];
  const bootloaders = ["vibl", "stm32-dfu", "custom", "apm32-dfu", "at32-dfu", "bootloadhidgd32v-dfu", "qmk-dfu", "qmk-hid", "rp2040", "stm32duino", "tinyuf2", "uf2boot", "unknown"];


  function clearError() {
    rawDataInput.classList.remove('error');
    errorDisplay.textContent = '';
  }

  function showParsingError(message) {
    rawDataInput.classList.add('error');
    errorDisplay.textContent = '解析错误: ' + message;
    rawDataInput.style.animation = 'none';
    rawDataInput.offsetHeight;
    rawDataInput.style.animation = '';
  }

  function clearCenterPointError() {
    centerPointError.textContent = '';
    centerXInput.classList.remove('error-input');
    centerYInput.classList.remove('error-input');
  }

  function showCenterPointError(message) {
    centerPointError.textContent = '中心点错误: ' + message;
    centerXInput.classList.add('error-input');
    centerYInput.classList.add('error-input');
  }

  function clearRgbMatrixAnimationsError() {
    rgbMatrixAnimationsError.textContent = '';
  }

  function showRgbMatrixAnimationsError(message) {
    rgbMatrixAnimationsError.textContent = message;
  }

  function clearRgblightAnimationsError() {
    rgblightAnimationsError.textContent = '';
  }

  function showRgblightAnimationsError(message) {
    rgblightAnimationsError.textContent = message;
  }

  function clearRgblightError() {
    rgblightError.textContent = '';
    rgblightSatStepsInput.classList.remove('error-input');
    rgblightBrightnessStepsInput.classList.remove('error-input');
    rgblightLedCountInput.classList.remove('error-input');
  }

  function showRgblightError(message, inputElement = null) {
    rgblightError.textContent = message;
    if (inputElement) {
        inputElement.classList.add('error-input');
    }
  }


  function clearPinError() {
      pinError.textContent = '';
      ws2812PinInput.classList.remove('error-input');
  }

  function showPinError(message) {
      pinError.textContent = message;
      ws2812PinInput.classList.add('error-input');
  }

  function clearMatrixPinError() {
      matrixPinError.textContent = '';
      document.querySelectorAll('.matrix-pin-input').forEach(input => {
          input.classList.remove('error-input');
      });
  }

  function showMatrixPinError(message, inputElement = null) {
      matrixPinError.textContent = message;
      if (inputElement) {
          inputElement.classList.add('error-input');
      } else {
          document.querySelectorAll('.matrix-pin-input').forEach(input => {
              input.classList.add('error-input');
          });
      }
  }

  function clearUSBError() {
      usbError.textContent = '';
      vidInput.classList.remove('error-input');
      pidInput.classList.remove('error-input');
  }

  function showUSBError(message, inputElement = null) {
      usbError.textContent = message;
      if (inputElement) {
          inputElement.classList.add('error-input');
      } else {
          vidInput.classList.add('error-input');
          pidInput.classList.add('error-input');
      }
  }

  function clearQMKError() {
      qmkError.textContent = '';
      processorSelect.classList.remove('error-input');
      boardSelect.classList.remove('error-input');
      bootloaderSelect.classList.remove('error-input');
  }

  function showQMKError(message, inputElement = null) {
      qmkError.textContent = message;
      if (inputElement) {
          inputElement.classList.add('error-input');
      } else {
          processorSelect.classList.add('error-input');
          boardSelect.classList.add('error-input');
          bootloaderSelect.classList.add('error-input');
      }
  }

  function clearEncoderError() {
      encoderError.textContent = '';
      document.querySelectorAll('.encoder-pin-input, .encoder-resolution-input').forEach(input => {
          input.classList.remove('error-input');
      });
  }

  function showEncoderError(message, inputElement = null) {
      encoderError.textContent = message;
      if (inputElement) {
          inputElement.classList.add('error-input');
      } else {
          document.querySelectorAll('.encoder-pin-input, .encoder-resolution-input').forEach(input => {
              input.classList.add('error-input');
          });
      }
  }

  function clearIndicatorError() {
      indicatorError.textContent = '';
      capsLockPinInput.classList.remove('error-input');
      numLockPinInput.classList.remove('error-input');
      scrollLockPinInput.classList.remove('error-input');
  }

  function showIndicatorError(message, inputElement = null) {
      indicatorError.textContent = message;
      if (inputElement) {
          inputElement.classList.add('error-input');
      } else {
          capsLockPinInput.classList.add('error-input');
          numLockPinInput.classList.add('error-input');
          scrollLockPinInput.classList.add('error-input');
      }
  }

  function clearBootmagicError() {
      bootmagicError.textContent = '';
      bootmagicRowInput.classList.remove('error-input');
      bootmagicColInput.classList.remove('error-input');
  }

  function showBootmagicError(message, inputElement = null) {
      bootmagicError.textContent = message;
      if (inputElement) {
          inputElement.classList.add('error-input');
      } else {
          bootmagicRowInput.classList.add('error-input');
          bootmagicColInput.classList.add('error-input');
      }
  }


  function validateHexInput(inputElement) {
      const value = inputElement.value.trim().toUpperCase();
      const hexRegex = /^[0-9A-F]*$/;

      if (!hexRegex.test(value)) {
          showUSBError("VID和PID只能包含十六进制字符 (0-9, A-F)。", inputElement);
          return false;
      }
      clearUSBError();
      return true;
  }


  function generateRgbMatrixAnimationsCheckboxes() {
    rgbMatrixAnimationsCheckboxesContainer.innerHTML = '';
    allRgbMatrixAnimations.forEach(anim => {
      const div = document.createElement('div');
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = `rgb_matrix_anim_${anim}`;
      input.name = 'rgb_matrix_animation';
      input.value = anim;
      input.addEventListener('change', convertToRGBPositions);

      const label = document.createElement('label');
      label.htmlFor = `rgb_matrix_anim_${anim}`;
      label.textContent = anim;

      div.appendChild(input);
      div.appendChild(label);
      rgbMatrixAnimationsCheckboxesContainer.appendChild(div);
    });
    rgbMatrixRandomAnimationCountInput.max = allRgbMatrixAnimations.length;
  }

  function generateRgblightAnimationsCheckboxes() {
    rgblightAnimationsCheckboxesContainer.innerHTML = '';
    allRgblightAnimations.forEach(anim => {
      const div = document.createElement('div');
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = `rgblight_anim_${anim}`;
      input.name = 'rgblight_animation';
      input.value = anim;
      input.addEventListener('change', convertToRGBPositions);

      const label = document.createElement('label');
      label.htmlFor = `rgblight_anim_${anim}`;
      label.textContent = anim;

      div.appendChild(input);
      div.appendChild(label);
      rgblightAnimationsCheckboxesContainer.appendChild(div);
    });
    rgblightRandomAnimationCountInput.max = allRgblightAnimations.length;
  }


  function generateDriversOptions() {
    driverSelect.innerHTML = '';
    allDrivers.forEach(driver => {
      const option = document.createElement('option');
      option.value = driver.toLowerCase();
      option.textContent = driver;
      driverSelect.appendChild(option);
    });
    driverSelect.value = "ws2812";
    updateWs2812PinInputVisibility();
  }

  function generateFlagsOptions() {
    flagsSelect.innerHTML = '';
    allFlags.forEach(flag => {
      const option = document.createElement('option');
      option.value = flag;
      option.textContent = flag;
      flagsSelect.appendChild(option);
    });
    flagsSelect.value = "4";
  }

  function generateFeaturesOptions() {
    featuresOptionsContainer.innerHTML = '';
    allFeatures.forEach(feature => {
        const div = document.createElement('div');
        div.className = 'feature-option';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `feature_${feature}`;
        checkbox.value = feature;

        const label = document.createElement('label');
        label.htmlFor = `feature_${feature}`;
        label.textContent = feature;

        const select = document.createElement('select');
        select.id = `select_feature_${feature}`;
        
        const optionTrue = document.createElement('option');
        optionTrue.value = 'true';
        optionTrue.textContent = 'true';
        select.appendChild(optionTrue);

        const optionFalse = document.createElement('option');
        optionFalse.value = 'false';
        optionFalse.textContent = 'false';
        select.appendChild(optionFalse);

        if (["command", "console", "extrakey", "mousekey", "nkro"].includes(feature)) {
            checkbox.checked = true;
            select.value = 'true';
        } else if (feature === "bootmagic") {
            checkbox.checked = false; // Default to false for bootmagic
            select.value = 'false';
        }
        else if (feature === "rgb_matrix" || feature === "encoder" || feature === "rgblight" || feature === "midi") {
            checkbox.checked = false;
            select.value = 'false';
        }
        select.style.display = checkbox.checked ? 'inline-block' : 'none';


        checkbox.addEventListener('change', () => {
            select.style.display = checkbox.checked ? 'inline-block' : 'none';
            if (checkbox.checked) {
                select.value = 'true';
            } else {
                select.value = 'false';
            }
            if (feature === 'rgb_matrix') {
                toggleRgbMatrixSections();
            } else if (feature === 'encoder') {
                toggleEncoderSections();
            } else if (feature === 'rgblight') {
                toggleRgblightSections();
            } else if (feature === 'bootmagic') {
                toggleBootmagicSection();
            }
            updateWs2812PinInputVisibility();
            convertToRGBPositions();
        });

        select.addEventListener('change', () => {
            if (feature === 'rgb_matrix') {
                toggleRgbMatrixSections();
            } else if (feature === 'encoder') {
                toggleEncoderSections();
            } else if (feature === 'rgblight') {
                toggleRgblightSections();
            } else if (feature === 'bootmagic') {
                toggleBootmagicSection();
            }
            updateWs2812PinInputVisibility();
            convertToRGBPositions();
        });

        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(select);
        featuresOptionsContainer.appendChild(div);
    });
    
    toggleRgbMatrixSections();
    toggleEncoderSections();
    toggleRgblightSections();
    toggleBootmagicSection();
    updateWs2812PinInputVisibility();
  }

  function generateQMKOptions() {
      function populateSelect(selectElement, optionsArray) {
          selectElement.innerHTML = '';
          optionsArray.forEach(optionText => {
              const option = document.createElement('option');
              option.value = optionText;
              option.textContent = optionText;
              selectElement.appendChild(option);
          });
      }
      populateSelect(processorSelect, processors);
      populateSelect(boardSelect, boards);
      populateSelect(bootloaderSelect, bootloaders);

      processorSelect.value = "STM32F103";
      boardSelect.value = "STM32_F103_STM32DUINO";
      bootloaderSelect.value = "vibl";
  }

  function setupQMKProcessorBoardBootloaderListeners() {
      processorSelect.addEventListener('change', convertToRGBPositions);
      boardSelect.addEventListener('change', convertToRGBPositions);
      bootloaderSelect.addEventListener('change', convertToRGBPositions);
  }

  function setupQMKLockingListeners() {
      enableLockingCheckbox.addEventListener('change', () => {
          lockingEnabledSelect.style.display = enableLockingCheckbox.checked ? 'inline-block' : 'none';
          if (!enableLockingCheckbox.checked) {
              enableResyncCheckbox.checked = false;
              resyncEnabledSelect.style.display = 'none';
          }
          convertToRGBPositions();
      });
      lockingEnabledSelect.addEventListener('change', convertToRGBPositions);

      enableResyncCheckbox.addEventListener('change', () => {
          resyncEnabledSelect.style.display = enableResyncCheckbox.checked ? 'inline-block' : 'none';
          if (enableResyncCheckbox.checked) {
              enableLockingCheckbox.checked = true;
              lockingEnabledSelect.style.display = 'inline-block';
          }
          convertToRGBPositions();
      });
      resyncEnabledSelect.addEventListener('change', convertToRGBPositions);
  }

  function toggleBootmagicSection() {
      const bootmagicCheckbox = document.getElementById('feature_bootmagic');
      const bootmagicSelect = document.getElementById('select_feature_bootmagic');
      const shouldShowBootmagic = bootmagicCheckbox && bootmagicCheckbox.checked && bootmagicSelect && bootmagicSelect.value === 'true';

      if (shouldShowBootmagic) {
          bootmagicSection.style.display = 'block';
      } else {
          bootmagicSection.style.display = 'none';
          clearBootmagicError();
      }
      convertToRGBPositions();
  }

  function updateWs2812PinInputVisibility() {
      const rgbMatrixCheckbox = document.getElementById('feature_rgb_matrix');
      const rgbMatrixSelect = document.getElementById('select_feature_rgb_matrix');
      const isRgbMatrixEnabled = rgbMatrixCheckbox && rgbMatrixCheckbox.checked && rgbMatrixSelect && rgbMatrixSelect.value === 'true';

      const rgblightCheckbox = document.getElementById('feature_rgblight');
      const rgblightSelect = document.getElementById('select_feature_rgblight');
      const isRgblightEnabled = rgblightCheckbox && rgblightCheckbox.checked && rgblightSelect && rgblightSelect.value === 'true';

      if ((isRgbMatrixEnabled || isRgblightEnabled) && driverSelect.value === "ws2812") {
          ws2812PinContainer.style.display = 'flex';
          ws2812PinInput.required = true;
      } else {
          ws2812PinContainer.style.display = 'none';
          ws2812PinInput.required = false;
          clearPinError();
      }
  }

  function updatePinButtons(containerId) {
      const container = document.getElementById(containerId);
      const pinGroups = container.querySelectorAll('.pin-input-group');
      
      container.querySelectorAll('.add-pin-btn, .remove-pin-btn').forEach(btn => btn.remove());

      pinGroups.forEach((group, index) => {
          if (pinGroups.length > 1) {
              const removeBtn = document.createElement('button');
              removeBtn.textContent = '-';
              removeBtn.className = 'remove-pin-btn';
              removeBtn.onclick = (e) => {
                  e.preventDefault();
                  container.removeChild(group);
                  updatePinButtons(containerId);
                  convertToRGBPositions();
              };
              group.appendChild(removeBtn);
          }

          if (index === pinGroups.length - 1) {
              const addBtn = document.createElement('button');
              addBtn.textContent = '+';
              addBtn.className = 'add-pin-btn';
              addBtn.onclick = (e) => {
                  e.preventDefault();
                  addPinInput(containerId);
              };
              group.appendChild(addBtn);
          }
      });

      if (pinGroups.length === 0) {
          addPinInput(containerId);
      }
  }

  function addPinInput(containerId, initialValue = '') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = 'pin-input-group';
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'matrix-pin-input';
      input.value = initialValue;
      input.oninput = convertToRGBPositions;

      div.appendChild(input);
      container.appendChild(div);
      updatePinButtons(containerId);
      convertToRGBPositions();
  }

  function getMatrixPins(containerId) {
      const inputs = document.getElementById(containerId).querySelectorAll('.matrix-pin-input');
      const pins = [];
      inputs.forEach(input => {
          const val = input.value.trim();
          if (val === '') {
              return;
          } else if (val.toLowerCase() === 'null') {
              pins.push('null');
          } else {
              pins.push(`"${val}"`);
          }
      });
      return pins;
  }

  function toggleEncoderSections() {
      const encoderCheckbox = document.getElementById('feature_encoder');
      const encoderSelect = document.getElementById('select_feature_encoder');
      const shouldShowEncoder = encoderCheckbox && encoderCheckbox.checked && encoderSelect && encoderSelect.value === 'true';

      if (shouldShowEncoder) {
          encoderSections.style.display = 'block';
          if (encoderRotaryContainer.children.length === 0) {
              addEncoderGroup();
          }
      } else {
          encoderSections.style.display = 'none';
          encoderRotaryContainer.innerHTML = '';
          clearEncoderError();
      }
      convertToRGBPositions();
  }

  function addEncoderGroup(pinA = '', pinB = '', resolution = 4) {
      const group = document.createElement('div');
      group.className = 'encoder-group';

      group.innerHTML = `
          <label>Pin A:</label>
          <input type="text" class="encoder-pin-input encoder-pin-a" value="${pinA}" />
          <label>Pin B:</label>
          <input type="text" class="encoder-pin-input encoder-pin-b" value="${pinB}" />
          <label>分辨率:</label>
          <input type="number" class="encoder-resolution-input" value="${resolution}" min="1" />
          <div class="add-remove-buttons">
              <button type="button" class="add-btn">+</button>
              <button type="button" class="remove-btn">-</button>
          </div>
      `;

      encoderRotaryContainer.appendChild(group);

      group.querySelector('.encoder-pin-a').addEventListener('input', convertToRGBPositions);
      group.querySelector('.encoder-pin-b').addEventListener('input', convertToRGBPositions);
      group.querySelector('.encoder-resolution-input').addEventListener('input', convertToRGBPositions);
      group.querySelector('.add-btn').addEventListener('click', () => addEncoderGroup());
      group.querySelector('.remove-btn').addEventListener('click', (e) => {
          e.preventDefault();
          encoderRotaryContainer.removeChild(group);
          if (encoderRotaryContainer.children.length === 0 && document.getElementById('feature_encoder').checked && document.getElementById('select_feature_encoder').value === 'true') {
              addEncoderGroup();
          }
          convertToRGBPositions();
      });

      convertToRGBPositions();
  }

  function getEncoderData() {
      const encoderGroups = encoderRotaryContainer.querySelectorAll('.encoder-group');
      const rotaryData = [];
      let isValid = true;

      encoderGroups.forEach(group => {
          const pinAInput = group.querySelector('.encoder-pin-a');
          const pinBInput = group.querySelector('.encoder-pin-b');
          const resolutionInput = group.querySelector('.encoder-resolution-input');

          const pinA = pinAInput.value.trim();
          const pinB = pinBInput.value.trim();
          const resolution = parseInt(resolutionInput.value);

          pinAInput.classList.remove('error-input');
          pinBInput.classList.remove('error-input');
          resolutionInput.classList.remove('error-input');

          if (!pinA && !pinB) {
              return;
          }

          if (!pinA) {
              showEncoderError("Encoder的Pin A不能为空。", pinAInput);
              isValid = false;
          }
          if (!pinB) {
              showEncoderError("Encoder的Pin B不能为空。", pinBInput);
              isValid = false;
          }
          if (isValid && (isNaN(resolution) || resolution < 1)) {
              showEncoderError("Encoder的分辨率必须是大于0的整数。", resolutionInput);
              isValid = false;
          }
          
          if (isValid) {
              rotaryData.push({
                  "pin_a": `"${pinA}"`,
                  "pin_b": `"${pinB}"`,
                  "resolution": resolution
              });
          }
      });
      
      if (isValid) {
          clearEncoderError();
      }
      return isValid ? rotaryData : null;
  }

  function toggleRgblightSections() {
      const rgblightCheckbox = document.getElementById('feature_rgblight');
      const rgblightSelect = document.getElementById('select_feature_rgblight');
      const shouldShowRgblight = rgblightCheckbox && rgblightCheckbox.checked && rgblightSelect && rgblightSelect.value === 'true';

      if (shouldShowRgblight) {
          rgblightSections.style.display = 'block';
      } else {
          rgblightSections.style.display = 'none';
          clearRgblightError();
          clearRgblightAnimationsError();
      }
      updateWs2812PinInputVisibility();
      convertToRGBPositions();
  }


  function parseInput(text) {
    const trimmed = text.trim();
    if (trimmed.startsWith('[[') && trimmed.endsWith(']')) {
      return Function('"use strict";return (' + trimmed + ')')();
    } else {
      const lines = trimmed.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      for (let i = 0; i < lines.length - 1; i++) {
        if (!lines[i].endsWith(',')) lines[i] += ',';
      }
      const wrapped = '[' + lines.join('\n') + ']';
      return Function('"use strict";return (' + wrapped + ')')();
    }
  }

  function computeKeys(data) {
    const result = [];
    let currentY = 0, accumulatedYOffset = 0;

    for (let rowIndex = 0; rowIndex < data.length; rowIndex++) {
      const row = data[rowIndex];
      let xPos = 0;
      let nextW = 1, nextH = 1, nextXOffset = 0;
      let rowYOffset = 0;

      for (let item of row) {
        if (typeof item === "object" && "y" in item) {
          rowYOffset = item.y;
          break;
        }
      }

      const rowY = currentY + accumulatedYOffset + rowYOffset;

      for (let i = 0; i < row.length; i++) {
        const item = row[i];

        if (typeof item === "object") {
          const allowed = ["w", "h", "x", "y"];
          const filtered = Object.fromEntries(
            Object.entries(item).filter(([k]) => allowed.includes(k))
          );
          if (Object.keys(filtered).length === 0) continue;
          if ("w" in filtered) nextW = filtered.w;
          if ("h" in filtered) nextH = filtered.h;
          if ("x" in filtered) nextXOffset = filtered.x;
          if ("y" in filtered) rowYOffset = filtered.y;
          continue;
        }

        const key = {
          x: xPos + nextXOffset,
          y: rowY,
          w: nextW,
          h: nextH,
          label: typeof item === "string" ? item : "",
          rowIndex,
          keyIndex: i
        };

        if (!key.label) key.label = `${key.x},${key.y}`;

        result.push(key);
        xPos = key.x + key.w;
        nextW = 1; nextH = 1; nextXOffset = 0;
      }

      accumulatedYOffset += rowYOffset;
      currentY += 1;
    }
    return result;
  }

  function renderKeys(keys) {
    keyboard.innerHTML = "";

    let maxKeyX = 0;
    if (keys.length > 0) {
      maxKeyX = Math.max(...keys.map(k => k.x + k.w));
    }
    const contentWidth = maxKeyX * (UNIT + GAP);
    keyboard.style.width = `${contentWidth}px`;
    keyboard.style.minWidth = '100%';


    keys.forEach((key, idx) => {
      const keyWidth = key.w * UNIT + (key.w - 1) * GAP;
      const keyHeight = key.h * UNIT + (key.h - 1) * GAP;

      const div = document.createElement("div");
      div.className = "key";
      div.textContent = key.label;
      div.style.left = (key.x * (UNIT + GAP)) + "px";
      div.style.top = (key.y * (UNIT + GAP)) + "px";
      div.style.width = keyWidth + "px";
      div.style.height = keyHeight + "px";

      div.draggable = true;
      div.dataset.index = idx;

      if (reversed) {
        div.classList.add("reversed");
      } else {
        div.classList.remove("reversed");
      }

      div.ondragstart = e => {
        e.dataTransfer.setData("text/plain", idx);
        div.classList.add("dragging");
      };
      div.ondragend = () => div.classList.remove("dragging");
      div.ondragover = e => { e.preventDefault(); div.classList.add("dragover"); };
      div.ondragleave = () => div.classList.remove("dragover");
      div.ondrop = e => {
        e.preventDefault();
        div.classList.remove("dragover");
        const fromIdx = parseInt(e.dataTransfer.getData("text/plain"));
        const toIdx = idx;
        if (fromIdx !== toIdx) {
          [keysData[fromIdx].label, keysData[toIdx].label] = [keysData[toIdx].label, keysData[fromIdx].label];
          renderKeys(keysData);
          convertToRGBPositions();
        }
      };

      keyboard.appendChild(div);
    });

    const maxY = Math.max(...keys.map(k => k.y + (k.h || 1)));
    const totalHeight = (UNIT + GAP) * maxY;
    keyboard.style.height = totalHeight + "px";
  }


  function toggleRgbMatrixSections() {
      const rgbMatrixCheckbox = document.getElementById('feature_rgb_matrix');
      const rgbMatrixSelect = document.getElementById('select_feature_rgb_matrix');
      const shouldShowRgbMatrix = rgbMatrixCheckbox && rgbMatrixCheckbox.checked && rgbMatrixSelect && rgbMatrixSelect.value === 'true';

      if (shouldShowRgbMatrix) {
          rgbMatrixSections.style.display = 'block';
      } else {
          rgbMatrixSections.style.display = 'none';
          keysData = [];
          keyboard.innerHTML = '';
          clearError();
          clearCenterPointError();
          clearRgbMatrixAnimationsError();
          clearPinError();
      }
      updateWs2812PinInputVisibility();
      convertToRGBPositions();
  }


  function updateOnStateButton() {
      if (onStateValue === 1) {
          onStateButton.textContent = "高";
          onStateButton.classList.remove("low");
          onStateButton.classList.add("high");
          onStateLabel.textContent = "(当前: 1)";
      } else {
          onStateButton.textContent = "低";
          onStateButton.classList.remove("high");
          onStateButton.classList.add("low");
          onStateLabel.textContent = "(当前: 0)";
      }
  }


  function convertToRGBPositions() {
    clearRgbMatrixAnimationsError();
    clearCenterPointError();
    clearPinError();
    clearMatrixPinError();
    clearUSBError();
    clearQMKError();
    clearEncoderError();
    clearRgblightError();
    clearRgblightAnimationsError();
    clearIndicatorError();
    clearBootmagicError();

    if (!validateHexInput(vidInput) || !validateHexInput(pidInput)) {
        rgbResult.value = "{\n    \"error\": \"USB VID或PID输入无效。\"\n}";
        return;
    }
    const formattedVid = "0x" + vidInput.value.toUpperCase().padStart(4, '0');
    const formattedPid = "0x" + pidInput.value.toUpperCase().padStart(4, '0');


    const rgbMatrixCheckbox = document.getElementById('feature_rgb_matrix');
    const rgbMatrixSelect = document.getElementById('select_feature_rgb_matrix');
    const isRgbMatrixEnabled = rgbMatrixCheckbox && rgbMatrixCheckbox.checked && rgbMatrixSelect && rgbMatrixSelect.value === 'true';

    const encoderCheckbox = document.getElementById('feature_encoder');
    const encoderSelect = document.getElementById('select_feature_encoder');
    const isEncoderEnabled = encoderCheckbox && encoderCheckbox.checked && encoderSelect && encoderSelect.value === 'true';

    const rgblightCheckbox = document.getElementById('feature_rgblight');
    const rgblightSelect = document.getElementById('select_feature_rgblight');
    const isRgblightEnabled = rgblightCheckbox && rgblightCheckbox.checked && rgblightSelect && rgblightSelect.value === 'true';

    const bootmagicFeatureCheckbox = document.getElementById('feature_bootmagic');
    const bootmagicFeatureSelect = document.getElementById('select_feature_bootmagic');
    const isBootmagicEnabled = bootmagicFeatureCheckbox && bootmagicFeatureCheckbox.checked && bootmagicFeatureSelect && bootmagicFeatureSelect.value === 'true';


    let outputParts = [];

    outputParts.push(`"keyboard_name": "${keyboardNameInput.value}",`);
    outputParts.push(`"manufacturer": "${manufacturerInput.value}",`);
    outputParts.push(`"url": "${urlInput.value}",`);
    outputParts.push(`"maintainer": "${maintainerInput.value}",`);
    
    outputParts.push(`"processor": "${processorSelect.value}",`);
    outputParts.push(`"board": "${boardSelect.value}",`);
    outputParts.push(`"bootloader": "${bootloaderSelect.value}",`);

    outputParts.push(`"usb": {\n    "vid": "${formattedVid}",\n    "pid": "${formattedPid}",\n    "device_version": "${deviceVersionInput.value}"\n},`);

    if (enableLTOCheckbox.checked) {
        outputParts.push(`"build": {\n    "lto": true\n},`);
    }

    let featuresContent = [];
    document.querySelectorAll('#featuresOptions input[type="checkbox"]').forEach(checkbox => {
        const featureName = checkbox.value;
        const selectElement = document.getElementById(`select_feature_${featureName}`);
        if (checkbox.checked && selectElement) {
            const selectValue = selectElement.value;
            featuresContent.push(`    "${featureName}": ${selectValue}`);
        }
    });
    if (featuresContent.length > 0) {
        outputParts.push(`"features": {\n${featuresContent.join(',\n')}\n},`);
    }

    if (isRgblightEnabled) {
        const satSteps = parseInt(rgblightSatStepsInput.value);
        const brightSteps = parseInt(rgblightBrightnessStepsInput.value);
        const ledCount = parseInt(rgblightLedCountInput.value);

        if (isNaN(satSteps) || satSteps < 1 || satSteps > 255) {
            showRgblightError("饱和度步数应为 1-255。", rgblightSatStepsInput);
            rgbResult.value = "{\n    \"error\": \"RGBLight 饱和度步数无效。\"\n}";
            return;
        }
        if (isNaN(brightSteps) || brightSteps < 1 || brightSteps > 255) {
            showRgblightError("亮度步数应为 1-255。", rgblightBrightnessStepsInput);
            rgbResult.value = "{\n    \"error\": \"RGBLight 亮度步数无效。\"\n}";
            return;
        }
        if (isNaN(ledCount) || ledCount < 1 || ledCount > 999) {
            showRgblightError("LED 数量应为 1-999。", rgblightLedCountInput);
            rgbResult.value = "{\n    \"error\": \"RGBLight LED 数量无效。\"\n}";
            return;
        }

        const rgblightAnimations = {};
        let anyRgblightAnimationSelected = false;
        document.querySelectorAll('#rgblightAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.checked) {
                rgblightAnimations[checkbox.value] = true;
                anyRgblightAnimationSelected = true;
            }
        });

        if (!anyRgblightAnimationSelected) {
            showRgblightAnimationsError("RGBLight 至少选一个动画。");
            rgbResult.value = "{\n    \"error\": \"RGBLight 请选择至少一个动画选项。\"\n}";
            return;
        }

        const rgblightAnimationsString = Object.entries(rgblightAnimations)
            .map(([key, value]) => `        "${key}": ${value}`)
            .join(',\n');

        outputParts.push(`"rgblight": {\n    "saturation_steps": ${satSteps},\n    "brightness_steps": ${brightSteps},\n    "led_count": ${ledCount},\n    "animations": {\n${rgblightAnimationsString}\n    }\n},`);
    }


    if (isEncoderEnabled) {
        const encoderData = getEncoderData();
        if (encoderData === null) {
            rgbResult.value = "{\n    \"error\": \"编码器配置有误，请检查输入。\"\n}";
            return;
        }
        if (encoderData.length > 0) {
            const rotaryEntries = encoderData.map(e => {
                return `{ "pin_a": ${e.pin_a}, "pin_b": ${e.pin_b}, "resolution": ${e.resolution} }`;
            }).join(',\n      ');
            outputParts.push(`"encoder": {\n    "rotary": [\n      ${rotaryEntries}\n    ]\n},`);
        }
    }


    let qmkSection = [];
    if (enableLockingCheckbox.checked) {
        const lockingEnabledValue = lockingEnabledSelect.value;
        const resyncEnabledValue = enableResyncCheckbox.checked ? resyncEnabledSelect.value : 'false';
        
        qmkSection.push(`    "locking": {\n        "enabled": ${lockingEnabledValue},\n        "resync": ${resyncEnabledValue}\n    }`);
    }
    if (qmkSection.length > 0) {
        outputParts.push(`"qmk": {\n${qmkSection.join(',\n')}\n},`);
    }

    if (isBootmagicEnabled) {
        const row = parseInt(bootmagicRowInput.value);
        const col = parseInt(bootmagicColInput.value);

        if (isNaN(row) || row < 0) {
            showBootmagicError("Bootmagic Row 必须是非负整数。", bootmagicRowInput);
            rgbResult.value = "{\n    \"error\": \"Bootmagic Row 值无效。\"\n}";
            return;
        }
        if (isNaN(col) || col < 0) {
            showBootmagicError("Bootmagic Col 必须是非负整数。", bootmagicColInput);
            rgbResult.value = "{\n    \"error\": \"Bootmagic Col 值无效。\"\n}";
            return;
        }
        outputParts.push(`"bootmagic": {\n    "matrix": [${row}, ${col}]\n},`);
    }

    if (isRgbMatrixEnabled) {
        try {
            const data = parseInput(rawDataInput.value);
            keysData = computeKeys(data);
            renderKeys(keysData);
            clearError();
        } catch (e) {
            showParsingError(e.message);
            rgbResult.value = "{\n    \"error\": \"解析KLE数据时出错。请检查数据格式。\"\n}";
            return;
        }

        const maxX = Math.max(...keysData.map(k => k.x + ((k.w || 1) / 2 - 0.5)));
        const maxY = Math.max(...keysData.map(k => k.y + ((k.h || 1) / 2 - 0.5)));

        const selectedFlags = flagsSelect.value;
        const selectedDriver = driverSelect.value;
        const ws2812Pin = ws2812PinInput.value.trim();

        if (selectedDriver === "ws2812") {
            if (!ws2812Pin && (isRgbMatrixEnabled || isRgblightEnabled)) { 
                showPinError("WS2812驱动需要填写PIN值。");
                rgbResult.value = "{\n    \"error\": \"WS2812驱动需要填写PIN值。\"\n}";
                return;
            }
        }

        const centerX = parseInt(centerXInput.value);
        const centerY = parseInt(centerYInput.value);
        
        if (isNaN(centerX) || isNaN(centerY)) {
            showCenterPointError("中心点X和Y必须是有效数字。");
            rgbResult.value = "{\n    \"error\": \"中心点X和Y必须是有效数字。\"\n}";
            return;
        } else if (centerX < 0 || centerX > RGB_MAX_X || centerY < 0 || centerY > RGB_MAX_Y) {
            showCenterPointError(`中心点X (0-${RGB_MAX_X}) 或 Y (0-${RGB_MAX_Y}) 必须在指定范围。`);
            rgbResult.value = `{\n    \"error\": \"中心点X (${centerX}) 或 Y (${centerY}) 超出允许范围。X范围: 0-${RGB_MAX_X}, Y范围: 0-${RGB_MAX_Y}\"\n}`;
            return;
        }
        
        const animations = {};
        let anyAnimationSelected = false;
        document.querySelectorAll('#rgbMatrixAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
          if (checkbox.checked) {
            animations[checkbox.value] = true;
            anyAnimationSelected = true;
          }
        });

        if (!anyAnimationSelected) {
          showRgbMatrixAnimationsError("至少选一个动画。");
          rgbResult.value = "{\n    \"error\": \"请选择至少一个动画选项。\"\n}";
          return;
        }

        let layoutArray = keysData.map(k => {
          const adjX = k.x + ((k.w || 1) / 2 - 0.5);
          const adjY = k.y + ((k.h || 1) / 2 - 0.5);

          const rgbX = maxX > 0 ? Math.round((adjX / maxX) * RGB_MAX_X) : 0;
          const rgbY = maxY > 0 ? Math.round((adjY / maxY) * RGB_MAX_Y) : 0;

          const [mx, my] = k.label.split(',').map(Number);
          return {
            matrix: [mx, my],
            x: rgbX,
            y: rgbY,
            flags: selectedFlags === "FF" ? "0xFF" : parseInt(selectedFlags)
          };
        });

        if (reversed) {
          layoutArray.reverse();
        }

        const customStringify = (obj) => {
            let jsonStr = JSON.stringify(obj, (key, value) => {
                if (value === "0xFF") {
                    return "$$0xFF$$";
                }
                return value;
            });
            jsonStr = jsonStr.replace(/"\$\$0xFF\$\$"/g, '0xFF');
            return jsonStr;
        };

        const rgbMatrixLayoutString = layoutArray.map(item => customStringify(item)).join(',\n    ');

        let rgbMatrixContent = `  "animations": {\n`;
        const animationEntries = Object.entries(animations).map(([key, value]) => `    "${key}": ${value}`).join(',\n');
        rgbMatrixContent += animationEntries;
        rgbMatrixContent += `\n  },\n`;
        rgbMatrixContent += `  "layout": [\n    ${rgbMatrixLayoutString}\n  ],\n`;
        rgbMatrixContent += `  "led_count": ${keysData.length},\n`;
        rgbMatrixContent += `  "driver": "${selectedDriver}",\n`;
        rgbMatrixContent += `  "center_point": [ ${centerX}, ${centerY} ],\n`;
        rgbMatrixContent += `  "react_on_keyup": ${reactOnKeyupCheckbox.checked}`;
        
        if (enableSatStepsCheckbox.checked) {
            rgbMatrixContent += `,\n  "sat_steps": ${parseInt(satStepsInput.value) || 8}`;
        }
        if (enableValStepsCheckbox.checked) {
            rgbMatrixContent += `,\n  "val_steps": ${parseInt(valStepsInput.value) || 8}`;
        }
        if (enableSpeedStepsCheckbox.checked) {
            rgbMatrixContent += `,\n  "speed_steps": ${parseInt(speedStepsInput.value) || 10}`;
        }
        if (enableMaxBrightnessCheckbox.checked) {
            rgbMatrixContent += `,\n  "max_brightness": ${parseInt(maxBrightnessInput.value) || 120}`;
        }
        rgbMatrixContent += `,\n  "sleep": ${sleepCheckbox.checked}`;

        outputParts.push(`"rgb_matrix": {\n${rgbMatrixContent}\n},`);
    }

    if (driverSelect.value === "ws2812" && (isRgbMatrixEnabled || isRgblightEnabled)) {
        const ws2812Pin = ws2812PinInput.value.trim();
        outputParts.push(`"ws2812": {\n    "pin": "${ws2812Pin}"\n},`);
    }

    const colsPins = getMatrixPins('colsPinsContainer');
    const rowsPins = getMatrixPins('rowsPinsContainer');

    const ioDelay = parseInt(ioDelayInput.value);
    if (isNaN(ioDelay) || ioDelay < 0) {
        showMatrixPinError("IO 延迟必须是非负整数。");
        rgbResult.value = "{\n    \"error\": \"IO 延迟必须是非负整数。\"\n}";
        return;
    }

    const diodeDirection = diodeDirectionSelect.value;

    let matrixPinsContent = ``;
    if (colsPins.length > 0) {
        matrixPinsContent += `  "cols": [ ${colsPins.join(', ').replace(/"null"/g, 'null')} ]`;
    }
    if (rowsPins.length > 0) {
        if (matrixPinsContent !== '') matrixPinsContent += ',\n';
        matrixPinsContent += `  "rows": [ ${rowsPins.join(', ').replace(/"null"/g, 'null')} ]`;
    }
    if (matrixPinsContent.trim() !== '') {
        matrixPinsContent += ',\n';
    }
    matrixPinsContent += `  "io_delay": ${ioDelay}`;
    
    if (matrixPinsContent.trim() !== '') {
        outputParts.push(`"matrix_pins": {\n${matrixPinsContent}\n},`);
    }

    outputParts.push(`"diode_direction": "${diodeDirection}",`);

    // Indicators Logic
    const capsLockPin = capsLockPinInput.value.trim();
    const numLockPin = numLockPinInput.value.trim();
    const scrollLockPin = scrollLockPinInput.value.trim();

    const indicatorsContent = [];
    if (capsLockPin !== "") {
        indicatorsContent.push(`        "caps_lock": "${capsLockPin}"`);
    } else {
        capsLockPinInput.classList.remove('error-input'); // Clear error if empty
    }
    if (numLockPin !== "") {
        indicatorsContent.push(`        "num_lock": "${numLockPin}"`);
    } else {
        numLockPinInput.classList.remove('error-input'); // Clear error if empty
    }
    if (scrollLockPin !== "") {
        indicatorsContent.push(`        "scroll_lock": "${scrollLockPin}"`);
    } else {
        scrollLockPinInput.classList.remove('error-input'); // Clear error if empty
    }

    if (indicatorsContent.length > 0) {
        indicatorsContent.push(`        "on_state": ${onStateValue}`);
        outputParts.push(`"indicators": {\n${indicatorsContent.join(',\n')}\n},`);
        clearIndicatorError();
    } else {
        clearIndicatorError();
    }

    const numCols = getMatrixPins('colsPinsContainer').length;
    const numRows = getMatrixPins('rowsPinsContainer').length;
    let autoLayout = [];
    if (numCols > 0 && numRows > 0) {
        for (let r = 0; r < numRows; r++) {
            for (let c = 0; c < numCols; c++) {
                autoLayout.push(`{"matrix":[${r},${c}],"x":${c},"y":${r}}`);
            }
        }
    }
    
    if (autoLayout.length > 0) {
        if (outputParts[outputParts.length - 1] && outputParts[outputParts.length - 1].endsWith(',')) {
            outputParts[outputParts.length - 1] = outputParts[outputParts.length - 1].slice(0, -1);
        }
        outputParts.push(`"layouts": {\n  "LAYOUT": {\n    "layout": [\n      ${autoLayout.join(',\n      ')}\n    ]\n  }`);
    } else {
        if (outputParts[outputParts.length - 1] && outputParts[outputParts.length - 1].endsWith(',')) {
            outputParts[outputParts.length - 1] = outputParts[outputParts.length - 1].slice(0, -1);
        }
    }

    rgbResult.value = `{\n${outputParts.join('\n')}\n}`;
  }

  convertRGBBtn.onclick = convertToRGBPositions;

  resetBtn.onclick = () => {
    keyboardNameInput.value = "QMK";
    manufacturerInput.value = "Keyboard";
    urlInput.value = "https://www.google.com/ncr";
    maintainerInput.value = "qmk";
    vidInput.value = "F001";
    pidInput.value = "6001";
    deviceVersionInput.value = "0.0.1";
    clearUSBError();

    processorSelect.value = "STM32F103";
    boardSelect.value = "STM32_F103_STM32DUINO";
    bootloaderSelect.value = "vibl";

    enableLockingCheckbox.checked = false;
    lockingEnabledSelect.style.display = 'none';
    enableResyncCheckbox.checked = false;
    resyncEnabledSelect.style.display = 'none';
    clearQMKError();

    enableLTOCheckbox.checked = true;

    generateFeaturesOptions(); // This will reset bootmagic checkbox and select state
    bootmagicRowInput.value = "0";
    bootmagicColInput.value = "0";
    clearBootmagicError();


    rawDataInput.value = `["0,8","1,8","0,9","1,9"],
["5,8","3,8","2,9",{h:2},"6,10"],
["3,9","4,9","5,9"],
["6,7","6,8","6,9",{h:2},"7,10"],
[{w:2},"7,8","7,9"]
`;
    keysData = []; // Reset keysData
    keyboard.innerHTML = ''; // Clear keyboard display
    reversed = false;
    document.querySelectorAll('#rgbMatrixAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    if (allRgbMatrixAnimations.length > 0) {
      document.getElementById(`rgb_matrix_anim_${allRgbMatrixAnimations[0]}`).checked = true;
    }
    clearRgbMatrixAnimationsError();

    driverSelect.value = "ws2812";
    flagsSelect.value = "4";
    centerXInput.value = "112";
    centerYInput.value = "32";
    reactOnKeyupCheckbox.checked = true;
    rgbMatrixRandomAnimationCountInput.value = "1";
    ws2812PinInput.value = "C0";
    updateWs2812PinInputVisibility();

    enableSatStepsCheckbox.checked = false;
    satStepsInput.style.display = 'none';
    satStepsInput.value = "8";
    
    enableValStepsCheckbox.checked = false;
    valStepsInput.style.display = 'none';
    valStepsInput.value = "8";
    
    enableSpeedStepsCheckbox.checked = false;
    speedStepsInput.style.display = 'none';
    speedStepsInput.value = "10";
    
    enableMaxBrightnessCheckbox.checked = false;
    maxBrightnessInput.style.display = 'none';
    maxBrightnessInput.value = "120";

    sleepCheckbox.checked = false;

    colsPinsContainer.innerHTML = '';
    rowsPinsContainer.innerHTML = '';
    addPinInput('colsPinsContainer', 'A3');
    addPinInput('rowsPinsContainer', 'B8');
    updatePinButtons('colsPinsContainer');
    updatePinButtons('rowsPinsContainer');
    
    ioDelayInput.value = "5";
    diodeDirectionSelect.value = "COL2ROW";
    clearMatrixPinError();

    encoderRotaryContainer.innerHTML = '';
    clearEncoderError();
    toggleEncoderSections();

    rgblightSatStepsInput.value = "8";
    rgblightBrightnessStepsInput.value = "8";
    rgblightLedCountInput.value = "13";
    document.querySelectorAll('#rgblightAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    if (allRgblightAnimations.length > 0) {
        document.getElementById(`rgblight_anim_${allRgblightAnimations[0]}`).checked = true;
    }
    rgblightRandomAnimationCountInput.value = "1";
    clearRgblightError();
    clearRgblightAnimationsError();
    toggleRgblightSections();

    capsLockPinInput.value = "A7";
    numLockPinInput.value = "A3";
    scrollLockPinInput.value = "C3";
    onStateValue = 1; // Reset to HIGH
    updateOnStateButton();
    clearIndicatorError();


    convertToRGBPositions();
  };

  copyCodeBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(rgbResult.value);
      copyCodeBtn.textContent = '已复制！';
      copyCodeBtn.style.backgroundColor = '#28a745';
      setTimeout(() => {
        copyCodeBtn.textContent = copyButtonOriginalText;
        copyCodeBtn.style.backgroundColor = copyButtonOriginalBg;
      }, 2000);
    } catch (err) {
      console.error('复制失败:', err);
      copyCodeBtn.textContent = '复制失败';
      copyCodeBtn.style.backgroundColor = '#dc3545';
      setTimeout(() => {
        copyCodeBtn.textContent = copyButtonOriginalText;
        copyCodeBtn.style.backgroundColor = copyButtonOriginalBg;
      }, 2000);
    }
  };

  downloadCodeBtn.onclick = () => {
      const filename = "keyboard.json";
      const textContent = rgbResult.value;

      const blob = new Blob([textContent], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      downloadCodeBtn.textContent = '已下载！';
      downloadCodeBtn.style.backgroundColor = '#17a2b8';
      setTimeout(() => {
        downloadCodeBtn.textContent = downloadButtonOriginalText;
        downloadCodeBtn.style.backgroundColor = downloadButtonOriginalBg;
      }, 2000);
  };

  keyboardNameInput.addEventListener('input', convertToRGBPositions);
  manufacturerInput.addEventListener('input', convertToRGBPositions);
  urlInput.addEventListener('input', convertToRGBPositions);
  maintainerInput.addEventListener('input', convertToRGBPositions);
  vidInput.addEventListener('input', () => {
      validateHexInput(vidInput);
      convertToRGBPositions();
  });
  pidInput.addEventListener('input', () => {
      validateHexInput(pidInput);
      convertToRGBPositions();
  });
  deviceVersionInput.addEventListener('input', convertToRGBPositions);
  enableLTOCheckbox.addEventListener('change', convertToRGBPositions);

  processorSelect.addEventListener('change', convertToRGBPositions);
  boardSelect.addEventListener('change', convertToRGBPositions);
  bootloaderSelect.addEventListener('change', convertToRGBPositions);

  ledCurrentInput.addEventListener('input', convertToRGBPositions);

  enableSatStepsCheckbox.addEventListener('change', () => {
      satStepsInput.style.display = enableSatStepsCheckbox.checked ? 'inline-block' : 'none';
      convertToRGBPositions();
  });
  satStepsInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
      this.value = 1;
    } else if (value > 255) {
      this.value = 255;
    }
    convertToRGBPositions();
  });

  enableValStepsCheckbox.addEventListener('change', () => {
      valStepsInput.style.display = enableValStepsCheckbox.checked ? 'inline-block' : 'none';
      convertToRGBPositions();
  });
  valStepsInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
      this.value = 1;
    } else if (value > 255) {
      this.value = 255;
    }
    convertToRGBPositions();
  });

  enableSpeedStepsCheckbox.addEventListener('change', () => {
      speedStepsInput.style.display = enableSpeedStepsCheckbox.checked ? 'inline-block' : 'none';
      convertToRGBPositions();
  });
  speedStepsInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
      this.value = 1;
    } else if (value > 255) {
      this.value = 255;
    }
    convertToRGBPositions();
  });

  enableMaxBrightnessCheckbox.addEventListener('change', () => {
      maxBrightnessInput.style.display = enableMaxBrightnessCheckbox.checked ? 'inline-block' : 'none';
      convertToRGBPositions();
  });
  maxBrightnessInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 0) {
      this.value = 0;
    } else if (value > 255) {
      this.value = 255;
    }
    convertToRGBPositions();
  });


  driverSelect.addEventListener('change', () => {
      updateWs2812PinInputVisibility();
      convertToRGBPositions();
  });
  ws2812PinInput.addEventListener('input', convertToRGBPositions);

  flagsSelect.addEventListener('change', convertToRGBPositions);
  centerXInput.addEventListener('input', convertToRGBPositions);
  centerYInput.addEventListener('input', convertToRGBPositions);
  reactOnKeyupCheckbox.addEventListener('change', convertToRGBPositions);

  sleepCheckbox.addEventListener('change', convertToRGBPositions);

  ioDelayInput.addEventListener('input', convertToRGBPositions);
  diodeDirectionSelect.addEventListener('change', convertToRGBPositions);

  capsLockPinInput.addEventListener('input', convertToRGBPositions);
  numLockPinInput.addEventListener('input', convertToRGBPositions);
  scrollLockPinInput.addEventListener('input', convertToRGBPositions);
  
  onStateButton.addEventListener('click', () => {
      onStateValue = 1 - onStateValue; // Toggle between 0 and 1
      updateOnStateButton();
      convertToRGBPositions();
  });

  bootmagicRowInput.addEventListener('input', convertToRGBPositions);
  bootmagicColInput.addEventListener('input', convertToRGBPositions);


  rgbMatrixSelectAllAnimationsBtn.onclick = () => {
    document.querySelectorAll('#rgbMatrixAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = true;
    });
    convertToRGBPositions();
  };

  rgbMatrixInvertSelectionAnimationsBtn.onclick = () => {
    document.querySelectorAll('#rgbMatrixAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = !checkbox.checked;
    });
    convertToRGBPositions();
  };

  rgbMatrixRandomSelectAnimationsBtn.onclick = () => {
    const count = parseInt(rgbMatrixRandomAnimationCountInput.value);
    if (isNaN(count) || count < 1) {
        showRgbMatrixAnimationsError("随机选择数量必须是有效数字且至少为1。");
        return;
    }
    if (count > allRgbMatrixAnimations.length) {
        showRgbMatrixAnimationsError(`随机选择数量不能超过动画总数 (${allRgbMatrixAnimations.length})。`);
        return;
    }

    document.querySelectorAll('#rgbMatrixAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });

    const shuffledAnimations = [...allRgbMatrixAnimations].sort(() => 0.5 - Math.random());
    for (let i = 0; i < count; i++) {
        const animName = shuffledAnimations[i];
        const checkbox = document.getElementById(`rgb_matrix_anim_${animName}`);
        if (checkbox) {
            checkbox.checked = true;
        }
    }
    convertToRGBPositions();
  };
  
  reverseBtn.onclick = () => {
    reversed = !reversed;
    renderKeys(keysData);
    convertToRGBPositions();
    reverseBtn.classList.toggle('active', reversed);
  };

  rgblightSatStepsInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
        this.value = 1;
        showRgblightError("饱和度步数应为 1-255。", this);
    } else if (value > 255) {
        this.value = 255;
        showRgblightError("饱和度步数应为 1-255。", this);
    } else {
        clearRgblightError();
    }
    convertToRGBPositions();
  });
  rgblightBrightnessStepsInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
        this.value = 1;
        showRgblightError("亮度步数应为 1-255。", this);
    } else if (value > 255) {
        this.value = 255;
        showRgblightError("亮度步数应为 1-255。", this);
    } else {
        clearRgblightError();
    }
    convertToRGBPositions();
  });
  rgblightLedCountInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
        this.value = 1;
        showRgblightError("LED 数量应为 1-999。", this);
    } else if (value > 999) {
        this.value = 999;
        showRgblightError("LED 数量应为 1-999。", this);
    } else {
        clearRgblightError();
    }
    convertToRGBPositions();
  });

  rgblightSelectAllAnimationsBtn.onclick = () => {
    document.querySelectorAll('#rgblightAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = true;
    });
    convertToRGBPositions();
  };

  rgblightInvertSelectionAnimationsBtn.onclick = () => {
    document.querySelectorAll('#rgblightAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = !checkbox.checked;
    });
    convertToRGBPositions();
  };

  rgblightRandomSelectAnimationsBtn.onclick = () => {
    const count = parseInt(rgblightRandomAnimationCountInput.value);
    if (isNaN(count) || count < 1) {
        showRgblightAnimationsError("RGBLight 随机选择数量必须是有效数字且至少为1。");
        return;
    }
    if (count > allRgblightAnimations.length) {
        showRgblightAnimationsError(`RGBLight 随机选择数量不能超过动画总数 (${allRgblightAnimations.length})。`);
        return;
    }

    document.querySelectorAll('#rgblightAnimationsCheckboxes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });

    const shuffledAnimations = [...allRgblightAnimations].sort(() => 0.5 - Math.random());
    for (let i = 0; i < count; i++) {
        const animName = shuffledAnimations[i];
        const checkbox = document.getElementById(`rgblight_anim_${animName}`);
        if (checkbox) {
            checkbox.checked = true;
        }
    }
    convertToRGBPositions();
  };


  generateRgbMatrixAnimationsCheckboxes();
  generateRgblightAnimationsCheckboxes();
  generateDriversOptions();
  generateFlagsOptions();
  generateFeaturesOptions();
  generateQMKOptions();
  setupQMKProcessorBoardBootloaderListeners();
  setupQMKLockingListeners();
  updateOnStateButton();


  document.addEventListener('DOMContentLoaded', () => {
      addPinInput('colsPinsContainer', 'A3');
      addPinInput('rowsPinsContainer', 'B8');
      updatePinButtons('colsPinsContainer');
      updatePinButtons('rowsPinsContainer');

      enableSatStepsCheckbox.checked = false;
      satStepsInput.style.display = 'none';
      
      enableValStepsCheckbox.checked = false;
      valStepsInput.style.display = 'none';
      
      enableSpeedStepsCheckbox.checked = false;
      speedStepsInput.style.display = 'none';
      
      enableMaxBrightnessCheckbox.checked = false;
      maxBrightnessInput.style.display = 'none';

      sleepCheckbox.checked = false;

      enableLockingCheckbox.checked = false;
      lockingEnabledSelect.style.display = 'none';
      enableResyncCheckbox.checked = false;
      resyncEnabledSelect.style.display = 'none';

      const rgbMatrixCheckbox = document.getElementById('feature_rgb_matrix');
      const rgbMatrixSelect = document.getElementById('select_feature_rgb_matrix');
      if (rgbMatrixCheckbox) {
          rgbMatrixCheckbox.checked = false;
          if (rgbMatrixSelect) {
              rgbMatrixSelect.value = 'false';
              rgbMatrixSelect.style.display = 'none';
          }
      }
      const encoderCheckbox = document.getElementById('feature_encoder');
      const encoderSelect = document.getElementById('select_feature_encoder');
      if (encoderCheckbox) {
          encoderCheckbox.checked = false;
          if (encoderSelect) {
              encoderSelect.value = 'false';
              encoderSelect.style.display = 'none';
          }
      }
      const rgblightCheckbox = document.getElementById('feature_rgblight');
      const rgblightSelect = document.getElementById('select_feature_rgblight');
      if (rgblightCheckbox) {
          rgblightCheckbox.checked = false;
          if (rgblightSelect) {
              rgblightSelect.value = 'false';
              rgblightSelect.style.display = 'none';
          }
      }
      const bootmagicCheckbox = document.getElementById('feature_bootmagic');
      const bootmagicSelect = document.getElementById('select_feature_bootmagic');
      if (bootmagicCheckbox) {
          bootmagicCheckbox.checked = false;
          if (bootmagicSelect) {
              bootmagicSelect.value = 'false';
              bootmagicSelect.style.display = 'none';
          }
      }


      toggleRgbMatrixSections();
      toggleEncoderSections();
      toggleRgblightSections();
      toggleBootmagicSection();
      updateWs2812PinInputVisibility();
  });


  if (allRgbMatrixAnimations.length > 0) {
    document.getElementById(`rgb_matrix_anim_${allRgbMatrixAnimations[0]}`).checked = true;
  }
  if (allRgblightAnimations.length > 0) {
    document.getElementById(`rgblight_anim_${allRgblightAnimations[0]}`).checked = true;
  }

  convertToRGBPositions();
})();
</script>
<script>
        // Disable right-click menu and F12/Ctrl+Shift+I/Ctrl+U
        document.addEventListener('contextmenu',function(e){e.preventDefault();});
        document.onkeydown = function(e) {
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73) || (e.ctrlKey && e.keyCode == 85)) {
                return false;
            }
            if (e.keyCode == 116) { // Disable F5 (refresh)
                e.preventDefault();
            }
        };
    </script>
</body>
</html>