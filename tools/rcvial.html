<!DOCTYPE html>
<html lang="zh">
<head>
<title>QMK 矩阵生成器</title>
<meta charset="UTF-8">
<style>
    :root {
        --primary-color: #4361ee;
        --primary-glow: rgba(67, 97, 238, 0.4);
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-main: #2d3436;
        --text-secondary: #636e72;
        --border-color: #dfe6e9;
        --btn-inactive: #e9ecef;
        --btn-inactive-text: #adb5bd;
        --danger-color: #ef4444;
        --danger-glow: rgba(239, 68, 68, 0.3);
    }

    body {
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        background-color: var(--bg-color); color: var(--text-main);
        margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px 0;
    }

    .container { 
        width: 90%; max-width: 1400px; background: var(--card-bg); 
        padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        box-sizing: border-box;
    }

    h1 { font-size: 20px; margin: 0 0 20px 0; color: var(--primary-color); text-align: center; }
    
    .section-box { border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .flex-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    
    label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; }
    
    input, select {
        border: 1px solid var(--border-color); border-radius: 4px; padding: 4px 8px;
        font-family: 'Consolas', monospace; font-size: 12px; outline: none;
        transition: border-color 0.2s;
    }

    /* 动态按钮基础样式 */
    .toggle-btn, .main-btn, .circle-btn {
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
    }

    /* 悬停发光与放大效果 */
    .toggle-btn:hover, .main-btn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 5px 15px var(--primary-glow);
    }

    .toggle-btn:active, .main-btn:active {
        transform: translateY(0) scale(0.98);
    }

    .toggle-btn {
        padding: 6px 14px; border-radius: 6px; border: none; font-size: 11px; font-weight: 600;
        background: var(--btn-inactive); color: var(--btn-inactive-text);
    }
    
    .toggle-btn.active { 
        background: var(--primary-color); color: white; 
        box-shadow: 0 4px 10px var(--primary-glow);
    }

    .action-bar { display: flex; justify-content: center; gap: 10px; margin: 20px 0; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    
    .main-btn { padding: 8px 18px; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; color: white; }
    .btn-primary { background: var(--primary-color); }
    
    .btn-reset { 
        background: #fee2e2; color: var(--danger-color); border: 1px solid #fecaca; 
    }
    .btn-reset:hover {
        box-shadow: 0 5px 15px var(--danger-glow) !important;
        background: #fecaca;
    }
    
    .output-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
    textarea { width: 100%; height: 250px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Consolas', monospace; font-size: 12px; resize: vertical; box-sizing: border-box; background: #fafafa; }

    #encoderList { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .encoder-item { 
        display: flex; align-items: center; gap: 8px; background: #f8f9fd; 
        padding: 8px 12px; border-radius: 8px; border: 1px solid #eef2ff;
    }

    .circle-btn { 
        width: 22px; height: 22px; border-radius: 50%; border: none; 
        background: var(--primary-color); color: white; 
        display: flex; align-items: center; justify-content: center; font-size: 16px; 
    }
    .circle-btn:hover { transform: scale(1.2); box-shadow: 0 0 10px var(--primary-glow); }

    .scroll-input { cursor: ns-resize; }
    .pin-input { width: 60px; text-align: center; }
</style>
</head>
<body>

    <datalist id="stm32-pins">
        <option value="null">
        <option value="PA0"> <option value="PA1"> <option value="PA2"> <option value="PA3">
        <option value="PA4"> <option value="PA5"> <option value="PA6"> <option value="PA7">
        <option value="PA8"> <option value="PA9"> <option value="PA10"> <option value="PA11">
        <option value="PA12"> <option value="PA13"> <option value="PA14"> <option value="PA15">
        <option value="PB0"> <option value="PB1"> <option value="PB2"> <option value="PB3">
        <option value="PB4"> <option value="PB5"> <option value="PB6"> <option value="PB7">
        <option value="PB8"> <option value="PB9"> <option value="PB10"> <option value="PB12">
        <option value="PB13"> <option value="PB14"> <option value="PB15">
        <option value="PC13"> <option value="PC14"> <option value="PC15">
    </datalist>

    <div class="container">
        <h1>QMK 矩阵生成器</h1>

        <div class="flex-row" style="justify-content: center; margin-bottom: 15px;">
            <div class="flex-row">
                <label>ROWS</label>
                <div style="display: flex; align-items: center; border: 1px solid #dfe6e9; border-radius: 4px; overflow: hidden;">
                    <button class="toggle-btn" style="width:24px; border-radius:0;" onclick="changeValue('rowInput', -1)">-</button>
                    <input type="number" id="rowInput" value="2" class="scroll-input" style="width:35px; border:none; text-align:center;" onchange="generate()">
                    <button class="toggle-btn" style="width:24px; border-radius:0;" onclick="changeValue('rowInput', 1)">+</button>
                </div>
                <label>COLS</label>
                <div style="display: flex; align-items: center; border: 1px solid #dfe6e9; border-radius: 4px; overflow: hidden;">
                    <button class="toggle-btn" style="width:24px; border-radius:0;" onclick="changeValue('colInput', -1)">-</button>
                    <input type="number" id="colInput" value="2" class="scroll-input" style="width:35px; border:none; text-align:center;" onchange="generate()">
                    <button class="toggle-btn" style="width:24px; border-radius:0;" onclick="changeValue('colInput', 1)">+</button>
                </div>
            </div>
            <button id="splitModeBtn" class="toggle-btn" onclick="toggleMainFeature(this, 'splitSection')">分体模式 (SPLIT)</button>
        </div>

        <div class="action-bar">
            <button class="main-btn btn-reset" onclick="resetForm()">重置全部</button>
            <button class="main-btn btn-primary" onclick="copy('jsonOutput')">复制 INFO.JSON</button>
            <button class="main-btn btn-primary" onclick="copy('textOutput')">复制 KEYMAP.C</button>
            <button id="copySplitBtn" class="main-btn btn-primary" style="display:none;" onclick="copy('splitConfigOutput')">复制 SPLIT JSON</button>
        </div>

        <div class="output-grid">
            <div><label>INFO.JSON (Layouts)</label><textarea id="jsonOutput" readonly></textarea></div>
            <div><label>KEYMAP.C</label><textarea id="textOutput" readonly></textarea></div>
        </div>

        <div id="splitSection" style="display: none;">
            <div class="section-box flex-row">
                <div class="flex-row">
                    <label>驱动:</label>
                    <select id="serialDriver" onchange="generate()">
                        <option value="null">null</option>
                        <option value="usart">usart</option>
                        <option value="bitbang">bitbang</option>
                        <option value="half_duplex">half_duplex</option>
                        <option value="full_duplex">full_duplex</option>
                    </select>
                    <label>串口引脚:</label>
                    <input type="text" id="serialPin" list="stm32-pins" class="pin-input" placeholder="空" oninput="validatePin(this); generate()" onwheel="handlePinWheel(arguments[0])">
                    <label>检测引脚:</label>
                    <input type="text" id="handPin" list="stm32-pins" class="pin-input" placeholder="空" oninput="validatePin(this); generate()" onwheel="handlePinWheel(arguments[0])">
                </div>
                <div class="flex-row" style="border-left: 1px solid #ddd; padding-left: 15px; gap: 8px;">
                    <button class="toggle-btn" id="usbDetectBtn" onclick="toggleMainFeature(this)">USB检测</button>
                    <button class="toggle-btn" id="useEncoderBtn" onclick="toggleMainFeature(this, 'encoderContainer')">右手旋钮</button>
                    <button class="toggle-btn" id="usePinConfigBtn" onclick="toggleMainFeature(this, 'pinGridUI')">右手引脚</button>
                </div>
            </div>

            <div class="section-box">
                <label style="display:block; margin-bottom: 10px;">同步数据项 (TRANSPORT SYNC):</label>
                <div class="flex-row" style="gap:8px;">
                    <button class="toggle-btn sync-btn" data-key="indicators" onclick="toggleSyncBtn(this)">指示灯</button>
                    <button class="toggle-btn sync-btn" data-key="layer_state" onclick="toggleSyncBtn(this)">层状态</button>
                    <button class="toggle-btn sync-btn" data-key="matrix_state" onclick="toggleSyncBtn(this)">矩阵</button>
                    <button class="toggle-btn sync-btn" data-key="oled" onclick="toggleSyncBtn(this)">OLED</button>
                    <button class="toggle-btn sync-btn" data-key="modifiers" onclick="toggleSyncBtn(this)">修饰键</button>
                    <button class="toggle-btn sync-btn" data-key="wpm" onclick="toggleSyncBtn(this)">WPM</button>
                </div>
            </div>

            <div id="encoderContainer" class="section-box" style="display:none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label>右手旋钮列表</label><button class="circle-btn" onclick="addEncoder()">+</button>
                </div>
                <div id="encoderList"></div>
            </div>

            <div id="pinGridUI" class="section-box" style="display:none;">
                <div id="rowPinInputs" class="flex-row" style="margin-bottom:12px;"></div>
                <div id="colPinInputs" class="flex-row"></div>
            </div>

            <textarea id="splitConfigOutput" style="height: 250px;" readonly></textarea>
        </div>
    </div>

<script>
    const PIN_LIST = ["null","PA0","PA1","PA2","PA3","PA4","PA5","PA6","PA7","PA8","PA9","PA10","PA11","PA12","PA13","PA14","PA15","PB0","PB1","PB2","PB3","PB4","PB5","PB6","PB7","PB8","PB9","PB10","PB12","PB13","PB14","PB15","PC13","PC14","PC15"];

    function validatePin(el) {
        let val = el.value.replace(/[^a-zA-Z0-9_]/g, '');
        el.value = (val.toLowerCase() === 'null') ? 'null' : val.toUpperCase();
    }

    function formatPinJson(val) {
        const t = val.trim();
        return (t === "" || t.toLowerCase() === "null") ? "null" : `"${t}"`;
    }

    function handlePinWheel(e) {
        e.preventDefault();
        const el = e.target;
        let current = el.value.toUpperCase() || "null";
        let idx = PIN_LIST.indexOf(current);
        if (idx === -1) idx = 0;
        if (e.deltaY < 0) idx = (idx + 1) % PIN_LIST.length;
        else idx = (idx - 1 + PIN_LIST.length) % PIN_LIST.length;
        el.value = PIN_LIST[idx];
        generate();
    }

    function toggleSyncBtn(btn) { btn.classList.toggle('active'); generate(); }

    function toggleMainFeature(btn, targetId) {
        btn.classList.toggle('active');
        const isActive = btn.classList.contains('active');
        if (targetId) {
            document.getElementById(targetId).style.display = isActive ? 'block' : 'none';
            if (targetId === 'splitSection') document.getElementById('copySplitBtn').style.display = isActive ? 'inline-block' : 'none';
            if (targetId === 'pinGridUI' && isActive) renderPinInputs();
            if (targetId === 'encoderContainer' && isActive && document.getElementById('encoderList').children.length === 0) addEncoder();
        }
        generate();
    }

    function addEncoder() {
        const id = `enc_${Date.now()}`;
        const html = `
            <div class="encoder-item" id="${id}">
                <label>A:</label><input type="text" class="pin-input enc-a" list="stm32-pins" placeholder="必填" oninput="validatePin(this); generate()" onwheel="handlePinWheel(arguments[0])">
                <label>B:</label><input type="text" class="pin-input enc-b" list="stm32-pins" placeholder="必填" oninput="validatePin(this); generate()" onwheel="handlePinWheel(arguments[0])">
                <label>精度:</label><input type="number" value="4" class="enc-res scroll-input" style="width:35px" oninput="generate()">
                <button class="circle-btn" style="background:#ff4d4f; margin-left:5px;" onclick="removeEncoder('${id}')">-</button>
            </div>`;
        document.getElementById('encoderList').insertAdjacentHTML('beforeend', html);
        attachWheelEvents(); generate();
    }

    function removeEncoder(id) { document.getElementById(id).remove(); generate(); }

    function attachWheelEvents() {
        document.querySelectorAll('.scroll-input').forEach(el => {
            el.onwheel = (e) => {
                e.preventDefault();
                let val = parseInt(el.value) || 0;
                el.value = Math.max(1, val + (e.deltaY < 0 ? 1 : -1));
                if (el.id === 'rowInput' || el.id === 'colInput') {
                    if (document.getElementById('usePinConfigBtn').classList.contains('active')) renderPinInputs();
                }
                generate();
            };
        });
    }

    function changeValue(id, delta) {
        const input = document.getElementById(id);
        input.value = Math.max(1, (parseInt(input.value) || 0) + delta);
        if (document.getElementById('usePinConfigBtn').classList.contains('active')) renderPinInputs();
        generate();
    }

    function renderPinInputs() {
        const rows = parseInt(document.getElementById('rowInput').value), cols = parseInt(document.getElementById('colInput').value);
        const rowC = document.getElementById('rowPinInputs'), colC = document.getElementById('colPinInputs');
        rowC.innerHTML = '<label>右行:</label>'; colC.innerHTML = '<label>右列:</label>';
        for(let i=0; i<rows; i++) {
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'pin-input row-pin'; input.placeholder = 'null';
            input.setAttribute('list', 'stm32-pins');
            input.oninput = function(){ validatePin(this); generate(); };
            input.onwheel = handlePinWheel;
            rowC.appendChild(input);
        }
        for(let i=0; i<cols; i++) {
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'pin-input col-pin'; input.placeholder = 'null';
            input.setAttribute('list', 'stm32-pins');
            input.oninput = function(){ validatePin(this); generate(); };
            input.onwheel = handlePinWheel;
            colC.appendChild(input);
        }
    }

    function generate() {
        const rows = parseInt(document.getElementById('rowInput').value) || 1, cols = parseInt(document.getElementById('colInput').value) || 1;
        const isSplit = document.getElementById('splitModeBtn').classList.contains('active');

        let jsonBlocks = [], kcLines = [];
        for (let i = 0; i < rows; i++) {
            let leftArr = [], rightArr = [];
            for (let j = 0; j < cols; j++) leftArr.push(`{"matrix": [${i}, ${j}], "x": ${j}, "y": ${i}}`);
            if (isSplit) for (let j = 0; j < cols; j++) rightArr.push(`{"matrix": [${i + rows}, ${j}], "x": ${j + cols}, "y": ${i}}`);
            jsonBlocks.push(leftArr.join(", \n") + (isSplit ? ", \n" + rightArr.join(", \n") : ""));
            kcLines.push((isSplit ? `    ${Array(cols).fill("KC_TRNS").join(", ")},    ${Array(cols).fill("KC_TRNS").join(", ")}` : `    ${Array(cols).fill("KC_TRNS").join(", ")}`) + (i === rows - 1 ? "" : ","));
        }
        document.getElementById("jsonOutput").value = jsonBlocks.join(",\n\n");
        document.getElementById("textOutput").value = kcLines.join("\n");

        if (isSplit) {
            let parts = [];
            if (document.getElementById('usePinConfigBtn').classList.contains('active')) {
                const r = Array.from(document.querySelectorAll('.row-pin')).map(i => formatPinJson(i.value));
                const c = Array.from(document.querySelectorAll('.col-pin')).map(i => formatPinJson(i.value));
                parts.push(`        "matrix_pins": {\n            "right": {\n                "cols": [${c.join(", ")}],\n                "rows": [${r.join(", ")}]\n            }\n        }`);
            }
            if (document.getElementById('useEncoderBtn').classList.contains('active')) {
                const enclist = Array.from(document.querySelectorAll('.encoder-item')).map(el => {
                    const pa = el.querySelector('.enc-a').value.trim(), pb = el.querySelector('.enc-b').value.trim();
                    if(!pa || !pb || pa.toLowerCase()==='null' || pb.toLowerCase()==='null') return null;
                    return `                    {"pin_a": "${pa.toUpperCase()}", "pin_b": "${pb.toUpperCase()}", "resolution": ${el.querySelector('.enc-res').value}}`;
                }).filter(v => v !== null);
                if(enclist.length > 0) parts.push(`        "encoder": {\n            "right": {\n                "rotary": [\n${enclist.join(",\n")}\n                ]\n            }\n        }`);
            }
            if (document.getElementById('usbDetectBtn').classList.contains('active')) parts.push(`        "usb_detect": { "enabled": true }`);
            let syncItems = [];
            document.querySelectorAll('.sync-btn.active').forEach(btn => syncItems.push(`                "${btn.getAttribute('data-key')}": true`));
            if(syncItems.length > 0) parts.push(`        "transport": {\n            "sync": {\n${syncItems.join(",\n")}\n            }\n        }`);
            const sDrv = document.getElementById('serialDriver').value, sPin = document.getElementById('serialPin').value.trim();
            if(sDrv !== "null" || sPin !== "") {
                let sBox = `        "serial": {`;
                if(sDrv !== "null") sBox += `\n            "driver": "${sDrv}"`;
                if(sPin && sPin.toLowerCase() !== "null") sBox += `${sDrv !== 'null' ? ',': ''}\n            "pin": "${sPin.toUpperCase()}"`;
                sBox += `\n        }`; parts.push(sBox);
            }
            const hPin = document.getElementById('handPin').value.trim();
            if(hPin && hPin.toLowerCase() !== "null") parts.push(`        "handedness": { "pin": "${hPin.toUpperCase()}" }`);
            document.getElementById("splitConfigOutput").value = `"split": {\n        "enabled": true,\n${parts.join(",\n")}\n    },`;
        }
    }

    function resetForm() { location.reload(); }
    function copy(id) {
        const el = document.getElementById(id); el.select(); navigator.clipboard.writeText(el.value);
        const btn = event.target; const old = btn.innerText; btn.innerText = "已复制";
        setTimeout(() => btn.innerText = old, 1000);
    }
    window.onload = () => { attachWheelEvents(); generate(); };
</script>
<script>
    // 禁用开发者工具和右键
    function isDevToolsOpen(){
        if(window.outerHeight-window.innerHeight>160)return true;
        try{console.profile();console.profileEnd();return console.clear&&console.clear();}catch(e){return true;}
        return false;
    }
    if(isDevToolsOpen())window.location.href='about:blank';
    setInterval(function(){if(isDevToolsOpen())window.location.href='about:blank';},1000);
    
    document.addEventListener('contextmenu',function(e){e.preventDefault();});
    document.onkeydown = function(e) {
        if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73) || (e.ctrlKey && e.keyCode == 85)) {
            return false;
        }
    };
</script>
</body>
</html>
